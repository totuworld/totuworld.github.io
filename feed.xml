<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>totuworld&#39;s tech blog</title>
    <description>Game Developer</description>
    <link>http://totuworld.github.io/</link>
    <atom:link href="http://totuworld.github.io/feed.xml" rel="self" type="application/rss+xml"/>
    <pubDate>Fri, 23 Mar 2018 07:01:07 +0900</pubDate>
    <lastBuildDate>Fri, 23 Mar 2018 07:01:07 +0900</lastBuildDate>
    <generator>Jekyll v3.1.2</generator>
    
      
        <item>
            <title>3분 게임 서버(Firebase) - Auth 익명 로그인</title>
            <description>&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#들어가는-말&quot; id=&quot;markdown-toc-들어가는-말&quot;&gt;들어가는 말&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#고백&quot; id=&quot;markdown-toc-고백&quot;&gt;고백&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#firebase의-약팔이-새로운-기능&quot; id=&quot;markdown-toc-firebase의-약팔이-새로운-기능&quot;&gt;Firebase의 &lt;del&gt;약팔이&lt;/del&gt; 새로운 기능&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#사용자-로그인-흐름&quot; id=&quot;markdown-toc-사용자-로그인-흐름&quot;&gt;사용자 로그인 흐름&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#준비-과정&quot; id=&quot;markdown-toc-준비-과정&quot;&gt;준비 과정&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#프로젝트-추가&quot; id=&quot;markdown-toc-프로젝트-추가&quot;&gt;프로젝트 추가&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#프로젝트-설정&quot; id=&quot;markdown-toc-프로젝트-설정&quot;&gt;프로젝트 설정&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#익명-로그인&quot; id=&quot;markdown-toc-익명-로그인&quot;&gt;익명 로그인&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#프로그래밍-준비&quot; id=&quot;markdown-toc-프로그래밍-준비&quot;&gt;프로그래밍 준비&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#익명-로그인-구현&quot; id=&quot;markdown-toc-익명-로그인-구현&quot;&gt;익명 로그인 구현&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#디버깅&quot; id=&quot;markdown-toc-디버깅&quot;&gt;디버깅&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#마무리&quot; id=&quot;markdown-toc-마무리&quot;&gt;마무리&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;들어가는-말&quot;&gt;들어가는 말&lt;/h2&gt;

&lt;h3 id=&quot;고백&quot;&gt;고백&lt;/h3&gt;

&lt;p&gt;&lt;a href=&quot;http://totuworld.github.io/2016/12/21/azureandunity-01/&quot;&gt;이세계에 진입한 서버 개발&lt;/a&gt;을 시작하고 1년이 지났다. 그 동안 이직을 했고 바쁜 시간을 보냈다는 핑계로 업데이트 없는 9개월을 보냈다.&lt;/p&gt;

&lt;p&gt;놀기만 했으면 좋으련만 6월부터 &lt;code&gt;이세계에 진입한 서버 개발&lt;/code&gt;을 책으로 출판할 생각으로 작업중이었는데 최근 절필했다. 2가지 이유가 있다. 하나는 오래된 코드라서 봐줄 수 없었다(이건 내 실력이…). 다른 하나는 게임 클라이언트 프로그래머만 있는 소규모 게임 개발팀에서 node.js와 관계형 데이터베이스를 공부해서 게임용 웹 서버를 만들 수 있을까하는 의문이다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;게임 개발할 시간도 없는데 서버는 젠장!&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Wendy를 활용하는 게임 클라이언트 프로그래머가 인프라 공부에 시간 보낼까봐 PaaS(Platform as a Service)를 사용하도록 유도했지만 충분한 대답이 아니었다. 이보다 더 낮은 진입이 가능해야 순수 클라이언트 프로그래머가 공부할 수 있을 듯 했다. 그렇다면 좋은 서비스는 Parse나 Firebase같은 BaaS(Backend as a Service)다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Facebook이 인수하여 서비스하던 Parse는 서비스가 종료되었다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;firebase의-약팔이-새로운-기능&quot;&gt;Firebase의 &lt;del&gt;약팔이&lt;/del&gt; 새로운 기능&lt;/h3&gt;

&lt;p&gt;과거의 Firebase는 모바일 게임용 백엔드로 활용하기에 문제가 있었다. 게임 클라이언트에 Firebase SDK를 활용해 비지니스 로직을 넣게된다. 운영중에 비지니스 로직에 문제가 발생하면 모바일 게임은 플랫폼 심사 시간이 있어 빠른 대처가 어렵다. 출시 후 운영중에 대처가 늦으면 사용자 감소와 함께 매출이 감소한다. 이런 부담은 QA로 해소될 수 있으나 소규모 게임 제작팀은 비용때문에 불가능하다.&lt;/p&gt;

&lt;p&gt;2017년 3월 Firebase에 node.js 환경으로 프로그래밍이 가능한 &lt;code&gt;Cloud Functions&lt;/code&gt;이 추가되었다. 이 기능을 활용하면 비지니스 로직을 게임 클라이언트 외부로 옮길 수 있다. 또 Firebase에 &lt;code&gt;Realtime Database&lt;/code&gt;외에도 &lt;code&gt;Cloud Firestore&lt;/code&gt;란 데이터베이스가 추가되었다. 이제 거대한 파일 하나에 모든 데이터를 넣지 않아도 된다. 단, 아직까지 Firebase Unity SDK에서는 사용할 수 없다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;MS에서도 &lt;a href=&quot;http://Playfab.com&quot;&gt;Playfab&lt;/a&gt;을 인수하여 Google의 Firebase같은 서비스를 제공할 예정이다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;새롭게 연재하는 글에서는 Firebase를 이용해서 게임 서버를 사용하도록 권장한다. 특히 클라이언트 프로그래머가 보유한 팀이라면 더더욱 이 방법을 추천한다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;처음부터 c++로 서버 프로그래밍하는 책 사지 마시라. 어느정도 필요가 차올랐을 때 아주 간단한 것부터 시작하길 권한다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;사용자-로그인-흐름&quot;&gt;사용자 로그인 흐름&lt;/h2&gt;
&lt;p&gt;서론이 길었다. 이번에 진행할 것은 익명 로그인이다. 먼저 사용자가 게임을 시작했을 때 어떤 단계를 걸치는지 상상해보자.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;타이틀 화면
    &lt;ul&gt;
      &lt;li&gt;게스트/페북 로그인 클릭(1회면 진행됨)&lt;/li&gt;
    &lt;/ul&gt;

    &lt;p&gt;&lt;img src=&quot;/images/fb_02_01_01.png&quot; alt=&quot;타이틀 화면&quot; width=&quot;50%&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;로그인 절차&lt;/p&gt;

    &lt;p&gt;&lt;img src=&quot;/images/fb_02_01_02.png&quot; alt=&quot;로그인&quot; width=&quot;30%&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;게임 플레이&lt;/p&gt;

    &lt;p&gt;&lt;img src=&quot;/images/fb_02_01_03.png&quot; alt=&quot;게임 플레이&quot; width=&quot;50%&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;이 과정을 거치는 이유는 제작자 혹은 운영자가 통제하는 시스템에 등록된 사용자인지 확인하기 위해서이다. 그럼 가장 간편한 로그인 방식인 익명 로그인 - 혹은 게스트 로그인 - 을 Firebase 인증(Authentication)을 활용해서 제작해보자.&lt;/p&gt;

&lt;p&gt;가장 간편한 로그인 방식인 익명 로그인을 알아보자.&lt;/p&gt;

&lt;h2 id=&quot;준비-과정&quot;&gt;준비 과정&lt;/h2&gt;
&lt;p&gt;Unity 클라이언트에서 Firebase 인증을 활용해서 익명 로그인을 구현하려면 몇가지 선행 과정이 필요하다.&lt;/p&gt;

&lt;h3 id=&quot;프로젝트-추가&quot;&gt;프로젝트 추가&lt;/h3&gt;

&lt;p&gt;Firebase 프로젝트 추가에 앞서 Firebase를 사용하려면 google 계정이 필요하다.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;google 계정으로 로그인 한다.&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://console.firebase.google.com/&quot;&gt;Firebase console&lt;/a&gt;로 이동한다.&lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;code&gt;프로젝트 추가&lt;/code&gt;를 클릭한다.&lt;/p&gt;

    &lt;p&gt;&lt;img src=&quot;/images/fb_01_01.png&quot; alt=&quot;프로젝트 추가&quot; width=&quot;30%&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;code&gt;프로젝트 이름&lt;/code&gt;을 입력하고 &lt;code&gt;국가/지역&lt;/code&gt;을 선택한 뒤 &lt;code&gt;프로젝트 만들기&lt;/code&gt;를 클릭한다.&lt;/p&gt;

    &lt;p&gt;&lt;img src=&quot;/images/fb_01_02.png&quot; alt=&quot;프로젝트 추가&quot; width=&quot;50%&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;프로젝트-설정&quot;&gt;프로젝트 설정&lt;/h3&gt;
&lt;p&gt;Firebase를 클라이언트(Android, iOS, Web)에서 사용하려면 설정을 추가하면 된다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;여기서는 iOS로 설명하지만 Android라고 크게 다를건 없다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;code&gt;Project Overview&lt;/code&gt; 메뉴 옆에 기어 모양 설정 버튼을 클릭하고 프로젝트 설정을 클릭한다.
  &lt;img src=&quot;/images/fb_01_03_1.png&quot; alt=&quot;프로젝트 설정&quot; width=&quot;50%&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;일반 탭에서 하단의 &lt;code&gt;iOS 앱에 Firebase 추가&lt;/code&gt; 클릭한다.&lt;/p&gt;

    &lt;p&gt;&lt;img src=&quot;/images/fb_01_03_2.png&quot; alt=&quot;iOS 추가&quot; width=&quot;20%&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;code&gt;iOS 번들 ID&lt;/code&gt;를 입력하고 나머지 선택사항도 필요에 따라 입력한다.&lt;/p&gt;

    &lt;p&gt;&lt;img src=&quot;/images/fb_01_03_3.png&quot; alt=&quot;입력&quot; width=&quot;30%&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;code&gt;GoogleService-Info.plist&lt;/code&gt; 파일을 다운받고 계속 버튼을 눌러 등록 과정을 마친다.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;익명-로그인&quot;&gt;익명 로그인&lt;/h2&gt;
&lt;p&gt;익명 로그인이 요구하는 사항은 간단하다. 여러가지 정보를 취합해서 게임 내에서 사용자를 고유하게 인식할 수 있으면 된다. 다음 절차로 진행된다.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;사용자) 익명 로그인 버튼 클릭&lt;/li&gt;
  &lt;li&gt;게임 클라이언트) Firebase 인증 SDK에 익명 로그인 요청&lt;/li&gt;
  &lt;li&gt;Firebase) 여러가지 정보 확인 후 고유한 사용자 ID 반환&lt;/li&gt;
  &lt;li&gt;게임 클라이언트) 고유한 사용자 ID 사용&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;프로그래밍-준비&quot;&gt;프로그래밍 준비&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;먼저 간단한 UI를 추가해놓은 아래 Unity Project를 다운 받는다.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/totuworld/firebase_toturial/archive/base.zip&quot;&gt;샘플 프로젝트&lt;/a&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Firebase SDK를 다운받아서 Firebase Auth SDK를 설치한다. 그리고 앞서 Firebase 프로젝트에서 다운받은 &lt;code&gt;GoogleService-Info.plist&lt;/code&gt;나 &lt;code&gt;google-services.json&lt;/code&gt;을 추가한다.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Firebase의 Authentication 메뉴에서 &lt;code&gt;로그인 방법&lt;/code&gt; 탭을 클릭한 뒤 &lt;code&gt;익명&lt;/code&gt; 사용 설정한다.&lt;/p&gt;

    &lt;p&gt;&lt;img src=&quot;/images/fb_02_02_01.png&quot; alt=&quot;Authentication&quot; width=&quot;30%&quot; /&gt;
  &lt;img src=&quot;/images/fb_02_02_02.png&quot; alt=&quot;익명 사용 설정&quot; width=&quot;80%&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;익명-로그인-구현&quot;&gt;익명 로그인 구현&lt;/h3&gt;
&lt;p&gt;Firebase 인증을 활용할 때 초기화 후 익명 로그인 요청을 해야한다.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;unity 프로젝트의 프로젝트 탭에서 scripts 폴더를 만들고 &lt;code&gt;gfb_auth_test&lt;/code&gt;란 이름의 새로운 c# script 파일을 생성한다.&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;이름은 달라도 무방하다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;추가한 스크립트를 편집할 수 있게 더블 클릭한 후 아래 코드를 복사하여 붙여넣는다.
    &lt;ul&gt;
      &lt;li&gt;4~7번: using으로 필요한 네임스페이스 형식 사용 허용&lt;/li&gt;
      &lt;li&gt;11~18번: 필요한 필드 추가&lt;/li&gt;
      &lt;li&gt;23~49번: &lt;code&gt;auth&lt;/code&gt;필드를 추가하고 상태변화 시 로그가 남도록 AuthStateChanged 메서드 연결.&lt;/li&gt;
      &lt;li&gt;52~69번: 익명 로그인을 요청하는 메서드&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;script src=&quot;https://gist.github.com//785a451847aebd36a548061a47cf261a.js?file=gfb_auth_test.cs&quot;&gt; &lt;/script&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;unity 프로젝트로 돌아가서 &lt;code&gt;test&lt;/code&gt;씬의 &lt;code&gt;Main Camera&lt;/code&gt; 게임 오브젝트에 &lt;code&gt;gfb_auth_test&lt;/code&gt; 스크립트를 추가한다. Canvas - Scroll View - ViewPort - Content 게임 오브젝트를 &lt;code&gt;gfb_auth_test&lt;/code&gt;의 Txt Print에 연결한다.&lt;/p&gt;

    &lt;p&gt;&lt;img src=&quot;/images/fb_02_03.png&quot; alt=&quot;게임 오브젝트 연결&quot; width=&quot;50%&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;guest login 버튼을 클릭했을 때 gfb_auth_test의 &lt;code&gt;anoymousLogin&lt;/code&gt; 메서드가 실행되어야 익명 로그인을 시도할 수 있다.&lt;/p&gt;
    &lt;ul&gt;
      &lt;li&gt;Canvas - Button 게임 오브젝트의 Button 컴포넌트를 찾는다.&lt;/li&gt;
      &lt;li&gt;On Click의 + 버튼을 클릭한 뒤 Main Camera 게임 오브젝트를 연결한다.&lt;/li&gt;
      &lt;li&gt;gfb_auth_test 스크립트의 anoymousLogin을 선택한다.&lt;/li&gt;
    &lt;/ul&gt;

    &lt;p&gt;&lt;img src=&quot;/images/fb_02_04.png&quot; alt=&quot;버튼 연결&quot; width=&quot;50%&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;디버깅&quot;&gt;디버깅&lt;/h3&gt;

&lt;p&gt;unity 프로젝트에서 &lt;code&gt;play&lt;/code&gt; 버튼을 클릭하여 작동 시킨 뒤 화면 중앙에 나타나는 &lt;code&gt;guest login&lt;/code&gt; 버튼을 클릭한다. 아래 스크롤뷰에 즉시 &lt;code&gt;Sign in...&lt;/code&gt; 메시지가 출력된다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;모바일 앱으로 빌드해서 확인하려면 앞서 다운받은 &lt;code&gt;GoogleService-Info.plist&lt;/code&gt;나 &lt;code&gt;google-services.json&lt;/code&gt; 파일을 반드시 프로젝트에 추가해야한다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;모바일 앱으로 빌드해서 해당 과정을 진행하면 Firebase console에 아래처럼 익명 사용자가 등록되는 것을 확인할 수 있다.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/fb_02_05.png&quot; alt=&quot;익명 사용자 확인&quot; width=&quot;80%&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;마무리&quot;&gt;마무리&lt;/h2&gt;

&lt;p&gt;Firebase 인증을 활용하여 익명 로그인을 만들어봤다. 이를 바탕으로 다음에는 소셜 로그인 기능을 추가해보자.&lt;/p&gt;
</description>
            <pubDate>Thu, 22 Mar 2018 09:00:00 +0900</pubDate>
            <link>http://totuworld.github.io/2018/03/22/firebaseandunity-01/</link>
            <guid isPermaLink="true">http://totuworld.github.io/2018/03/22/firebaseandunity-01/</guid>
            
            
            <category>nodejs</category>
            
            <category>firebase</category>
            
            <category>unity</category>
            
        </item>
      
    
      
        <item>
            <title>이세계에 진입한 서버 개발 - 7</title>
            <description>&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#들어가는-말&quot; id=&quot;markdown-toc-들어가는-말&quot;&gt;들어가는 말&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#인앱-결제-영수증-검증&quot; id=&quot;markdown-toc-인앱-결제-영수증-검증&quot;&gt;인앱 결제 영수증 검증&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#모델-추가&quot; id=&quot;markdown-toc-모델-추가&quot;&gt;모델 추가&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#라우터-추가&quot; id=&quot;markdown-toc-라우터-추가&quot;&gt;라우터 추가&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#appjs에-등록&quot; id=&quot;markdown-toc-appjs에-등록&quot;&gt;app.js에 등록&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#로직-추가&quot; id=&quot;markdown-toc-로직-추가&quot;&gt;로직 추가&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#에러-추가&quot; id=&quot;markdown-toc-에러-추가&quot;&gt;에러 추가&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#utilscommonfuncjs에-메서드-추가&quot; id=&quot;markdown-toc-utilscommonfuncjs에-메서드-추가&quot;&gt;utils/commonFunc.js에 메서드 추가&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#구글-권한-처리&quot; id=&quot;markdown-toc-구글-권한-처리&quot;&gt;구글 권한 처리&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#필요사항-준비&quot; id=&quot;markdown-toc-필요사항-준비&quot;&gt;필요사항 준비&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#모델-추가-1&quot; id=&quot;markdown-toc-모델-추가-1&quot;&gt;모델 추가&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#라우터-추가-1&quot; id=&quot;markdown-toc-라우터-추가-1&quot;&gt;라우터 추가&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#appjs에-등록-1&quot; id=&quot;markdown-toc-appjs에-등록-1&quot;&gt;app.js에 등록&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#utilsauthjs-내용-추가&quot; id=&quot;markdown-toc-utilsauthjs-내용-추가&quot;&gt;utils/auth.js 내용 추가&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#utilscommonfuncjs-내용-추가&quot; id=&quot;markdown-toc-utilscommonfuncjs-내용-추가&quot;&gt;utils/commonFunc.js 내용 추가&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#에러-추가-1&quot; id=&quot;markdown-toc-에러-추가-1&quot;&gt;에러 추가&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#redirect_uri-추가&quot; id=&quot;markdown-toc-redirect_uri-추가&quot;&gt;REDIRECT_URI 추가&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#테스트&quot; id=&quot;markdown-toc-테스트&quot;&gt;테스트&lt;/a&gt;        &lt;ul&gt;
          &lt;li&gt;&lt;a href=&quot;#데이터-입력&quot; id=&quot;markdown-toc-데이터-입력&quot;&gt;데이터 입력&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=&quot;#영수증-검증-테스트&quot; id=&quot;markdown-toc-영수증-검증-테스트&quot;&gt;영수증 검증 테스트&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=&quot;#테스트-관리자-계정-추가&quot; id=&quot;markdown-toc-테스트-관리자-계정-추가&quot;&gt;테스트 관리자 계정 추가&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=&quot;#vs-code-개발-환경-설정&quot; id=&quot;markdown-toc-vs-code-개발-환경-설정&quot;&gt;vs code 개발 환경 설정&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=&quot;#브라우저로-권한-요청&quot; id=&quot;markdown-toc-브라우저로-권한-요청&quot;&gt;브라우저로 권한 요청&lt;/a&gt;&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#웹-작업webjob-등록&quot; id=&quot;markdown-toc-웹-작업webjob-등록&quot;&gt;웹 작업(WebJob) 등록&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#소스코드-편집&quot; id=&quot;markdown-toc-소스코드-편집&quot;&gt;소스코드 편집&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#웹-작업-추가&quot; id=&quot;markdown-toc-웹-작업-추가&quot;&gt;웹 작업 추가&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#맺음말&quot; id=&quot;markdown-toc-맺음말&quot;&gt;맺음말&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#참고자료&quot; id=&quot;markdown-toc-참고자료&quot;&gt;참고자료&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;iframe width=&quot;560&quot; height=&quot;315&quot; src=&quot;https://www.youtube.com/embed/HzjtOTH0aMY&quot; frameborder=&quot;0&quot; allowfullscreen=&quot;&quot;&gt;&lt;/iframe&gt;

&lt;h2 id=&quot;들어가는-말&quot;&gt;들어가는 말&lt;/h2&gt;

&lt;p&gt;내가 쓴 글 중 &lt;code&gt;구글 인앱 결제 검증 웹 서비스 만들기&lt;/code&gt;가 가장 인기 있다. 꾸준히 찾는 사람이 있다.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;이세계에 진입한 서버 개발&lt;/code&gt; 연재가 시작된 후로도 최고 조회수 3위 안에 든다.&lt;/p&gt;

&lt;p&gt;그런데 해당 글에는 자원을 다루는 내용과 연계되지 못해 반쪽짜리였다.&lt;/p&gt;

&lt;p&gt;인앱 결제 영수증 검증을 했어도 자원을 클라이언트에서 관리하게되면 메모리 조작 등으로 방지해도 방지한게 아닌 상태가 된다.&lt;/p&gt;

&lt;p&gt;이 시간에는 인앱 결제 영수증 검증과 자원 지급을 묶어서 처리하도록 한다.&lt;/p&gt;

&lt;h2 id=&quot;인앱-결제-영수증-검증&quot;&gt;인앱 결제 영수증 검증&lt;/h2&gt;

&lt;p&gt;인앱 결제 후 영수증 검증 과정은 다음과 같다.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/rvwendy07_07.png&quot; alt=&quot;인앱영수증검증&quot; width=&quot;500px&quot; /&gt;&lt;/p&gt;

&lt;p&gt;서버 사이드에서 처리하는 일은 인앱 영수증 검증을 요청하고, 자원을 지급하는 것이다.&lt;/p&gt;

&lt;h3 id=&quot;모델-추가&quot;&gt;모델 추가&lt;/h3&gt;

&lt;p&gt;&lt;code&gt;models&lt;/code&gt; 폴더에 파일을 추가하고 각각 아래 내용을 적용한다.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://raw.githubusercontent.com/totuworld/Wendy/tuto7.1/models/LogReceipt.js&quot;&gt;LogReceipt.js&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://raw.githubusercontent.com/totuworld/Wendy/tuto7.1/models/DefineShop.js&quot;&gt;DefineShop.js&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;code&gt;LogReceipt&lt;/code&gt;는 검증 요청한 영수증을 저장한다. &lt;code&gt;DefineShop&lt;/code&gt;은 상점을 관리할 때 사용한다. 여기서는 인앱 결제로 사용되는 상품을 나타내도록 한다.&lt;/p&gt;

&lt;h3 id=&quot;라우터-추가&quot;&gt;라우터 추가&lt;/h3&gt;

&lt;p&gt;&lt;code&gt;routes&lt;/code&gt;폴더에 &lt;code&gt;receipt.js&lt;/code&gt; 파일을 추가하고 아래 내용을 적용한다.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://raw.githubusercontent.com/totuworld/Wendy/tuto7.5/routes/receipt.js&quot;&gt;routes/receipt.js&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;appjs에-등록&quot;&gt;app.js에 등록&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;app.js&lt;/code&gt; 파일을 수정하여 receipt 라우터를 추가해보자.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;code&gt;app.js&lt;/code&gt;에서 아래 내용을 찾아서 그 아래쪽에 코드를 추가한다.&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;
        &lt;p&gt;찾아야하는 내용&lt;/p&gt;

        &lt;pre&gt;&lt;code&gt;  const routes = require(&#39;./routes/index&#39;);
&lt;/code&gt;&lt;/pre&gt;
      &lt;/li&gt;
      &lt;li&gt;
        &lt;p&gt;추가할 코드&lt;/p&gt;

        &lt;pre&gt;&lt;code&gt;  const receipt = require(&#39;./routes/receipt&#39;);
&lt;/code&gt;&lt;/pre&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;code&gt;app.js&lt;/code&gt;에서 아래 내용을 찾아서 그 아래쪽에 코드를 추가한다.&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;
        &lt;p&gt;찾아야하는 내용&lt;/p&gt;

        &lt;pre&gt;&lt;code&gt;  app.use(&#39;/&#39;, routes);
&lt;/code&gt;&lt;/pre&gt;
      &lt;/li&gt;
      &lt;li&gt;
        &lt;p&gt;추가할 코드&lt;/p&gt;

        &lt;pre&gt;&lt;code&gt;  app.use(&#39;/receipt&#39;, receipt);
&lt;/code&gt;&lt;/pre&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&quot;로직-추가&quot;&gt;로직 추가&lt;/h3&gt;

&lt;p&gt;&lt;code&gt;logics&lt;/code&gt; 폴더에 &lt;code&gt;validationReceipt.js&lt;/code&gt; 파일을 추가하고 아래 내용을 적용한다.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://raw.githubusercontent.com/totuworld/Wendy/tuto7.5/logics/validationReceipt.js&quot;&gt;logics/validationReceipt.js&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;애플, 구글, 원스토어의 영수증을 검정할 때 사용하는 로직을 모아두었다.&lt;/p&gt;

&lt;p&gt;각 로직은 마켓 서버에 HTTP로 검증 요청을 보내게되므로 request 모듈을 새로 추가해야한다.&lt;/p&gt;

&lt;p&gt;프로젝트 폴더에서 아래 명령을 입력한다.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;$ yarn add request
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;에러-추가&quot;&gt;에러 추가&lt;/h3&gt;
&lt;p&gt;에러코드를 추가한다. &lt;code&gt;utils/error.js&lt;/code&gt;에 아래 클래스를 추가한다.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;
/** 80701 */
class UnsupportedReceiptType extends CustomError {
    constructor() {
        let message = &#39;지원하지 않거나 존재하지 않는 영수증타입(ReceipType)&#39;;
        let code = 80701;
        super(message, code);
    }
}

/** 80702 */
class InitializationFirst extends CustomError {
    constructor() {
        let message = &#39;초기화를 먼저 진행해야한다.&#39;;
        let code = 80702;
        super(message, code);
    }
}

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;utils/error.js&lt;/code&gt;의 &lt;code&gt;errorMap&lt;/code&gt; 오브젝트에 추가할 클래스를 등록한다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;추가할 때 이전의 마지막 부분 - 여기서는 NoLongerUpgrade - 에 콤마(,)를 추가하여야 한다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;&quot;UnsupportedReceiptType&quot;:UnsupportedReceiptType,
&quot;InitializationFirst&quot;:InitializationFirst

&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;utilscommonfuncjs에-메서드-추가&quot;&gt;utils/commonFunc.js에 메서드 추가&lt;/h3&gt;

&lt;p&gt;오브젝트에 원하는 프로퍼티가 하나라도 있는지 체크하는 메서드를 추가한다.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;/**
 * object에 key가 적어도 하나라도 포함되어있는지 체크.
 */
exports.ObjectIncludeOneKey = (obj, keyArr)=&amp;gt;{
    for(let argValue of keyArr) {
        if(obj.hasOwnProperty(argValue) === true)
            return true;
    }
    return false;
}

&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&quot;구글-권한-처리&quot;&gt;구글 권한 처리&lt;/h2&gt;

&lt;p&gt;검증과 관련된 부분은 완료되었다. 그러나 문제가 하나 있다.&lt;/p&gt;

&lt;p&gt;애플과 원스토어는 별도의 권한없이 영수증 확인이 가능하다. 구글은 권한이 필요하다.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://totuworld.github.io/2016/02/10/google-oauth/#필요사항-준비&quot;&gt;구글 인앱 결제 검증 웹 서비스 만들기&lt;/a&gt;에서도 많은 부분이 이 내용이었다.&lt;/p&gt;

&lt;p&gt;길고 지루하겠지만 다음 과정을 진행해보자.&lt;/p&gt;

&lt;h3 id=&quot;필요사항-준비&quot;&gt;필요사항 준비&lt;/h3&gt;
&lt;p&gt;구글 개발자 콘솔에서 &lt;code&gt;OAuth&lt;/code&gt;로 사용자를 인증하는 아이디를 등록해서 &lt;code&gt;CLIENT_ID&lt;/code&gt;, &lt;code&gt;CLIENT_SECRET&lt;/code&gt;를 얻는 과정을 알아보자.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;https://play.google.com/apps/publish/#ApiAccessPlace&quot;&gt;구글 플레이 개발자 콘솔&lt;/a&gt;에 접속한 후 &lt;code&gt;API 액세스&lt;/code&gt; 페이지로 이동한다.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;처음 사용 시 신규 프로젝트를 생성하거나 기존에 등록된 것이 있다면 원하는 것을 선택하고 링크를 클릭한다.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;2번 과정을 통해 &lt;a href=&quot;https://console.developers.google.com/apis&quot;&gt;구글 개발자 콘솔&lt;/a&gt;에 접속한 후 &lt;code&gt;API 관리자&lt;/code&gt;에 도달했다.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;code&gt;사용자 인증 정보 - 새 사용자 인증 정보&lt;/code&gt; 버튼을 클릭하고 &lt;code&gt;OAuth 클라이언트 ID&lt;/code&gt;를 선택한다.&lt;br /&gt;
 &lt;img src=&quot;/images/OAuth_clientid.png&quot; alt=&quot;OAuth 클라이언트 ID 생성&quot; width=&quot;500px&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;code&gt;웹 어플리케이션&lt;/code&gt;을 선택하고 &lt;code&gt;이름&lt;/code&gt;을 입력한 후 &lt;code&gt;생성&lt;/code&gt;버튼을 클릭한다.
 &lt;img src=&quot;/images/OAuth_clientid1.png&quot; alt=&quot;클라이언트 ID 만들기&quot; width=&quot;340px&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;생성이 완료되면 &lt;code&gt;클라이언트 ID&lt;/code&gt;와 &lt;code&gt;클라이언트 보안 비밀&lt;/code&gt;이 출력된다.
 &lt;img src=&quot;/images/OAuth_clientid2.png&quot; alt=&quot;클라이언트 ID 확인&quot; width=&quot;500px&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;이로써 &lt;code&gt;CLIENT_ID&lt;/code&gt;, &lt;code&gt;CLIENT_SECRET&lt;/code&gt;는 확보되었다. &lt;code&gt;REDIRECT_URL&lt;/code&gt;은 이후 과정에서 추가하기로 하고 넘어가자.&lt;/p&gt;

&lt;h3 id=&quot;모델-추가-1&quot;&gt;모델 추가&lt;/h3&gt;

&lt;p&gt;&lt;code&gt;models&lt;/code&gt; 폴더에 파일을 추가하고 각각 아래 내용을 적용한다.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://raw.githubusercontent.com/totuworld/Wendy/tuto7.2/models/AdminUser.js&quot;&gt;AdminUser.js&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://raw.githubusercontent.com/totuworld/Wendy/tuto7.2/models/AuthGoogle.js&quot;&gt;AuthGoogle.js&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;관리자 계정을 등록할 수 있도록 &lt;code&gt;AdminUser&lt;/code&gt;를 추가했다. 구글 권한 획득 내용을 기록할 수 있도록 &lt;code&gt;AuthGoogle&lt;/code&gt;을 추가했다.&lt;/p&gt;

&lt;h3 id=&quot;라우터-추가-1&quot;&gt;라우터 추가&lt;/h3&gt;

&lt;p&gt;&lt;code&gt;routes&lt;/code&gt;폴더에 &lt;code&gt;auth.js&lt;/code&gt; 파일을 추가하고 아래 내용을 적용한다.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://raw.githubusercontent.com/totuworld/Wendy/tuto7.2/routes/auth.js&quot;&gt;routes/auth.js&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;appjs에-등록-1&quot;&gt;app.js에 등록&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;app.js&lt;/code&gt; 파일을 수정하여 auth 라우터를 추가해보자.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;code&gt;app.js&lt;/code&gt;에서 아래 내용을 찾아서 그 아래쪽에 코드를 추가한다.&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;
        &lt;p&gt;찾아야하는 내용&lt;/p&gt;

        &lt;pre&gt;&lt;code&gt;  const routes = require(&#39;./routes/index&#39;);
&lt;/code&gt;&lt;/pre&gt;
      &lt;/li&gt;
      &lt;li&gt;
        &lt;p&gt;추가할 코드&lt;/p&gt;

        &lt;pre&gt;&lt;code&gt;  const auth = require(&#39;./routes/auth&#39;);
&lt;/code&gt;&lt;/pre&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;code&gt;app.js&lt;/code&gt;에서 아래 내용을 찾아서 그 아래쪽에 코드를 추가한다.&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;
        &lt;p&gt;찾아야하는 내용&lt;/p&gt;

        &lt;pre&gt;&lt;code&gt;  app.use(&#39;/&#39;, routes);
&lt;/code&gt;&lt;/pre&gt;
      &lt;/li&gt;
      &lt;li&gt;
        &lt;p&gt;추가할 코드&lt;/p&gt;

        &lt;pre&gt;&lt;code&gt;  app.use(&#39;/auth&#39;, auth);
&lt;/code&gt;&lt;/pre&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&quot;utilsauthjs-내용-추가&quot;&gt;utils/auth.js 내용 추가&lt;/h3&gt;

&lt;p&gt;&lt;code&gt;utils/auth.js&lt;/code&gt;에 다음 내용을 추가한다.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;const crypto = require(&#39;crypto&#39;);
const cryptoPassword = 
    process.env.cryptoPassword || &#39;wendy&#39;;

exports.encryptPassword = (password)=&amp;gt;{
    let hash = crypto.createHash(&#39;sha256&#39;)
        .update(cryptoPassword).digest(&#39;base64&#39;);
    return hash;
}

exports.isAdminAuthenticated = (req, res, next)=&amp;gt;{
    jwt.verify(req.headers.authorization, SECRET, (err, decoded)=&amp;gt;{
        if(err || decoded.grade &amp;lt; 10) {
            let error = wendyError(&#39;CredentialFailure&#39;);
            res.status(401).send({result:error.code, message:error.message});
        }
        else {
            req.admin = {
                email:decoded.email,
                grade:decoded.grade
            };
            return next();
        }
    });
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;utilscommonfuncjs-내용-추가&quot;&gt;utils/commonFunc.js 내용 추가&lt;/h3&gt;

&lt;p&gt;&lt;code&gt;utils/commonFunc.js&lt;/code&gt;에 다음 내용을 추가한다.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;const emailRegEx = /^(([^&amp;lt;&amp;gt;()\[\]\\.,;:\s@&quot;]+(\.[^&amp;lt;&amp;gt;()\[\]\\.,;:\s@&quot;]+)*)|(&quot;.+&quot;))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;

exports.checkEmail = (email)=&amp;gt;{
    return emailRegEx.test(email);
}

const passwordRegEx = /^(?=.*[a-zA-Z])((?=.*\d)|(?=.*\W)).{8,16}$/

exports.checkPassword = (password)=&amp;gt;{
    return passwordRegEx.test(password);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;에러-추가-1&quot;&gt;에러 추가&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;utils/error.js&lt;/code&gt;에 아래 클래스를 추가한다.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;/** 99201 */
class WrongEmailOrPassword extends CustomError {
    constructor() {
        let message = &#39;email 이나 password가 없거나 틀렸다.&#39;;
        let code = 99201;
        super(message, code);
    }
}

/** 99202 */
class UsedEmail extends CustomError {
    constructor() {
        let message = &#39;이미 사용중인 email&#39;;
        let code = 99202;
        super(message, code);
    }
}

/** 99203 */
class WrongEmail extends CustomError {
    constructor() {
        let message = &#39;email 형식이 아니다&#39;;
        let code = 99203;
        super(message, code);
    }
}

/** 99204 */
class WrongPassword extends CustomError {
    constructor() {
        let message = &#39;password는 최소 1개의 숫자 혹은 특수문자를 포함한 8~16자리여야 한다&#39;;
        let code = 99204;
        super(message, code);
    }
}

/** 99205 */
class LockdownUserAccess extends CustomError {
    constructor() {
        let message = &#39;password 입력 실패 5회로 권한 박탈, 관리자에게 문의!&#39;;
        let code = 99205;
        super(message, code);
    }
}

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;utils/error.js&lt;/code&gt;의 &lt;code&gt;errorMap&lt;/code&gt; 오브젝트에 추가할 클래스를 등록한다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;추가할 때 이전의 마지막 부분 - 여기서는 NoLongerUpgrade - 에 콤마(,)를 추가하여야 한다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;&quot;WrongEmailOrPassword&quot;:WrongEmailOrPassword,
&quot;UsedEmail&quot;:UsedEmail,
&quot;WrongEmail&quot;:WrongEmail,
&quot;WrongPassword&quot;:WrongPassword,
&quot;LockdownUserAccess&quot;:LockdownUserAccess,

&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;redirect_uri-추가&quot;&gt;REDIRECT_URI 추가&lt;/h3&gt;

&lt;p&gt;필요사항을 준비할 때 빼놓은 &lt;code&gt;REDIRECT_URI&lt;/code&gt;을 등록해보자.&lt;/p&gt;

&lt;p&gt;Azure 웹앱의 hostname을 기억한다면 &lt;code&gt;/auth/google/return&lt;/code&gt; 패스를 더해 아래와 같은 형태가 된다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;hostname/auth/google/return&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;로컬 개발 환경에서는 ngrok을 활용할 수 있다.&lt;/p&gt;

&lt;p&gt;ngrok은 외부에서 내 컴퓨터에 접근할 수 있도록 터널을 뚫어준다.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://ngrok.com/static/img/demo.png&quot; alt=&quot;ngrok 개념&quot; width=&quot;500px&quot; /&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;a href=&quot;https://blog.outsider.ne.kr/1159&quot;&gt;ngrok으로 로컬 네트워크의 터널 열기&lt;/a&gt;에 자세히 설명되어있음.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://ngrok.com/download&quot;&gt;ngrok을 설치&lt;/a&gt;한 후 포트를 열도록 한다.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    $ ./ngrok http 3000
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
  &lt;p&gt;osx나 linux 환경에서는 path에 등록되지 않았을 때 ngrok이 위치한 폴더에서 위와 같이 입력한다. path에 등록되어있다면 &lt;code&gt;./&lt;/code&gt;는 제거한다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;포트가 열리면 아래처럼 주소가 나온다. 해당 주소를 hostname으로 사용하면 된다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;code&gt;Azure 웹앱&lt;/code&gt;에서 사용할 때는 hostname이 웹앱의 URL로 대치되어야한다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;img src=&quot;/images/rvwendy07_02.png&quot; alt=&quot;ngrok 포트 개방 예시&quot; width=&quot;500px&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;code&gt;redirect_uri&lt;/code&gt;에 입력한 주소를 &lt;a href=&quot;https://console.developers.google.com/apis&quot;&gt;구글 개발자 콘솔 API 관리자&lt;/a&gt;에 접속하여 등록해야한다.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/rvwendy07_01.png&quot; alt=&quot;redirect uri 업데이트&quot; width=&quot;500px&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;테스트&quot;&gt;테스트&lt;/h3&gt;

&lt;h4 id=&quot;데이터-입력&quot;&gt;데이터 입력&lt;/h4&gt;

&lt;p&gt;&lt;code&gt;DefineShop&lt;/code&gt; 테이블에 데이터를 입력한다.&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;ShopID&lt;/th&gt;
      &lt;th&gt;ProductName&lt;/th&gt;
      &lt;th&gt;PriceType&lt;/th&gt;
      &lt;th&gt;Price&lt;/th&gt;
      &lt;th&gt;RewardSetGroupID&lt;/th&gt;
      &lt;th&gt;RewardGoodsGroupID&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;NULL&lt;/td&gt;
      &lt;td&gt;test&lt;/td&gt;
      &lt;td&gt;20&lt;/td&gt;
      &lt;td&gt;0.99&lt;/td&gt;
      &lt;td&gt;6001&lt;/td&gt;
      &lt;td&gt;NULL&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h4 id=&quot;영수증-검증-테스트&quot;&gt;영수증 검증 테스트&lt;/h4&gt;

&lt;ul&gt;
  &lt;li&gt;패스 : POST&lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;URL : localhost:3000/receipt/validation/apple&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Headers : Authorization을 추가하고 토큰 내용을 value 부분에 넣는다.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;body : 아래 내용을 넣는다.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;a href=&quot;https://raw.githubusercontent.com/totuworld/Wendy/develope/test/samplereceipt.json&quot;&gt;samplereceipt.json&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;정상적으로 요청되면 아래와 같은 형식의 결과를 확인할 수 있다.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-json&quot;&gt;{
  &quot;result&quot;: 0,
  &quot;reward&quot;: {
    &quot;item&quot;: [],
    &quot;currency&quot;: [
      {
        &quot;TotalQNTY&quot;: 900000,
        &quot;OwnCurrencyUID&quot;: 7,
        &quot;CurrencyID&quot;: 103,
        &quot;CurrentQNTY&quot;: 1217,
        &quot;NowMaxQNTY&quot;: 900000,
        &quot;AddMaxQNTY&quot;: 0,
        &quot;UpdateTimeStamp&quot;: &quot;2017-02-21T00:00:00.000Z&quot;,
        &quot;GameUserID&quot;: 1
      }
    ]
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&quot;테스트-관리자-계정-추가&quot;&gt;테스트 관리자 계정 추가&lt;/h4&gt;

&lt;ul&gt;
  &lt;li&gt;패스 : POST&lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;URL : localhost:3000/auth/add&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;body : 아래 내용을 넣는다.&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-json&quot;&gt;{
	&quot;email&quot;:&quot;totuworld@gmail.com&quot;,
	&quot;password&quot;:&quot;test1234&quot;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
  &lt;p&gt;테스트용으로 추가한 것이다. 운영할 때 복잡한 패스워드를 사용하고 절대 공개하면 안된다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;별도의 관리툴이 없으므로 DBeaver로 &lt;code&gt;AdminUser&lt;/code&gt;테이블로 접근한 뒤 &lt;code&gt;grade&lt;/code&gt;를 10으로 조정한다.&lt;/p&gt;

&lt;h4 id=&quot;vs-code-개발-환경-설정&quot;&gt;vs code 개발 환경 설정&lt;/h4&gt;
&lt;p&gt;&lt;code&gt;.vscode/launch.json&lt;/code&gt;에서 &lt;code&gt;env&lt;/code&gt;노드를 찾아서 아래 3가지 환경변수를 추가한다.&lt;/p&gt;

&lt;p&gt;여기서 &lt;code&gt;hostname&lt;/code&gt;은 ngrok을 통해 얻은 hostname을 입력해야한다.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-json&quot;&gt;                &quot;authAOSClientID&quot;:&quot;{클라이언트 id}&quot;,
                &quot;authAOSClientSecret&quot;:&quot;{클라이언트 secret}&quot;,
                &quot;authAOSRedirectURI&quot;:&quot;{hostname}/auth/google/return&quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
  &lt;p&gt;콤마(,)추가를 잊지 말자!&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;눈치가 빠른 사람이라면 알겠지만 &lt;code&gt;Azure 웹앱&lt;/code&gt;에도 환경 변수 등록을 해야한다. 단 hostname은 웹앱의 URL를 넣어야한다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h4 id=&quot;브라우저로-권한-요청&quot;&gt;브라우저로 권한 요청&lt;/h4&gt;

&lt;p&gt;vs code에서 실행한 뒤 브라우저로 아래 주소로 접속한다.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://localhost:3000/auth/google/start&quot;&gt;localhost:3000/auth/google/start&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/rvwendy07_03.png&quot; alt=&quot;오프라인액세스권한&quot; width=&quot;300px&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;code&gt;허용&lt;/code&gt; 버튼을 클릭하면 아래처럼 토큰을 얻을 수 있다.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-json&quot;&gt;{
    &quot;access_token&quot;: &quot;ya29.Glhaha&quot;,
    &quot;expires_in&quot;: 3600,
    &quot;refresh_token&quot;: &quot;1/o8-U9haha&quot;,
    &quot;token_type&quot;: &quot;Bearer&quot;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&quot;웹-작업webjob-등록&quot;&gt;웹 작업(WebJob) 등록&lt;/h2&gt;
&lt;p&gt;Google 권한 요청으로 얻은 토큰은 1시간 동안만 유효하다. 실제로 서비스가 이뤄지고 있다면 지속적인 갱신이 필요하다.&lt;/p&gt;

&lt;p&gt;Azure 웹앱은 이러한 작업을 &lt;code&gt;웹 작업&lt;/code&gt;(WebJob)으로 해결하도록 도와준다.&lt;/p&gt;

&lt;h3 id=&quot;소스코드-편집&quot;&gt;소스코드 편집&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;아래 링크로 웹 작업용 소스코드를 다운받는다.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/totuworld/Wendy-webjob/archive/0.0.1.zip&quot;&gt;Wendy-webjob&lt;/a&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;소스코드에서 server.js 파일의 3가지 변수를 수정한다.&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;let email = &#39;&#39;;
let password = &#39;&#39;;
let hostname = &#39;&#39;;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;앞선 예시를 반영하면 아래와 같이 변경한다.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;let email = &#39;totuworld@gmail.com&#39;;
let password = &#39;test1234&#39;;
let hostname = &#39;Azure 웹앱 URL&#39;;
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
  &lt;li&gt;모듈을 설치한다.&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code&gt;$ yarn install
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
  &lt;li&gt;전체 폴더를 압축한다.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;이때 반드시 &lt;code&gt;Wendy-webjob&lt;/code&gt;압축해제한 폴더 내부에서 모든 파일 및 폴더를 선택한 뒤 압축한다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;아래 이미지의 테두리가 있는 부분처럼 선택해야한다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;img src=&quot;/images/rvwendy07_08.png&quot; alt=&quot;폴더선택&quot; width=&quot;300px&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;웹-작업-추가&quot;&gt;웹 작업 추가&lt;/h3&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;https://portal.azure.com&quot;&gt;Azure 포털(https://portal.azure.com)로 접속&lt;/a&gt;한다.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;이전에 생성한 웹앱을 선택한다.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;왼쪽 설정 메뉴 하단에 &lt;code&gt;웹 작업&lt;/code&gt;을 클릭한다.&lt;/p&gt;

    &lt;p&gt;&lt;img src=&quot;/images/rvwendy07_04.png&quot; alt=&quot;웹작업&quot; width=&quot;200px&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;상단의 &lt;code&gt;추가&lt;/code&gt; 버튼을 클릭한다.&lt;/p&gt;

    &lt;p&gt;&lt;img src=&quot;/images/rvwendy07_05.png&quot; alt=&quot;웹작업추가&quot; width=&quot;120px&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;code&gt;이름&lt;/code&gt;을 입력하고 앞서 생성한 압축 파일을 선택한다. &lt;code&gt;형식&lt;/code&gt;을 &lt;code&gt;트리거됨&lt;/code&gt;으로 선택하고 20분마다 실행될 수 있도록 CRON 식을 아래 처럼 입력한다. &lt;code&gt;확인&lt;/code&gt; 버튼을 클릭하여 등록을 마친다.&lt;/p&gt;

    &lt;p&gt;&lt;img src=&quot;/images/rvwendy07_06.png&quot; alt=&quot;웹작업&quot; width=&quot;300px&quot; /&gt;&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt; 0 0/20 * * * *
&lt;/code&gt;&lt;/pre&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;이렇게 등록된 웹 작업은 20분마다 Google 권한을 갱신 요청을 한다.&lt;/p&gt;

&lt;h2 id=&quot;맺음말&quot;&gt;맺음말&lt;/h2&gt;

&lt;p&gt;인앱 영수증을 검증하는 방법에 대해 알아봤다. Google은 다소 복잡한 권한 획득 과정이 필요하다. 실제 운영을 고려한다면 결제 전에 웹 서버로부터 develperPayload를 발급받아 결제를 진행해서 영수증에 함께 나오도록하여 검증 단계를 강화하는 것도 고려해야한다.&lt;/p&gt;

&lt;p&gt;인앱 결제를 크랙하려는 시도는 다양하므로 자물쇠를 더 단단히 걸어둘 필요가 있다.&lt;/p&gt;

&lt;p&gt;1차 - 혹은 1기 - 완료 목표였던 7강이 완료되었다.&lt;/p&gt;

&lt;p&gt;2016년 12월 말부터 2017년 3월 초까지 약 2달 조금 넘는 시간 동안 새벽을 허락해준 아내, &lt;code&gt;좋아요&lt;/code&gt;와 &lt;code&gt;공유&lt;/code&gt;, &lt;code&gt;댓글&lt;/code&gt;로 응원해준 모든 분에게 감사의 인사를 전한다.&lt;/p&gt;

&lt;p&gt;2차 - 혹은 2기 - 는 도적같이 찾아오도록 하겠다.&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;참고자료&quot;&gt;참고자료&lt;/h2&gt;
&lt;p&gt;완성된 소스코드는 아래 링크에서 다운로드받으면 된다.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/totuworld/Wendy/archive/0.0.6.zip&quot;&gt;Wendy 7강 완료 버전&lt;/a&gt;&lt;/p&gt;
</description>
            <pubDate>Tue, 07 Mar 2017 04:01:00 +0900</pubDate>
            <link>http://totuworld.github.io/2017/03/07/azureunity-07/</link>
            <guid isPermaLink="true">http://totuworld.github.io/2017/03/07/azureunity-07/</guid>
            
            
            <category>nodejs</category>
            
            <category>azure</category>
            
            <category>webapps</category>
            
            <category>unity</category>
            
        </item>
      
    
      
        <item>
            <title>아빠 출근한다</title>
            <description>&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#때는-바야흐로-2016년&quot; id=&quot;markdown-toc-때는-바야흐로-2016년&quot;&gt;때는 바야흐로 2016년&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#회사의-인상은-사소한-것으로-결정된다&quot; id=&quot;markdown-toc-회사의-인상은-사소한-것으로-결정된다&quot;&gt;회사의 인상은 사소한 것으로 결정된다.&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#소규모-회사&quot; id=&quot;markdown-toc-소규모-회사&quot;&gt;소규모 회사&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#상대적으로-큰-회사&quot; id=&quot;markdown-toc-상대적으로-큰-회사&quot;&gt;상대적으로 큰 회사&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#게임-회사&quot; id=&quot;markdown-toc-게임-회사&quot;&gt;게임 회사&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#획기적인-경험&quot; id=&quot;markdown-toc-획기적인-경험&quot;&gt;획기적인 경험&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#맺음말&quot; id=&quot;markdown-toc-맺음말&quot;&gt;맺음말&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;때는-바야흐로-2016년&quot;&gt;때는 바야흐로 2016년&lt;/h2&gt;

&lt;p&gt;재미있게 지내던 회사가 어쩔 수 없는 이유로 문을 닫게 되었다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;첫 프로젝트가 결실을 맺어 차기 프로젝트로 한번 더 손발을 맞춰볼 수 있기를 바랐지만…&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;2017년 백수가 되었다. 취직하려고 이력서를 보내기 시작했다.&lt;/p&gt;

&lt;h2 id=&quot;회사의-인상은-사소한-것으로-결정된다&quot;&gt;회사의 인상은 사소한 것으로 결정된다.&lt;/h2&gt;

&lt;p&gt;지난 회사가 잘한 일은 입사 지원 시 &lt;code&gt;빠른 피드백&lt;/code&gt;, &lt;code&gt;면접비&lt;/code&gt;, &lt;code&gt;기다리지 않게하기&lt;/code&gt; 였다.&lt;/p&gt;

&lt;p&gt;입사 지원 메일 수신을 빠르게 피드백했고 면접 날짜 등을 조율하는 것 정확했다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;같이 일한 동료 중에 이런 회사는 아라소판단 뿐이었다고 말할 정도로 잘했다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;면접이 있는지 몰라 안내를 못하는 일은 없었다.&lt;/p&gt;

&lt;p&gt;그리고 작은 금액이라도 면접비가 지급되었다.&lt;/p&gt;

&lt;p&gt;이번에 이력서를 보낸 곳은 총 7곳이었다.&lt;/p&gt;

&lt;p&gt;2개 회사는 게임 회사이고 나머지는 웹 서비스를 제작하는 회사이다.&lt;/p&gt;

&lt;p&gt;3곳은 다른 회사에 비해서 규모가 컸다.&lt;/p&gt;

&lt;p&gt;그런데 규모와 상관없이 이런 연락이 늦거나 성의없는 대응을 보인 곳이 많았다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;메일 회신을 3주 후 한 곳도 있다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;소규모-회사&quot;&gt;소규모 회사&lt;/h3&gt;

&lt;p&gt;소규모 회사는 만나본 곳 모두 인상이 좋았다.&lt;/p&gt;

&lt;p&gt;일을 장악하고 있는 사람에게 풍기는 아우라랄까? 그런게 있었다.&lt;/p&gt;

&lt;p&gt;만나는 시간 자체가 즐거웠다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;그 중 한 회사 관계자는 개인적으로 친분을 유지하고 싶을만큼 대단했다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;상대적으로-큰-회사&quot;&gt;상대적으로 큰 회사&lt;/h3&gt;

&lt;p&gt;회사마다 인사 관리가 이뤄지는 것은 특별한 룰은 없겠지만 비교될 만큼 처리 속도와 성의가 다른 두 업체가 존재했다.&lt;/p&gt;

&lt;p&gt;한 곳은 기계가 보낸 이메일만 회신할 수 있었다.&lt;/p&gt;

&lt;p&gt;함께할 수 없다는 얘기조차 시스템 메일로 대체했다.&lt;/p&gt;

&lt;p&gt;다른 한 곳은 엄청난 속도로 면접까지 진행됐다. 이런 규모에서 이래도 되나 싶을만큼 빨랐다.&lt;/p&gt;

&lt;h3 id=&quot;게임-회사&quot;&gt;게임 회사&lt;/h3&gt;

&lt;p&gt;크기에 상관없이 모두 무성의했고 피드백도 느렸다.&lt;/p&gt;

&lt;p&gt;메일 회신 조차 없어서 놀랐다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;하긴 내가 별거 아닌 인간이긴 하다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;획기적인-경험&quot;&gt;획기적인 경험&lt;/h2&gt;

&lt;p&gt;&lt;img src=&quot;/images/flitto.png&quot; alt=&quot;인증샷&quot; /&gt;&lt;/p&gt;

&lt;p&gt;이번 구직과정에서 가장 미안한 마음이 든 곳은 &lt;code&gt;플리토&lt;/code&gt;였다.&lt;/p&gt;

&lt;p&gt;node.js를 서비스에 적용한 회사로 전부터 지켜봐왔던 터라 더욱 미안하다.&lt;/p&gt;

&lt;p&gt;구인을 조금 늦게 알았고 면접 제안이 왔을 때 이미 다른 회사에 출근확정을 한 상태였다.&lt;/p&gt;

&lt;p&gt;미안한 마음을 전하고 싶었다. 그러던 중 연락을 받아 급 만남을 가졌다.&lt;/p&gt;

&lt;p&gt;회사를 둘러보고 얘기를 나눌 수 있는 즐거운 경험이었다.&lt;/p&gt;

&lt;p&gt;면접를 거절한 구직자와 구인자가 마주 앉아서 얘기를 나누다니!!&lt;/p&gt;

&lt;p&gt;대인배란 이런 것인가?!&lt;/p&gt;

&lt;h2 id=&quot;맺음말&quot;&gt;맺음말&lt;/h2&gt;

&lt;p&gt;많은 구직자 중 한 명에게 어떤 인상을 주느냐는 회사 차원에서 사소한 일이다.&lt;/p&gt;

&lt;p&gt;사소함이 술자리에 오르고 티 테이블에 오른다.&lt;/p&gt;

&lt;p&gt;지인의 사소한 경험은 선입견을 만들 때 많은 힘이 있다.&lt;/p&gt;

&lt;p&gt;PR자료 돌리고 이미지 광고하는 것보다 사소한 일에 더 신경쓰면 좋겠다.&lt;/p&gt;
</description>
            <pubDate>Sun, 26 Feb 2017 09:00:00 +0900</pubDate>
            <link>http://totuworld.github.io/2017/02/26/job/</link>
            <guid isPermaLink="true">http://totuworld.github.io/2017/02/26/job/</guid>
            
            
            <category>etc</category>
            
        </item>
      
    
      
        <item>
            <title>Wendy 프로젝트 진행사항 3</title>
            <description>&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#들어가는-말&quot; id=&quot;markdown-toc-들어가는-말&quot;&gt;들어가는 말&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#프로젝트-진행-사항&quot; id=&quot;markdown-toc-프로젝트-진행-사항&quot;&gt;프로젝트 진행 사항&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#기능-목록&quot; id=&quot;markdown-toc-기능-목록&quot;&gt;기능 목록&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#튜토리얼-제작-사항&quot; id=&quot;markdown-toc-튜토리얼-제작-사항&quot;&gt;튜토리얼 제작 사항&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#완성된-튜토리얼-목록&quot; id=&quot;markdown-toc-완성된-튜토리얼-목록&quot;&gt;완성된 튜토리얼 목록&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#튜토리얼-제작-진행사항&quot; id=&quot;markdown-toc-튜토리얼-제작-진행사항&quot;&gt;튜토리얼 제작 진행사항&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#소식들&quot; id=&quot;markdown-toc-소식들&quot;&gt;소식들&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#웬디-근황&quot; id=&quot;markdown-toc-웬디-근황&quot;&gt;웬디 근황&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#좋은-소식&quot; id=&quot;markdown-toc-좋은-소식&quot;&gt;좋은 소식&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#우울한-소식&quot; id=&quot;markdown-toc-우울한-소식&quot;&gt;우울한 소식&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#맺음말&quot; id=&quot;markdown-toc-맺음말&quot;&gt;맺음말&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;들어가는-말&quot;&gt;들어가는 말&lt;/h2&gt;

&lt;p&gt;2017년 2월은 레드벨벳 웬디와 Wendy가 있어 행복하고 재미나다.&lt;/p&gt;

&lt;h2 id=&quot;프로젝트-진행-사항&quot;&gt;프로젝트 진행 사항&lt;/h2&gt;
&lt;p&gt;자원(통화, 아이템)을 관리할 수 있게 되고 지급 관리까지 제작되었다.&lt;/p&gt;

&lt;p&gt;서비스로 쿠폰도 제작!&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;a href=&quot;https://github.com/totuworld/Wendy&quot;&gt;Wendy 프로젝트 레파지토리&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;기능-목록&quot;&gt;기능 목록&lt;/h3&gt;
&lt;ul&gt;
  &lt;li&gt;기기 관리&lt;/li&gt;
  &lt;li&gt;사용자 관리&lt;/li&gt;
  &lt;li&gt;통화 관리&lt;/li&gt;
  &lt;li&gt;아이템 관리&lt;/li&gt;
  &lt;li&gt;자원(통화, 아이템) 지급 관리&lt;/li&gt;
  &lt;li&gt;쿠폰&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;튜토리얼-제작-사항&quot;&gt;튜토리얼 제작 사항&lt;/h2&gt;
&lt;p&gt;2월에도 2개 강좌가 더 제작되었다.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;5강 - 아이템 관리&lt;/li&gt;
  &lt;li&gt;6강 - 자원 지급 관리&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;완성된-튜토리얼-목록&quot;&gt;완성된 튜토리얼 목록&lt;/h3&gt;
&lt;ul&gt;
  &lt;li&gt;1강 - &lt;a href=&quot;http://totuworld.github.io/2016/12/21/azureandunity-01/&quot;&gt;Hello, world!&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;2강 - &lt;a href=&quot;http://totuworld.github.io/2016/12/29/azureandunity-02/&quot;&gt;SQL데이터베이스스와 환경설정&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;3강 - &lt;a href=&quot;http://totuworld.github.io/2017/01/12/azureandunity-03/&quot;&gt;기기와 사용자 관리&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;4강 - &lt;a href=&quot;http://totuworld.github.io/2017/01/26/azureandunity-04/&quot;&gt;통화관리&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;5강 - &lt;a href=&quot;http://totuworld.github.io/2017/02/09/azureandunity-05/&quot;&gt;아이템 관리&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;6강 - &lt;a href=&quot;http://totuworld.github.io/2017/02/21/azureandunity-06/&quot;&gt;자원 지급 관리&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;튜토리얼-제작-진행사항&quot;&gt;튜토리얼 제작 진행사항&lt;/h3&gt;
&lt;ul&gt;
  &lt;li&gt;7강 : … 시작도 못했는데 어쩌죠?&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;소식들&quot;&gt;소식들&lt;/h2&gt;
&lt;h3 id=&quot;웬디-근황&quot;&gt;웬디 근황&lt;/h3&gt;

&lt;p&gt;2월 21일. 웬디는 생일이었다.&lt;/p&gt;

&lt;iframe width=&quot;560&quot; height=&quot;315&quot; src=&quot;https://www.youtube.com/embed/87OYm-cKeA8&quot; frameborder=&quot;0&quot; allowfullscreen=&quot;&quot;&gt;&lt;/iframe&gt;

&lt;blockquote&gt;
  &lt;p&gt;이렇게 좋고 행복한 일상만 보내라 웬디야!!&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;좋은-소식&quot;&gt;좋은 소식&lt;/h3&gt;

&lt;p&gt;&lt;a href=&quot;https://www.microsoft.com/korea/msdn/flash/archive/msdn_newsletter_1701.html&quot;&gt;MSDN 뉴스레터 2017년 1월&lt;/a&gt;에 강좌 소식이 소개되었다.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/msdn_newsletter_201701.png&quot; alt=&quot;뉴스레터인증샷&quot; width=&quot;300px&quot; /&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;요리왕 류ㅎㅇ과장님 감사합니다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;그리고 &lt;code&gt;나는 프로그래머다&lt;/code&gt; 페이스북 페이지에도 소개되었다.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/iamprogrammer_0224.png&quot; alt=&quot;나프다인증샷&quot; width=&quot;460px&quot; /&gt;&lt;/p&gt;

&lt;p&gt;6강은 화요일(2월 21일 웬디 생일)에 &lt;a href=&quot;http://www.youtube.com/user/totuworld7/live&quot;&gt;유튜브 스트리밍&lt;/a&gt;으로 방송했다.&lt;/p&gt;

&lt;p&gt;4명이 소중한 분들이 있어서 힘이났다. 편집이 1시간 밖에 걸리지 않아서 너무 좋았다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;그래서 3월 7일 화요일 7강도 라이브로 진행하고 편집할 생각이다!!&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;우울한-소식&quot;&gt;우울한 소식&lt;/h3&gt;

&lt;p&gt;유튜브 스트리밍에 앞서 대기중일 때 레드벨벳 신곡을 틀었다. 저작권을 침해한 내 잘못이다.&lt;/p&gt;

&lt;p&gt;그래서 &lt;code&gt;SM Ent&lt;/code&gt;로부터 경고를 득하게 되었다.&lt;/p&gt;

&lt;p&gt;다음 방송에서는 조심하고 또 조심해야겠다.&lt;/p&gt;

&lt;h2 id=&quot;맺음말&quot;&gt;맺음말&lt;/h2&gt;

&lt;p&gt;새로운 회사로 옮기는 시점이 2월 초였다. 진행이 어렵게되서 약속을 지키지 못하면 어쩌나 걱정했다.&lt;/p&gt;

&lt;p&gt;다행히 5, 6강 강을 약속한 날짜에 발행했다(나와의 약속?).&lt;/p&gt;

&lt;p&gt;1차 목표로 했던 7강까지 잘 마무리하길 바란다.&lt;/p&gt;

&lt;p&gt;그 이후는 어떤 기능을 필요로하는지 의견을 듣고 정리해서 진행해야겠다.&lt;/p&gt;
</description>
            <pubDate>Fri, 24 Feb 2017 21:00:00 +0900</pubDate>
            <link>http://totuworld.github.io/2017/02/24/wendynotification/</link>
            <guid isPermaLink="true">http://totuworld.github.io/2017/02/24/wendynotification/</guid>
            
            
            <category>wendy</category>
            
        </item>
      
    
      
        <item>
            <title>이세계에 진입한 서버 개발 - 6</title>
            <description>&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#들어가는-말&quot; id=&quot;markdown-toc-들어가는-말&quot;&gt;들어가는 말&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#모델-추가&quot; id=&quot;markdown-toc-모델-추가&quot;&gt;모델 추가&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#라우터-추가&quot; id=&quot;markdown-toc-라우터-추가&quot;&gt;라우터 추가&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#appjs에-등록&quot; id=&quot;markdown-toc-appjs에-등록&quot;&gt;app.js에 등록&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#공통-사용-로직-추가&quot; id=&quot;markdown-toc-공통-사용-로직-추가&quot;&gt;공통 사용 로직 추가&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#자원-추가-메서드-incrementmaterials&quot; id=&quot;markdown-toc-자원-추가-메서드-incrementmaterials&quot;&gt;자원 추가 메서드 incrementMaterials&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#logicsrewardjs-추가&quot; id=&quot;markdown-toc-logicsrewardjs-추가&quot;&gt;logics/reward.js 추가&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#간단-테스트&quot; id=&quot;markdown-toc-간단-테스트&quot;&gt;간단 테스트&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#간단-테스트용-라우터-추가&quot; id=&quot;markdown-toc-간단-테스트용-라우터-추가&quot;&gt;간단 테스트용 라우터 추가&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#데이터-입력&quot; id=&quot;markdown-toc-데이터-입력&quot;&gt;데이터 입력&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#즉시-지급-테스트&quot; id=&quot;markdown-toc-즉시-지급-테스트&quot;&gt;즉시 지급 테스트&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#쿠폰-제작&quot; id=&quot;markdown-toc-쿠폰-제작&quot;&gt;쿠폰 제작&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#쿠폰-모델-추가&quot; id=&quot;markdown-toc-쿠폰-모델-추가&quot;&gt;쿠폰 모델 추가&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#쿠폰-라우터-추가&quot; id=&quot;markdown-toc-쿠폰-라우터-추가&quot;&gt;쿠폰 라우터 추가&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#appjs에-등록-1&quot; id=&quot;markdown-toc-appjs에-등록-1&quot;&gt;app.js에 등록&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#테스트용-데이터-추가&quot; id=&quot;markdown-toc-테스트용-데이터-추가&quot;&gt;테스트용 데이터 추가&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#쿠폰-테스트&quot; id=&quot;markdown-toc-쿠폰-테스트&quot;&gt;쿠폰 테스트&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#맺음말&quot; id=&quot;markdown-toc-맺음말&quot;&gt;맺음말&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#참고자료&quot; id=&quot;markdown-toc-참고자료&quot;&gt;참고자료&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;iframe width=&quot;560&quot; height=&quot;315&quot; src=&quot;https://www.youtube.com/embed/ZSloWdCq4LY&quot; frameborder=&quot;0&quot; allowfullscreen=&quot;&quot;&gt;&lt;/iframe&gt;

&lt;h2 id=&quot;들어가는-말&quot;&gt;들어가는 말&lt;/h2&gt;

&lt;p&gt;지난 시간에 아이템 관리까지 다루면서 게임 내 자원을 지급할 수 있는 기반이 마련되었다.&lt;/p&gt;

&lt;p&gt;이번 시간에는 자원을 지급하도록 해보겠다.&lt;/p&gt;

&lt;h2 id=&quot;모델-추가&quot;&gt;모델 추가&lt;/h2&gt;
&lt;p&gt;모델은 총 4개가 필요하다.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;models&lt;/code&gt; 폴더에 파일을 추가하고 각각 아래 내용을 적용한다.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://raw.githubusercontent.com/totuworld/Wendy/tuto6.1/models/RewardSetGroup.js&quot;&gt;RewardSetGroup.js&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://raw.githubusercontent.com/totuworld/Wendy/tuto6.1/models/RewardSet.js&quot;&gt;RewardSet.js&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://raw.githubusercontent.com/totuworld/Wendy/tuto6.1/models/RewardGoodsGroup.js&quot;&gt;RewardGoodsGroup.js&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://raw.githubusercontent.com/totuworld/Wendy/tuto6.1/models/RewardGoods.js&quot;&gt;RewardGoods.js&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;위 모델 중 가장 기본이 되는 것은 &lt;code&gt;RewardGoodsGroup&lt;/code&gt;과 &lt;code&gt;RewardGoods&lt;/code&gt;이다.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;RewardGoodsGroup&lt;/code&gt;에서 관리되는 &lt;code&gt;RewardGoodsGroupID&lt;/code&gt;를 통해 다수의 &lt;code&gt;RewardGoods&lt;/code&gt; 목록을 그룹으로 묶는다.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/rvwendy05_03.png&quot; alt=&quot;RewardGoodsGroup과RewardGoods의 관계&quot; width=&quot;250px&quot; /&gt;&lt;/p&gt;

&lt;p&gt;이렇게 묶어두는 이유는 하나의 상품으로 다수의 자원이 지급될 수 있도록 하기 위함이다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;행운 상자라고 지칭한 뒤 최소 확율로 요원이 나오고 높은 확율로 골드 정도를 묶은 상품을 생각하면 된다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;code&gt;RewardSetGroup&lt;/code&gt;은 &lt;code&gt;RewardSetGroupID&lt;/code&gt;를 통해 &lt;code&gt;RewardSet&lt;/code&gt;에 다수의 &lt;code&gt;RewardGoodsGroupID&lt;/code&gt;를 등록할 수 있는 형태이다.&lt;/p&gt;

&lt;p&gt;이렇게되면 묶음(패키지) 상품을 제공할 수 있다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;골드와 보석, 키 등이 한번에 포함된 상품을 제공하는 스타터 팩을 생각하면 된다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;img src=&quot;/images/rvwendy05_04.png&quot; alt=&quot;RewardSetGroup과RewardSet의 관계&quot; width=&quot;500px&quot; /&gt;&lt;/p&gt;

&lt;p&gt;단순한 묶음 상품이상으로 작동하도록 &lt;code&gt;RewardSet&lt;/code&gt;에도 드랍 확율을 넣었다. 묶음 상품 안에서 운이 좋으면 추가 재화를 얻을 수 있도록 말이다.&lt;/p&gt;

&lt;h2 id=&quot;라우터-추가&quot;&gt;라우터 추가&lt;/h2&gt;

&lt;p&gt;자원 세트(묶음 상품)와 지급 가능한 자원 정보를 추가하겠다.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;GET /reward/set&lt;/li&gt;
  &lt;li&gt;GET /reward/goods&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;code&gt;routes&lt;/code&gt;폴더에 &lt;code&gt;reward.js&lt;/code&gt;파일을 추가하고 아래 내용을 적용한다.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://raw.githubusercontent.com/totuworld/Wendy/tuto6.1/routes/reward.js&quot;&gt;routes/reward.js&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;appjs에-등록&quot;&gt;app.js에 등록&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;app.js&lt;/code&gt; 파일을 수정하여 reward 라우터를 추가해보자.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;code&gt;app.js&lt;/code&gt;에서 아래 내용을 찾아서 그 아래쪽에 코드를 추가한다.&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;
        &lt;p&gt;찾아야하는 내용&lt;/p&gt;

        &lt;pre&gt;&lt;code&gt;  const routes = require(&#39;./routes/index&#39;);
&lt;/code&gt;&lt;/pre&gt;
      &lt;/li&gt;
      &lt;li&gt;
        &lt;p&gt;추가할 코드&lt;/p&gt;

        &lt;pre&gt;&lt;code&gt;  const reward = require(&#39;./routes/reward&#39;);
&lt;/code&gt;&lt;/pre&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;code&gt;app.js&lt;/code&gt;에서 아래 내용을 찾아서 그 아래쪽에 코드를 추가한다.&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;
        &lt;p&gt;찾아야하는 내용&lt;/p&gt;

        &lt;pre&gt;&lt;code&gt;  app.use(&#39;/&#39;, routes);
&lt;/code&gt;&lt;/pre&gt;
      &lt;/li&gt;
      &lt;li&gt;
        &lt;p&gt;추가할 코드&lt;/p&gt;

        &lt;pre&gt;&lt;code&gt;  app.use(&#39;/reward&#39;, reward);
&lt;/code&gt;&lt;/pre&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;공통-사용-로직-추가&quot;&gt;공통 사용 로직 추가&lt;/h2&gt;
&lt;p&gt;지금까지 모델을 추가했으며 간단한 2개의 API를 등록했다.&lt;/p&gt;

&lt;p&gt;이제 지급과 관련된 작업을 할 때 필요한 메서드를 추가하도록 하겠다.&lt;/p&gt;

&lt;h3 id=&quot;자원-추가-메서드-incrementmaterials&quot;&gt;자원 추가 메서드 incrementMaterials&lt;/h3&gt;

&lt;p&gt;지난 시간에 &lt;code&gt;logics/materialCtrl.js&lt;/code&gt;를 추가한 것이 기억나는가? 자원을 차감하는 메서드가 있었다.&lt;/p&gt;

&lt;p&gt;여기에 자원을 추가하는 메서드를 추가한다.&lt;/p&gt;

&lt;p&gt;다른 메서드와 겹치지 않게 &lt;code&gt;logics/materialCtrl.js&lt;/code&gt; 제일 아래쪽에 추가한다.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;let incrementMaterial = (GameUserID, ItemID, Amount, NowMaxQNTY=null)=&amp;gt;{
    return models.DefineItem.findOne({
        where:{
            ItemID:ItemID
        }
    })
    .then((defineItem)=&amp;gt;{
        if(defineItem === null || defineItem === undefined)
            throw wendyError(&#39;UndefinedItem&#39;);

        switch(defineItem.ItemType) {
            case 10://통화 상품
                return incrementMaterialForCurrency(
                    GameUserID, ItemID, Amount, NowMaxQNTY);
                break;
            default ://특별한 정의가 없다면 모두 아이템을 처리한다.
                return incrementMaterialForItem(
                    GameUserID, defineItem, ItemID, Amount);
                break;
        }
    })
}

exports.incrementMaterial = incrementMaterial;

let createCurrency = (GameUserID, ItemID, Amount, defineCurrency=null, NowMaxQNTY=null)=&amp;gt;{
    let createObj = {
        GameUserID:GameUserID, 
        CurrencyID:ItemID,
        CurrentQNTY:Amount,
        NowMaxQNTY:NowMaxQNTY===null?100:NowMaxQNTY,
        UpdateTimeStamp:new Date()
    }

    return Promise.resolve()
    .then(()=&amp;gt;{
        if(NowMaxQNTY!==null)
            return Promise.reject(&#39;pass&#39;);
        return Promise.resolve();
    })
    .then(()=&amp;gt;{
        if( defineCurrency!==null )
            createObj.NowMaxQNTY = defineCurrency.MaxQNTY;
        return Promise.resolve();
    })
    .catch((err)=&amp;gt;{
        if(err &amp;amp;&amp;amp; err instanceof Error) {
            return Promise.reject(err);
        }
        else if(err===&#39;pass&#39;)
            return Promise.resolve();
    })
    .then(()=&amp;gt;{
        return models.OwnCurrency.create(createObj);
    })
}

let incrementMaterialForCurrency = (GameUserID, ItemID, Amount, NowMaxQNTY=null)=&amp;gt;{
    let defineCurrency = null;

    return models.DefineCurrency.findOne({where:{CurrencyID:ItemID}})
    .then((loadDefineCurrency)=&amp;gt;{
        if( !(loadDefineCurrency === null || loadDefineCurrency===undefined) )
            defineCurrency = loadDefineCurrency;
        return Promise.resolve();
    })
    .then(()=&amp;gt;{
        return models.OwnCurrency.findOne({
            where:{
                GameUserID:GameUserID, 
                CurrencyID:ItemID
            }})
    })
    .then((ownCurrency)=&amp;gt;{
        if(ownCurrency === null || ownCurrency === undefined)
            return createCurrency(
                GameUserID, 
                ItemID, 
                Amount, 
                defineCurrency,
                NowMaxQNTY);
        
        let incrementValue = (ownCurrency.CurrentQNTY + Amount);
        if(incrementValue&amp;gt;defineCurrency.MaxQNTY)
            incrementValue = defineCurrency.MaxQNTY;

        return models.OwnCurrency.update(
            { CurrentQNTY: incrementValue, UpdateTimeStamp: new Date() },
            { where: { OwnCurrencyUID: ownCurrency[&#39;OwnCurrencyUID&#39;] } }
        )
            .then(() =&amp;gt; {
                return models.OwnCurrency.findOne({
                    where: { OwnCurrencyUID: ownCurrency[&#39;OwnCurrencyUID&#39;] }
                })
            })
    })
    
}

let incrementMaterialForItem = (GameUserID, defineItem, ItemID, Amount)=&amp;gt;{
    return Promise.resolve()
    .then(()=&amp;gt;{
        if(defineItem.Multiple===false)
            return Promise.reject(&#39;create&#39;);
        return Promise.resolve();
    })
    .then(()=&amp;gt;{
        return models.OwnItem.findOne({where:{
            GameUserID:GameUserID,
            ItemID:ItemID
        }})
    })
    .then((ownItem)=&amp;gt;{
        if(ownItem === null || ownItem === undefined)
            return Promise.reject(&#39;create&#39;);
        
        let incrementValue = 
            (ownItem.CurrentQNTY + Amount)&amp;gt;defineItem.MaxQNTY
            ? defineItem.MaxQNTY - ownItem.CurrentQNTY
            : Amount;
        
        return ownItem.increment(&#39;CurrentQNTY&#39;, {by:incrementValue})
        .then(()=&amp;gt;{
            return models.OwnItem.findOne({where:{
                OwnItemID:ownItem[&#39;OwnItemUID&#39;]
            }})
        })
    })
    .catch((err)=&amp;gt;{
        if(err &amp;amp;&amp;amp; err instanceof Error) {
            return Promise.reject(err);
        }
        else if(err===&#39;create&#39;) {
            return models.OwnItem.create({
                GameUserID:GameUserID,
                ItemID:ItemID,
                CurrentQNTY:Amount,
                UpdateTimeStamp:new Date()
            });
        }
    })
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;logicsrewardjs-추가&quot;&gt;logics/reward.js 추가&lt;/h3&gt;

&lt;p&gt;RewardSetGroup과 RewardGoodsGroup을 바탕으로 &lt;code&gt;logics/materialCtrl.js&lt;/code&gt;의 자원 추가 메서드로 자원을 지급하는 로직을 제작하겠다.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;logics/reward.js&lt;/code&gt; 파일을 추가한 뒤 아래 내용을 적용한다.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://raw.githubusercontent.com/totuworld/Wendy/tuto6.3/logics/reward.js&quot;&gt;logics/reward.js&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;위 코드가 문제 없이 작동하려면 2가지를 더 추가해야한다.&lt;/p&gt;

&lt;p&gt;먼저 &lt;code&gt;utils/commonFunc.js&lt;/code&gt;에 아래 2가지 메서드를 추가한다.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;/**
 * low와 high 사이의 숫자를 랜덤으로 리턴한다.
 * @returns {number}
 */
exports.RandomInt = (low, high)=&amp;gt;{
    return Math.floor(Math.random() * (high - low + 1) + low);
};

function async(makeGenerator) {
    return function () {
        let generator = makeGenerator.apply(this, arguments)

        function handle(result) { // { done: [Boolean], value: [Object] }
            if (result.done) return result.value

            return result.value.then(function (res) {
                return handle(generator.next(res))
            }, function (err) {
                return handle(generator.throw(err))
            })
        }

        return handle(generator.next())
    }
}

exports.async = async;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;그리고 에러코드를 추가한다. &lt;code&gt;utils/error.js&lt;/code&gt;에 아래 클래스를 추가한다.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;/** 80611 */
class NotPresentRewardSetGroupID extends CustomError {
    constructor() {
        let message = &#39;RewardSetGroupID가 존재하지 않는다.&#39;;
        let code = 80611;
        super(message, code);
    }
}

/** 80612 */
class DidntRegisterRewardSet extends CustomError {
    constructor() {
        let message = &#39;RewardSetGroupID와 관련된 정보를 RewardSet에 등록하지 않았다.&#39;;
        let code = 80612;
        super(message, code);
    }
}


/** 80621 */
class NotPresentRewardGoodsGroupID extends CustomError {
    constructor() {
        let message = &#39;RewardGoodsGroupID가 존재하지 않는다.&#39;;
        let code = 80621;
        super(message, code);
    }
}

/** 80622 */
class DidntRegisterRewardGoods extends CustomError {
    constructor() {
        let message = &#39;RewardGoodsGroupID와 관련된 정보를 RewardGoods에 등록하지 않았다.&#39;;
        let code = 80622;
        super(message, code);
    }
}

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;utils/error.js&lt;/code&gt;의 &lt;code&gt;errorMap&lt;/code&gt; 오브젝트에 추가할 클래스를 등록한다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;추가할 때 이전의 마지막 부분 - 여기서는 NoLongerUpgrade - 에 콤마(,)를 추가하여야 한다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;&quot;NotPresentRewardSetGroupID&quot;:NotPresentRewardSetGroupID,
&quot;DidntRegisterRewardSet&quot;:DidntRegisterRewardSet,

&quot;NotPresentRewardGoodsGroupID&quot;:NotPresentRewardGoodsGroupID,
&quot;DidntRegisterRewardGoods&quot;:DidntRegisterRewardGoods

&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&quot;간단-테스트&quot;&gt;간단 테스트&lt;/h2&gt;
&lt;p&gt;지급 가능하도록 테이블에 데이터를 입력하고 실제 지급이 이뤄지는 테스트해보자.&lt;/p&gt;

&lt;h3 id=&quot;간단-테스트용-라우터-추가&quot;&gt;간단 테스트용 라우터 추가&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;이 내용은 앞서 routes/reward.js 를 추가할 때 이미 들어가있으므로 추가 하지 않는다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;code&gt;routes/reward.js&lt;/code&gt; 하단에 아래 코드를 추가한다.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;const env       = process.env.NODE_ENV || &quot;development&quot;;

if(env === &#39;development&#39;) {
    router.get(&#39;/test/:RewardGroupID&#39;, auth.isAuthenticated, (req, res, next)=&amp;gt;{

        rewardCtrl.paymentMaterial(req.user.GameUserID, req.params.RewardGroupID)
        .then((result)=&amp;gt;{
            res.send({result:0, reward:result});
        })
        .catch((err)=&amp;gt;{
            if(err === &#39;pass&#39;)
                res.send({result:0, reward:[]})
            else
                next(err);
        })
    });
}

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;환경변수 &lt;code&gt;NODE_ENV&lt;/code&gt;가 &lt;code&gt;development&lt;/code&gt;일 때만 사용가능도록 조치했다.&lt;/p&gt;

&lt;h3 id=&quot;데이터-입력&quot;&gt;데이터 입력&lt;/h3&gt;

&lt;p&gt;테스트를 진행하기 위해서는 총 4개 테이블에 데이터를 등록해야한다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;DBeaver를 이용한다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;code&gt;RewardGoodsGroup&lt;/code&gt; 테이블에 데이터를 입력한다.&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;RewardGoodsGroupID&lt;/th&gt;
      &lt;th&gt;Description&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;1011&lt;/td&gt;
      &lt;td&gt;NULL&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;1012&lt;/td&gt;
      &lt;td&gt;NULL&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;&lt;code&gt;RewardGoods&lt;/code&gt; 테이블에 데이터를 입력한다.&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;RewardGoodsUID&lt;/th&gt;
      &lt;th&gt;AmountMin&lt;/th&gt;
      &lt;th&gt;AmountMax&lt;/th&gt;
      &lt;th&gt;DropRatio&lt;/th&gt;
      &lt;th&gt;ItemID&lt;/th&gt;
      &lt;th&gt;RewardGoodsGroupID&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;NULL&lt;/td&gt;
      &lt;td&gt;10&lt;/td&gt;
      &lt;td&gt;1000&lt;/td&gt;
      &lt;td&gt;0.9&lt;/td&gt;
      &lt;td&gt;103&lt;/td&gt;
      &lt;td&gt;1011&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;NULL&lt;/td&gt;
      &lt;td&gt;1&lt;/td&gt;
      &lt;td&gt;10&lt;/td&gt;
      &lt;td&gt;0.15&lt;/td&gt;
      &lt;td&gt;102&lt;/td&gt;
      &lt;td&gt;1011&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;NULL&lt;/td&gt;
      &lt;td&gt;1&lt;/td&gt;
      &lt;td&gt;1&lt;/td&gt;
      &lt;td&gt;0.05&lt;/td&gt;
      &lt;td&gt;2001&lt;/td&gt;
      &lt;td&gt;1011&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;NULL&lt;/td&gt;
      &lt;td&gt;10&lt;/td&gt;
      &lt;td&gt;100&lt;/td&gt;
      &lt;td&gt;0.1&lt;/td&gt;
      &lt;td&gt;102&lt;/td&gt;
      &lt;td&gt;1012&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;&lt;code&gt;RewardSetGroup&lt;/code&gt; 테이블에 데이터를 입력한다.&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;RewardSetGroupID&lt;/th&gt;
      &lt;th&gt;Description&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;6001&lt;/td&gt;
      &lt;td&gt;NULL&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;6002&lt;/td&gt;
      &lt;td&gt;NULL&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;&lt;code&gt;RewardSet&lt;/code&gt; 테이블에 데이터를 입력한다.&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;RewardSetUID&lt;/th&gt;
      &lt;th&gt;DropRatio&lt;/th&gt;
      &lt;th&gt;RewardGoodsGroupID&lt;/th&gt;
      &lt;th&gt;RewardSetGroupID&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;NULL&lt;/td&gt;
      &lt;td&gt;1&lt;/td&gt;
      &lt;td&gt;1011&lt;/td&gt;
      &lt;td&gt;6001&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;NULL&lt;/td&gt;
      &lt;td&gt;0.5&lt;/td&gt;
      &lt;td&gt;1012&lt;/td&gt;
      &lt;td&gt;6001&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;NULL&lt;/td&gt;
      &lt;td&gt;1&lt;/td&gt;
      &lt;td&gt;1012&lt;/td&gt;
      &lt;td&gt;6002&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h3 id=&quot;즉시-지급-테스트&quot;&gt;즉시 지급 테스트&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;패스 : GET&lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;URL : localhost:3000/reward/test/6001&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;Headers : Authorization을 추가하고 토큰 내용을 value 부분에 넣는다.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;정상적으로 요청되면 아래와 같은 형식의 결과를 확인할 수 있다.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-json&quot;&gt;{
  &quot;result&quot;: 0,
  &quot;reward&quot;: {
    &quot;item&quot;: [],
    &quot;currency&quot;: [
      {
        &quot;TotalQNTY&quot;: 900000,
        &quot;OwnCurrencyUID&quot;: 7,
        &quot;CurrencyID&quot;: 103,
        &quot;CurrentQNTY&quot;: 1217,
        &quot;NowMaxQNTY&quot;: 900000,
        &quot;AddMaxQNTY&quot;: 0,
        &quot;UpdateTimeStamp&quot;: &quot;2017-02-21T00:00:00.000Z&quot;,
        &quot;GameUserID&quot;: 1
      }
    ]
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;쿠폰-제작&quot;&gt;쿠폰 제작&lt;/h2&gt;

&lt;p&gt;자원을 지급할 수 있으면 제작가능한 기능이 많다.&lt;/p&gt;

&lt;p&gt;빨리 만들 수 있는 쿠폰을 제작해보도록 하겠다.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/rvwendy06_01.png&quot; alt=&quot;쿠폰&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;쿠폰-모델-추가&quot;&gt;쿠폰 모델 추가&lt;/h3&gt;

&lt;p&gt;쿠폰은 총 3개의 모델이 필요하다. &lt;code&gt;models&lt;/code&gt; 폴더에 파일을 추가하고 각각 아래 내용을 적용한다.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://raw.githubusercontent.com/totuworld/Wendy/tuto6.2/models/DefineCoupon.js&quot;&gt;DefineCoupon.js&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://raw.githubusercontent.com/totuworld/Wendy/tuto6.2/models/CouponQNTY.js&quot;&gt;CouponQNTY.js&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://raw.githubusercontent.com/totuworld/Wendy/tuto6.2/models/LogCoupon.js&quot;&gt;LogCoupon.js&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;code&gt;DefineCoupon&lt;/code&gt;은 쿠폰을 정의하고 &lt;code&gt;CouponQNTY&lt;/code&gt;는 정의된 쿠폰 중 수량만 별도로 적을 수 있도록 한다.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;DefineCoupon&lt;/code&gt;은 &lt;code&gt;RewardGoodsGroup&lt;/code&gt;이나 &lt;code&gt;RewardSetGroup&lt;/code&gt;의 ID를 이용해서 지급한다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;이때 주의할 점은 둘 중 하나는 꼭 등록을해야 올바로 지급이 가능하다는 점이다. 관리자 도구 제작 시 참고한다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;img src=&quot;/images/rvwendy06_02.png&quot; alt=&quot;DefineCoupon예시&quot; width=&quot;400px&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;code&gt;LogCoupon&lt;/code&gt;은 사용자의 쿠폰 사용 이력을 기록하여 중복 사용을 방지한다.&lt;/p&gt;

&lt;h3 id=&quot;쿠폰-라우터-추가&quot;&gt;쿠폰 라우터 추가&lt;/h3&gt;

&lt;p&gt;정의된 쿠폰 리스트를 요청할 수 있고 쿠폰을 사용할 수 있다.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;GET /coupon/list&lt;/li&gt;
  &lt;li&gt;POST /coupon/use/:CouponName&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;code&gt;routes&lt;/code&gt;폴더에 &lt;code&gt;coupon.js&lt;/code&gt;파일을 추가하고 아래 내용을 적용한다.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://raw.githubusercontent.com/totuworld/Wendy/tuto6.2/routes/coupon.js&quot;&gt;routes/coupon.js&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;쿠폰 사용부분이 조금 복잡하게 되어있을 것이다. 중복 사용이 불가능하도록 해야하고 유효한 쿠폰인지 검증하는 부분이 많아서 그렇다.&lt;/p&gt;

&lt;p&gt;단순하게 절차를 나타내면 아래처럼 진행된다.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;유효한 쿠폰인지 검증&lt;/li&gt;
  &lt;li&gt;쿠폰 사용 기록&lt;/li&gt;
  &lt;li&gt;자원 지급&lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&quot;appjs에-등록-1&quot;&gt;app.js에 등록&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;app.js&lt;/code&gt; 파일을 수정하여 coupon 라우터를 추가해보자.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;code&gt;app.js&lt;/code&gt;에서 아래 내용을 찾아서 그 아래쪽에 코드를 추가한다.&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;
        &lt;p&gt;찾아야하는 내용&lt;/p&gt;

        &lt;pre&gt;&lt;code&gt;  const routes = require(&#39;./routes/index&#39;);
&lt;/code&gt;&lt;/pre&gt;
      &lt;/li&gt;
      &lt;li&gt;
        &lt;p&gt;추가할 코드&lt;/p&gt;

        &lt;pre&gt;&lt;code&gt;  const coupon = require(&#39;./routes/coupon&#39;);
&lt;/code&gt;&lt;/pre&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;code&gt;app.js&lt;/code&gt;에서 아래 내용을 찾아서 그 아래쪽에 코드를 추가한다.&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;
        &lt;p&gt;찾아야하는 내용&lt;/p&gt;

        &lt;pre&gt;&lt;code&gt;  app.use(&#39;/&#39;, routes);
&lt;/code&gt;&lt;/pre&gt;
      &lt;/li&gt;
      &lt;li&gt;
        &lt;p&gt;추가할 코드&lt;/p&gt;

        &lt;pre&gt;&lt;code&gt;  app.use(&#39;/coupon&#39;, coupon);
&lt;/code&gt;&lt;/pre&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&quot;테스트용-데이터-추가&quot;&gt;테스트용 데이터 추가&lt;/h3&gt;

&lt;p&gt;&lt;code&gt;CouponQNTY&lt;/code&gt; 테이블에 데이터를 입력한다.&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;CouponQNTYID&lt;/th&gt;
      &lt;th&gt;CurrentQNTY&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;-&lt;/td&gt;
      &lt;td&gt;10&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;&lt;code&gt;DefineCoupon&lt;/code&gt; 테이블에 데이터를 입력한다.&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;CouponID&lt;/th&gt;
      &lt;th&gt;CouponName&lt;/th&gt;
      &lt;th&gt;ExpiredDate&lt;/th&gt;
      &lt;th&gt;CouponQNTYID&lt;/th&gt;
      &lt;th&gt;RewardSetGroupID&lt;/th&gt;
      &lt;th&gt;RewardGoodsGroupID&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;-&lt;/td&gt;
      &lt;td&gt;test&lt;/td&gt;
      &lt;td&gt;2017-02-24&lt;/td&gt;
      &lt;td&gt;1&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
      &lt;td&gt;1011&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;code&gt;CouponQNTYID&lt;/code&gt;는 반드시 앞서 CouponQNTY 테이블에 등록된 CouponQNTYID를 확인하여 올바로 입력한다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;쿠폰-테스트&quot;&gt;쿠폰 테스트&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;패스 : POST&lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;URL : localhost:3000/coupon/use/test&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;Headers : Authorization을 추가하고 토큰 내용을 value 부분에 넣는다.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;요청이 올바르면 앞서 살펴본 &lt;code&gt;즉시 지급 테스트&lt;/code&gt;와 유사한 결과를 얻을 수 있다.&lt;/p&gt;

&lt;h2 id=&quot;맺음말&quot;&gt;맺음말&lt;/h2&gt;

&lt;p&gt;아직 관리자 도구가 없어서 운영까지는 불가능하지만 어쨌든 Wendy에 쿠폰까지 제작해봤다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;쿠폰은 1차 제작 범위 안에 없었는데 만들다보니 들어갔다. 서비스~ 서비스~&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;다음 강좌는 인앱 영수증 검증부분이다. 영수증을 검증하는 부분을 제외하면 자원 지급을 그대로 사용하므로 비교적 간단하다.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://totuworld.github.io/2017/03/07/azureandunity-07/&quot;&gt;7강 바로가기&lt;/a&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;참고자료&quot;&gt;참고자료&lt;/h2&gt;
&lt;p&gt;완성된 소스코드는 아래 링크에서 다운로드받으면 된다.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/totuworld/Wendy/archive/0.0.5.zip&quot;&gt;Wendy 6강 완료 버전&lt;/a&gt;&lt;/p&gt;
</description>
            <pubDate>Tue, 21 Feb 2017 04:01:00 +0900</pubDate>
            <link>http://totuworld.github.io/2017/02/21/azureandunity-06/</link>
            <guid isPermaLink="true">http://totuworld.github.io/2017/02/21/azureandunity-06/</guid>
            
            
            <category>nodejs</category>
            
            <category>azure</category>
            
            <category>webapps</category>
            
            <category>unity</category>
            
        </item>
      
    
      
        <item>
            <title>이세계에 진입한 서버 개발 - 5</title>
            <description>&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#들어가는-말&quot; id=&quot;markdown-toc-들어가는-말&quot;&gt;들어가는 말&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#모델-추가&quot; id=&quot;markdown-toc-모델-추가&quot;&gt;모델 추가&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#관계-설명&quot; id=&quot;markdown-toc-관계-설명&quot;&gt;관계 설명&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#라우터-추가&quot; id=&quot;markdown-toc-라우터-추가&quot;&gt;라우터 추가&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#appjs에-등록&quot; id=&quot;markdown-toc-appjs에-등록&quot;&gt;app.js에 등록&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#로직-작성&quot; id=&quot;markdown-toc-로직-작성&quot;&gt;로직 작성&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#보유-아이템-목록-요청&quot; id=&quot;markdown-toc-보유-아이템-목록-요청&quot;&gt;보유 아이템 목록 요청&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#아이템-정보-목록-요청&quot; id=&quot;markdown-toc-아이템-정보-목록-요청&quot;&gt;아이템 정보 목록 요청&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#강화-관련-데이터-요청&quot; id=&quot;markdown-toc-강화-관련-데이터-요청&quot;&gt;강화 관련 데이터 요청&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#승급-관련-데이터-요청&quot; id=&quot;markdown-toc-승급-관련-데이터-요청&quot;&gt;승급 관련 데이터 요청&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#강화-요청&quot; id=&quot;markdown-toc-강화-요청&quot;&gt;강화 요청&lt;/a&gt;        &lt;ul&gt;
          &lt;li&gt;&lt;a href=&quot;#공통-사용-로직-추가&quot; id=&quot;markdown-toc-공통-사용-로직-추가&quot;&gt;공통 사용 로직 추가&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=&quot;#강화-요청-등록&quot; id=&quot;markdown-toc-강화-요청-등록&quot;&gt;강화 요청 등록&lt;/a&gt;&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#승급-요청&quot; id=&quot;markdown-toc-승급-요청&quot;&gt;승급 요청&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#에러코드-추가&quot; id=&quot;markdown-toc-에러코드-추가&quot;&gt;에러코드 추가&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#테스트&quot; id=&quot;markdown-toc-테스트&quot;&gt;테스트&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#정의된-아이템-추가&quot; id=&quot;markdown-toc-정의된-아이템-추가&quot;&gt;정의된 아이템 추가&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#강화-관련-데이터-입력&quot; id=&quot;markdown-toc-강화-관련-데이터-입력&quot;&gt;강화 관련 데이터 입력&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#승급-관련-데이터-입력&quot; id=&quot;markdown-toc-승급-관련-데이터-입력&quot;&gt;승급 관련 데이터 입력&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#정의된-아이템-수정&quot; id=&quot;markdown-toc-정의된-아이템-수정&quot;&gt;정의된 아이템 수정&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#보유한-아이템-추가&quot; id=&quot;markdown-toc-보유한-아이템-추가&quot;&gt;보유한 아이템 추가&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#postman으로-테스트&quot; id=&quot;markdown-toc-postman으로-테스트&quot;&gt;postman으로 테스트&lt;/a&gt;        &lt;ul&gt;
          &lt;li&gt;&lt;a href=&quot;#강화-요청-테스트&quot; id=&quot;markdown-toc-강화-요청-테스트&quot;&gt;강화 요청 테스트&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=&quot;#승급-요청-테스트&quot; id=&quot;markdown-toc-승급-요청-테스트&quot;&gt;승급 요청 테스트&lt;/a&gt;&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#맺음말&quot; id=&quot;markdown-toc-맺음말&quot;&gt;맺음말&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#참고자료&quot; id=&quot;markdown-toc-참고자료&quot;&gt;참고자료&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;iframe width=&quot;560&quot; height=&quot;315&quot; src=&quot;https://www.youtube.com/embed/KVK4JgeWe6c&quot; frameborder=&quot;0&quot; allowfullscreen=&quot;&quot;&gt;&lt;/iframe&gt;

&lt;h2 id=&quot;들어가는-말&quot;&gt;들어가는 말&lt;/h2&gt;
&lt;p&gt;퍼즐 게임이 아니라면 게임 내에서 아이템은 그 종류가 정말 다양하다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;요즘은 퍼즐 게임도 특수 아이템을 제공하거나 구매할 수 있는 것도 많다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;게임 클라이언트에서는 특수 능력을 발휘하거나 체력을 채워줄 수도 있고, 9강 검이 될 수도 있다.&lt;/p&gt;

&lt;p&gt;하지만 게임 서버안에서는 보유와 강화 등의 정보만 기록하면 된다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;MORPG 게임 서버를 만드는게 아니니까 다른건 모른다(?)&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;이번 강좌에서는 아이템 보유와 강화, 승급 기능을 제작해도보도록 하겠다.&lt;/p&gt;

&lt;h2 id=&quot;모델-추가&quot;&gt;모델 추가&lt;/h2&gt;
&lt;p&gt;기본이 되는 것은 아래 2개이다. 아이템 정의와 아이템 보유 모델.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;models&lt;/code&gt; 폴더에 파일을 추가하고 각각 아래 내용을 적용한다.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://raw.githubusercontent.com/totuworld/Wendy/tuto5.3/models/DefineItem.js&quot;&gt;DefineItem.js&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://raw.githubusercontent.com/totuworld/Wendy/tuto5.3/models/OwnItem.js&quot;&gt;OwnItem.js&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;그리고 부수적으로 아래 4개의 모델을 추가한다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;강화와 승급을 설명할 때 추가하려고 했으나 미리 추가해놓는게 편해서 일단 모두 등록한다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://raw.githubusercontent.com/totuworld/Wendy/tuto5.3/models/DefineReinforceItem.js&quot;&gt;DefineReinforceItem.js&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://raw.githubusercontent.com/totuworld/Wendy/tuto5.3/models/DefineReinforceRequireItem.js&quot;&gt;DefineReinforceRequireItem.js&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://raw.githubusercontent.com/totuworld/Wendy/tuto5.3/models/DefineUpgradeItem.js&quot;&gt;DefineUpgradeItem.js&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://raw.githubusercontent.com/totuworld/Wendy/tuto5.3/models/DefineUpgradeRequireItem.js&quot;&gt;DefineUpgradeRequireItem.js&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;각각 클릭해서 models 폴더에 추가한다.&lt;/p&gt;

&lt;h3 id=&quot;관계-설명&quot;&gt;관계 설명&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;와 이렇게 뭐 없이 설명하니까 되게 좋네!!&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;img src=&quot;/images/15940e9cd6ba5ee6.jpg&quot; alt=&quot;오예&quot; /&gt;&lt;/p&gt;

&lt;p&gt;너무 설명이 없는 듯하니까 각 모델간의 관계를 설명해보겠다.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/rvwendy05_m01.png&quot; alt=&quot;아이템다이어그램&quot; width=&quot;500px&quot; /&gt;&lt;/p&gt;

&lt;p&gt;추가 모델을 제거하면 기본은 &lt;code&gt;OwnItem&lt;/code&gt;과 &lt;code&gt;DefineItem&lt;/code&gt;이다.&lt;/p&gt;

&lt;p&gt;이 중 &lt;code&gt;DefineItem&lt;/code&gt;은 강화와 승급을 위해 &lt;code&gt;ReinforceItemID&lt;/code&gt;과 &lt;code&gt;UpgradeItemID&lt;/code&gt;를 가질 수 있다.&lt;/p&gt;

&lt;p&gt;각각의 외래키는 &lt;code&gt;Define__RequireItem&lt;/code&gt;으로 이어지고 여기서는 1개의 &lt;code&gt;__ItemID&lt;/code&gt;로 다수의 아이템이 필요하다는 정보를 저장하게 된다.&lt;/p&gt;

&lt;p&gt;왜 이런 구조를 가지냐면 어떤 경우는 골드만 사용하고 싶을 수 있지만 어떤 경우는 골드와 특정 아이템을 함께 소모해서 다음으로 넘기기 위한 방법이다.&lt;/p&gt;

&lt;p&gt;다만 이런 처리로는 경험치를 쌓아서 강화하는 형태는 불가능하다.&lt;/p&gt;

&lt;p&gt;이런 구조를 원한다면 별도의 테이블을 구상해야할 것이다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;좋은 고민거리죠?!&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;라우터-추가&quot;&gt;라우터 추가&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;routes&lt;/code&gt;폴더에 &lt;code&gt;item.js&lt;/code&gt;파일을 추가하고 아래 내용을 적용한다.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://raw.githubusercontent.com/totuworld/Wendy/tuto5.1/routes/item.js&quot;&gt;item.js&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;appjs에-등록&quot;&gt;app.js에 등록&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;app.js&lt;/code&gt; 파일을 수정하여 item 라우터를 추가해보자.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;code&gt;app.js&lt;/code&gt;에서 아래 내용을 찾아서 그 아래쪽에 코드를 추가한다.&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;
        &lt;p&gt;찾아야하는 내용&lt;/p&gt;

        &lt;pre&gt;&lt;code&gt;  const routes = require(&#39;./routes/index&#39;);
&lt;/code&gt;&lt;/pre&gt;
      &lt;/li&gt;
      &lt;li&gt;
        &lt;p&gt;추가할 코드&lt;/p&gt;

        &lt;pre&gt;&lt;code&gt;  const item = require(&#39;./routes/item&#39;);
&lt;/code&gt;&lt;/pre&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;code&gt;app.js&lt;/code&gt;에서 아래 내용을 찾아서 그 아래쪽에 코드를 추가한다.&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;
        &lt;p&gt;찾아야하는 내용&lt;/p&gt;

        &lt;pre&gt;&lt;code&gt;  app.use(&#39;/&#39;, routes);
&lt;/code&gt;&lt;/pre&gt;
      &lt;/li&gt;
      &lt;li&gt;
        &lt;p&gt;추가할 코드&lt;/p&gt;

        &lt;pre&gt;&lt;code&gt;  app.use(&#39;/item&#39;, item);
&lt;/code&gt;&lt;/pre&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;blockquote&gt;
  &lt;p&gt;몇번 해본 작업이라서 손이 알아서 처리하고 있을것이다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;로직-작성&quot;&gt;로직 작성&lt;/h2&gt;
&lt;p&gt;로직은 총 6개를 추가할 것인데 그중 4개는 정보를 요청하는 것이고 2개는 강화, 승급을 각각 처리하는 것이다.&lt;/p&gt;

&lt;p&gt;통화를 기억해보면 단순히 정보를 요청하는 코드는 단순하다&lt;/p&gt;

&lt;p&gt;routes/item.js에 다음 코드를 추가한다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;자주 해봐서 알겠지만 modules.export = router; 위쪽에 추가하면 된다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;보유-아이템-목록-요청&quot;&gt;보유 아이템 목록 요청&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;/**
 * @api {GET} /item/own
 * @apiName 보유 아이템 목록 요청
 * @apiHeader {String} Authorization JWT토큰을 전송
 */
router.get(&#39;/own&#39;, auth.isAuthenticated, (req, res, next) =&amp;gt; {
    models.OwnItem.findAll({
        where: { GameUserID: req.user.GameUserID }
    })
    .then((ownItemList) =&amp;gt; {
        res.send({ result: 0, list: ownItemList });
    })
    .catch((err) =&amp;gt; {
        next(err);
    });
})


&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;아이템-정보-목록-요청&quot;&gt;아이템 정보 목록 요청&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;/**
 * @api {GET} /item/define
 * @apiName 정의된 아이템 정보 요청
 * @apiHeader {String} Authorization JWT토큰을 전송
 */
router.get(&#39;/define&#39;, auth.isAuthenticated, (req, res, next)=&amp;gt;{
    models.DefineItem.findAll()
    .then((DefineItemList) =&amp;gt; {
        res.send({ result: 0, list: DefineItemList });
    })
    .catch((err) =&amp;gt; {
        next(err);
    });
})


&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;강화-관련-데이터-요청&quot;&gt;강화 관련 데이터 요청&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;
/**
 * @api {GET} /item/define/reinforce
 * @apiName 강화 관련 아이템 데이터 조회
 * @apiHeader {String} Authorization JWT토큰을 전송
 */
router.get(&#39;/define/reinforce&#39;, auth.isAuthenticated, (req, res, next)=&amp;gt;{
    models.DefineReinforceItem.findAll({
        include: [{
            model: models.DefineReinforceRequireItem,
            as: &#39;LevelInfo&#39;
        }]
    })
    .then((defineReinforceItem)=&amp;gt;{
        res.send({result:0, list:defineReinforceItem});
    })
})


&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;승급-관련-데이터-요청&quot;&gt;승급 관련 데이터 요청&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;/**
 * @api {GET} /item/define/upgrade
 * @apiName 승급 관련 아이템 데이터 조회
 * @apiHeader {String} Authorization JWT토큰을 전송
 */
router.get(&#39;/define/upgrade&#39;, auth.isAuthenticated, (req, res, next)=&amp;gt;{
    models.DefineUpgradeItem.findAll({
        include: [{
            model: models.DefineUpgradeRequireItem,
            as: &#39;UpgradeInfo&#39;
        }]
    })
    .then((defineUpgradeItem)=&amp;gt;{
        res.send({result:0, list:defineUpgradeItem});
    })
})

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;정의된 데이터를 요청하는 것은 이처럼 간단하다.&lt;/p&gt;

&lt;h3 id=&quot;강화-요청&quot;&gt;강화 요청&lt;/h3&gt;
&lt;p&gt;강화와 승급의 로직은 기본은 같다.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;Define__RequireItem&lt;/code&gt;에 등록된 &lt;code&gt;ItemID&lt;/code&gt;가 &lt;code&gt;RequireQNTY&lt;/code&gt;만큼 보유했으면 아이템을 소모시키고 해당 레벨이나 등급을 올리면 된다.&lt;/p&gt;

&lt;h4 id=&quot;공통-사용-로직-추가&quot;&gt;공통 사용 로직 추가&lt;/h4&gt;

&lt;p&gt;자원 - 아이템, 통화를 통합하여 지칭 - 이 충분하지 체크하거나 소모시키는 일은 자주 일어날 수 있다.&lt;/p&gt;

&lt;p&gt;이런 내용은 따로 관리하는게 편리하므로 &lt;code&gt;logics&lt;/code&gt;폴더에 &lt;code&gt;materialCtrl.js&lt;/code&gt;파일을 추가하고 아래 링크의 내용을 반영한다.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://raw.githubusercontent.com/totuworld/Wendy/tuto5.2/logics/materialCtrl.js&quot;&gt;materialCtrl.js&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;그리고 &lt;code&gt;routes/item.js&lt;/code&gt; 파일에서 아래 부분을 찾아서 필요한 내용을 추가한다.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;찾아야하는 내용&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt;    const wendyError = require(&#39;../utils/error&#39;);
&lt;/code&gt;&lt;/pre&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;추가할 내용&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt;    const materialCtrl = require(&#39;../logics/materialCtrl&#39;);
&lt;/code&gt;&lt;/pre&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&quot;강화-요청-등록&quot;&gt;강화 요청 등록&lt;/h4&gt;

&lt;p&gt;앞서 말한 로직을 바탕으로 내용을 추가해보자.&lt;/p&gt;

&lt;p&gt;먼저 사용할 메서드 3개를 등록한다.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;LoadOwnItem&lt;/li&gt;
  &lt;li&gt;LoadDefineItem&lt;/li&gt;
  &lt;li&gt;DecoretorMaterials&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;2개 메서드는 보유 아이템과 아이템 정의 관련 데이터를 로딩할 때 사용된다.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;DecoretorMaterials&lt;/code&gt;은 소모할 아이템 및 통화를 검증하거나 소모할 때 상용된다. fn 매개변수로 메서드를 전달하면 실행한다.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;function LoadOwnItem(OwnItemUID, GameUserID) {
    //소유 아이템 조회
    return models.OwnItem.findOne(
        {where:
            {
                OwnItemUID: OwnItemUID, 
                GameUserID: GameUserID
            }
        })
    .then((ownItem)=&amp;gt;{
        //아이템이 존재하는지 체크
        if(ownItem === null || ownItem === undefined)
            throw wendyError(&#39;NotInOwnItemList&#39;);
        return Promise.resolve(ownItem);
    })
}

function LoadDefineItem(
    ItemID, 
    ColumnName=&#39;ReinforceItemID&#39;, 
    errType=&#39;CantReinfoceItem&#39;) {
    //아이템 정보 로딩
    return models.DefineItem.findOne({
                where:{
                    ItemID:ItemID
                }
            })
    .then((itemInfo)=&amp;gt;{
        if(itemInfo[ColumnName] === null)
            throw wendyError(errType);
        return Promise.resolve(itemInfo);
    })
}

/**
 * 소모할 아이템 및 통화를 fn에 따라서 검증 및 소모.
 * @param {function} fn 실행할 메서드
 * materialCtrl의 existEnoughMaterial, decrementMaterial을 사용
 */
function DecoretorMaterials(
    fn, 
    LoadInfos, GameUserID, 
    materialItemUID, materialCurrencyUID) {

    let promises = [];
    LoadInfos.forEach((value, key)=&amp;gt;{
        promises.push(
            fn(
                GameUserID,
                value.ItemID,
                value.RequireQNTY,
                value.DefineItem.ItemType===10
                    ?materialItemUID
                    :materialCurrencyUID)
        );
    })

    if(promises.length &amp;gt; 0)
        return Promise.all(promises);
    return Promise.resolve();
}


&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;위 메서드를 활용해서 실제 로직을 추가한다.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;/**
 * @api {POST} /item/reinforce/:OwnItemUID
 * @apiName 강화 요청
 * @apiHeader {String} Authorization JWT토큰을 전송
 * @apiParam {Array} materialItemUID 소모할 ItemUID
 * @apiParam {Array} materialCurrencyUID 소모할 CurrencyUID
 */
router.post(&#39;/reinforce/:OwnItemUID&#39;, auth.isAuthenticated, (req, res, next)=&amp;gt;{

    let checkRequestBody = commonFunc.ObjectExistThatKeys(
            req.body, 
            [&#39;materialItemUID&#39;, &#39;materialCurrencyUID&#39;]);
    if(checkRequestBody === false) {
        throw wendyError(&#39;DontHaveRequiredParams&#39;);
    }

    let loadItems = { 
        targetItem : null,
        targetItemInfo : null,
        LoadInfos : new Map()
    };

    //보유 아이템 로딩
    LoadOwnItem(
        req.params.OwnItemUID, 
        req.user.GameUserID)
    .then((OwnItem)=&amp;gt;{
        loadItems.targetItem = OwnItem;
        return Promise.resolve();
    })
    //아이템 정보 로딩
    .then(()=&amp;gt;{
        return LoadDefineItem(
            loadItems.targetItem.ItemID
        );
    })
    .then((itemInfo)=&amp;gt;{
        loadItems.targetItemInfo = itemInfo;
        return Promise.resolve();
    })
    //강화 데이터 로딩.
    .then(()=&amp;gt;{
        return  models.DefineReinforceItem.findOne({
            where:{
                ReinforceItemID:
                    loadItems.targetItemInfo[&#39;ReinforceItemID&#39;]
            },
            include: [{
                model: models[&#39;DefineReinforceRequireItem&#39;],
                as: &#39;LevelInfo&#39;,
                include: [{
                    model: models.DefineItem,
                    attributes : [&#39;ItemType&#39;, &#39;Multiple&#39;]
                }]
            }]
        })
    })
    .then((reinfoceInfos)=&amp;gt;{

        //강화에 사용되는 아이템이 정의되었는가?
        if(reinfoceInfos.LevelInfo.length === 0) 
            throw wendyError(&#39;DidntRegisterReinfoceRequireItem&#39;);

        //Level로 정렬.
        reinfoceInfos.LevelInfo.sort((a,b)=&amp;gt;{
            return a.Level - b.Level;
        })

        //다음 레벨로 강화가 가능한지 확인?
        let possibleLevelUp = false;
        for(let row of reinfoceInfos.LevelInfo) {
            if(row[&#39;Level&#39;] === loadItems.targetItem[&#39;Level&#39;]) {
                possibleLevelUp = true;
                loadItems.LoadInfos.set(row.ItemID, row);
            }
        }
        if(possibleLevelUp === false)
            throw wendyError(&#39;NoLongerReinforce&#39;)

        return Promise.resolve();
    })
    //아이템과 통화를 충분한 량 보유했는지 체크.
    .then(()=&amp;gt;{
        return DecoretorMaterials(
            materialCtrl.existEnoughMaterial,
            loadItems.LoadInfos,
            req.user.GameUserID,
            req.body.materialItemUID,
            req.body.materialCurrencyUID
        );
    })
    //아이템 및 통화, 삭제 혹은 차감처리
    .then(()=&amp;gt;{
        return DecoretorMaterials(
            materialCtrl.decrementMaterial,
            loadItems.LoadInfos,
            req.user.GameUserID,
            req.body.materialItemUID,
            req.body.materialCurrencyUID
        );
    })
    //강화로 레벨업 반영.
    .then(()=&amp;gt;{
        return models.OwnItem.update({
            Level:loadItems.targetItem[&#39;Level&#39;]+1,
            UpdateTimeStamp: new Date()
        },
        {where:{
            OwnItemUID:loadItems.targetItem.OwnItemUID
        }});
    })
    .then(()=&amp;gt;{
        res.send({result:0});
    })
    .catch((err)=&amp;gt;{
        next(err);
    })
})


&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
  &lt;li&gt;24~57번 줄 : 보유 아이템과 아이템 정보를 로딩한다.&lt;/li&gt;
  &lt;li&gt;58~81번 줄 : 강화를 진행하기에 적합한지 데이터를 검증한다.&lt;/li&gt;
  &lt;li&gt;83~101번 줄 : &lt;code&gt;DecoretorMaterials&lt;/code&gt; 메서드에 사용할 전달하여 충분한 자원을 보유했는지 확인하고 각각 소모한다.&lt;/li&gt;
  &lt;li&gt;103~110 줄 : 레벨을 증가시켜 기록한다.&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;승급-요청&quot;&gt;승급 요청&lt;/h3&gt;
&lt;p&gt;앞서 살펴본 강화 요청과 승급은 거의 비슷하다.&lt;/p&gt;

&lt;p&gt;다른점이라면 불러야하는 테이블이 다르고 에러 코드가 다르다는 것 정도다.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;/**
 * @api {POST} /item/upgrade/:OwnItemUID
 * @apiName 승급 요청
 * @apiHeader {String} Authorization JWT토큰을 전송
 * @apiParam {Array} materialItemUID 소모할 ItemUID
 * @apiParam {Array} materialCurrencyUID 소모할 CurrencyUID
 */
router.post(&#39;/upgrade/:OwnItemUID&#39;, auth.isAuthenticated, (req, res, next)=&amp;gt;{

    let checkRequestBody = commonFunc.ObjectExistThatKeys(
            req.body, 
            [&#39;materialItemUID&#39;, &#39;materialCurrencyUID&#39;]);
    if(checkRequestBody === false) {
        throw wendyError(&#39;DontHaveRequiredParams&#39;);
    }

    let loadItems = { 
        targetItem : null,
        targetItemInfo : null,
        LoadInfos : new Map()
    };

    //보유 아이템 로딩
    LoadOwnItem(
        req.params.OwnItemUID, 
        req.user.GameUserID)
    .then((OwnItem)=&amp;gt;{
        loadItems.targetItem = OwnItem;
        return Promise.resolve();
    })
    //아이템 정보 로딩
    .then(()=&amp;gt;{
        return LoadDefineItem(
            loadItems.targetItem.ItemID,
            &#39;UpgradeItemID&#39;,
            &#39;CantUpgradeItem&#39;
        );
    })
    .then((itemInfo)=&amp;gt;{
        loadItems.targetItemInfo = itemInfo;
        return Promise.resolve();
    })
    //승급 데이터 로딩.
    .then(()=&amp;gt;{
        return  models.DefineUpgradeItem.findOne({
            where:{
                UpgradeItemID:
                    loadItems.targetItemInfo[&#39;UpgradeItemID&#39;]
            },
            include: [{
                model: models[&#39;DefineUpgradeRequireItem&#39;],
                as: &#39;UpgradeInfo&#39;,
                include: [{
                    model: models.DefineItem,
                    attributes : [&#39;ItemType&#39;, &#39;Multiple&#39;]
                }]
            }]
        })
    })
    .then((upgradeInfos)=&amp;gt;{

        //승급에 사용되는 아이템이 정의되었는가?
        if(upgradeInfos.UpgradeInfo.length === 0) 
            throw wendyError(&#39;DidntRegisterUpgradeRequireItem&#39;);

        //Tier로 정렬.
        upgradeInfos.UpgradeInfo.sort((a,b)=&amp;gt;{
            return a.Tier - b.Tier;
        })

        //다음 Tier로 승급이 가능한지 확인?
        let possibleUpgrade = false;
        for(let row of upgradeInfos.UpgradeInfo) {
            if(row[&#39;Tier&#39;] === loadItems.targetItem[&#39;Tier&#39;]) {
                possibleUpgrade = true;
                loadItems.LoadInfos.set(row.ItemID, row);
            }
        }
        if(possibleUpgrade === false)
            throw wendyError(&#39;NoLongerUpgrade&#39;)

        return Promise.resolve();
    })
    //아이템과 통화를 충분한 량 보유했는지 체크.
    .then(()=&amp;gt;{
        return DecoretorMaterials(
            materialCtrl.existEnoughMaterial,
            loadItems.LoadInfos,
            req.user.GameUserID,
            req.body.materialItemUID,
            req.body.materialCurrencyUID
        );
    })
    //아이템 및 통화, 삭제 혹은 차감처리
    .then(()=&amp;gt;{
        return DecoretorMaterials(
            materialCtrl.decrementMaterial,
            loadItems.LoadInfos,
            req.user.GameUserID,
            req.body.materialItemUID,
            req.body.materialCurrencyUID
        );
    })
    //승급으로 Tier 반영.
    .then(()=&amp;gt;{
        return models.OwnItem.update({
            Tier:loadItems.targetItem[&#39;Tier&#39;]+1,
            UpdateTimeStamp: new Date()
        },
        {where:{
            OwnItemUID:loadItems.targetItem.OwnItemUID
        }});
    })
    .then(()=&amp;gt;{
        res.send({result:0});
    })
    .catch((err)=&amp;gt;{
        next(err);
    })
})

&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&quot;에러코드-추가&quot;&gt;에러코드 추가&lt;/h2&gt;

&lt;p&gt;아이템과 관련한 공통 에러가 3개, 강화와 승급에 각각 3개의 에러코드가 추가된다.&lt;/p&gt;

&lt;p&gt;앞서 사용하도록 코드를 작성했으므로 &lt;code&gt;utils/error.js&lt;/code&gt;에 필요한 에러코드를 추가하도록 한다.&lt;/p&gt;

&lt;p&gt;먼저 아래 9개 클래스를 등록한다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;다른 클래스가 등록된 것을 참고하여 붙여넣으면 된다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;NotInOwnItemList&lt;/li&gt;
  &lt;li&gt;MaterialDoesNotExistOwnItemList&lt;/li&gt;
  &lt;li&gt;NotEnoughItem&lt;/li&gt;
  &lt;li&gt;CantReinfoceItem&lt;/li&gt;
  &lt;li&gt;DidntRegisterReinfoceRequireItem&lt;/li&gt;
  &lt;li&gt;NoLongerReinforce&lt;/li&gt;
  &lt;li&gt;CantUpgradeItem&lt;/li&gt;
  &lt;li&gt;DidntRegisterUpgradeRequireItem&lt;/li&gt;
  &lt;li&gt;NoLongerUpgrade&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;/** 80501 */
class NotInOwnItemList extends CustomError {
    constructor() {
        let message = &#39;보유한 아이템 중에 해당 아이템이 없다.&#39;;
        let code = 80501;
        super(message, code);
    }
}

/** 80502 */
class MaterialDoesNotExistOwnItemList extends CustomError {
    constructor() {
        let message = &#39;보유한 아이템 중에 재료로 사용할 아이템이 없다.&#39;;
        let code = 80502;
        super(message, code);
    }
}

/** 80503 */
class NotEnoughItem extends CustomError {
    constructor() {
        let message = &#39;해당 아이템이 충분하지 않다.&#39;;
        let code = 80503;
        super(message, code);
    }
}

/** 80511 */
class CantReinfoceItem extends CustomError {
    constructor() {
        let message = &#39;강화가 불가능한 아이템&#39;;
        let code = 80511;
        super(message, code);
    }
}

/** 80512 */
class DidntRegisterReinfoceRequireItem extends CustomError {
    constructor() {
        let message = &#39;강화에 필요한 아이템이 등록하지 않았다&#39;;
        let code = 80512;
        super(message, code);
    }
}

/** 80513 */
class NoLongerReinforce extends CustomError {
    constructor() {
        let message = &#39;더 이상 강화되지 않는다(최대레벨도달)&#39;;
        let code = 80513;
        super(message, code);
    }
}

/** 80521 */
class CantUpgradeItem extends CustomError {
    constructor() {
        let message = &#39;승급이 불가능한 아이템&#39;;
        let code = 80521;
        super(message, code);
    }
}

/** 80522 */
class DidntRegisterUpgradeRequireItem extends CustomError {
    constructor() {
        let message = &#39;승급에 필요한 아이템이 등록하지 않았다&#39;;
        let code = 80522;
        super(message, code);
    }
}

/** 80523 */
class NoLongerUpgrade extends CustomError {
    constructor() {
        let message = &#39;더 이상 승급이 불가능(최대 등급 도달)&#39;;
        let code = 80523;
        super(message, code);
    }
}


&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;9개 클래스를 모두 등록했으면 다음 부분을 찾아서 아래와 같이 수정한다.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;찾아야하는 내용&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt;&quot;NickNameToLongOrShot&quot;:NickNameToLongOrShot
&lt;/code&gt;&lt;/pre&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;변경할 내용&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;&quot;NickNameToLongOrShot&quot;:NickNameToLongOrShot,

&quot;NotInOwnItemList&quot;:NotInOwnItemList,
&quot;MaterialDoesNotExistOwnItemList&quot;:MaterialDoesNotExistOwnItemList,
&quot;NotEnoughItem&quot;:NotEnoughItem,

&quot;CantReinfoceItem&quot;:CantReinfoceItem,
&quot;DidntRegisterReinfoceRequireItem&quot;:DidntRegisterReinfoceRequireItem,
&quot;NoLongerReinforce&quot;:NoLongerReinforce,

&quot;CantUpgradeItem&quot;:CantUpgradeItem,
&quot;DidntRegisterUpgradeRequireItem&quot;:DidntRegisterUpgradeRequireItem,
&quot;NoLongerUpgrade&quot;:NoLongerUpgrade

&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&quot;테스트&quot;&gt;테스트&lt;/h2&gt;
&lt;p&gt;아이템을 몇개 등록하고 강화와 승급도 진행해보자.&lt;/p&gt;

&lt;h3 id=&quot;정의된-아이템-추가&quot;&gt;정의된 아이템 추가&lt;/h3&gt;

&lt;p&gt;&lt;code&gt;DefineItem&lt;/code&gt; 테이블에 데이터를 입력한다.&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;ItemID&lt;/th&gt;
      &lt;th&gt;ItemType&lt;/th&gt;
      &lt;th&gt;Name&lt;/th&gt;
      &lt;th&gt;Multiple&lt;/th&gt;
      &lt;th&gt;MaxQNTY&lt;/th&gt;
      &lt;th&gt;ReinforceItemID&lt;/th&gt;
      &lt;th&gt;UpgradeItemID&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;101&lt;/td&gt;
      &lt;td&gt;10&lt;/td&gt;
      &lt;td&gt;key&lt;/td&gt;
      &lt;td&gt;1&lt;/td&gt;
      &lt;td&gt;500&lt;/td&gt;
      &lt;td&gt;NULL&lt;/td&gt;
      &lt;td&gt;NULL&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;102&lt;/td&gt;
      &lt;td&gt;10&lt;/td&gt;
      &lt;td&gt;gem&lt;/td&gt;
      &lt;td&gt;1&lt;/td&gt;
      &lt;td&gt;900000&lt;/td&gt;
      &lt;td&gt;NULL&lt;/td&gt;
      &lt;td&gt;NULL&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;103&lt;/td&gt;
      &lt;td&gt;10&lt;/td&gt;
      &lt;td&gt;gold&lt;/td&gt;
      &lt;td&gt;1&lt;/td&gt;
      &lt;td&gt;900000&lt;/td&gt;
      &lt;td&gt;NULL&lt;/td&gt;
      &lt;td&gt;NULL&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;2001&lt;/td&gt;
      &lt;td&gt;1&lt;/td&gt;
      &lt;td&gt;sward&lt;/td&gt;
      &lt;td&gt;0&lt;/td&gt;
      &lt;td&gt;1&lt;/td&gt;
      &lt;td&gt;NULL&lt;/td&gt;
      &lt;td&gt;NULL&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;blockquote&gt;
  &lt;p&gt;ItemType 10은 통화를 지칭하기로 약속한다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;모든 길은 아이템으로 통해야 추후 관리가 쉽다. 그래서 통화도 아이템으로 등록한다.&lt;/p&gt;

&lt;p&gt;다만 통화는 Currency에서 별도 관리는 것이라고 생각하면 된다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;materialCtrl.js 파일을 보면 공통 요청을 하지만 ItemType에 따라 적용하는 메서드가 달라지는 것을 볼 수 있다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;2001번 아이템은 현재는 강화와 승급이 불가능하다. 강화 승급에 관련한 데이터를 추가로 등록하자.&lt;/p&gt;

&lt;h3 id=&quot;강화-관련-데이터-입력&quot;&gt;강화 관련 데이터 입력&lt;/h3&gt;
&lt;p&gt;아이템 강화와 관련된 테이블은 2개다.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;DefineReinforceItem&lt;/code&gt;과 &lt;code&gt;DefineReinforceRequireItem&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;DefineReinforceItem을 먼저 입력한다.&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;ReinforceItemID&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;2001&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;그리고 DefineReinforceRequireItem에 아래 내용을 입력한다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;소모할 아이템이 통화로 사용할 gem, gold 뿐이라서 여기서는 모두 gold로 처리한다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;table&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;id&lt;/td&gt;
      &lt;td&gt;Level&lt;/td&gt;
      &lt;td&gt;RequireQNTY&lt;/td&gt;
      &lt;td&gt;ReinforceItemID&lt;/td&gt;
      &lt;td&gt;ItemID&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;NULL&lt;/td&gt;
      &lt;td&gt;1&lt;/td&gt;
      &lt;td&gt;10&lt;/td&gt;
      &lt;td&gt;2001&lt;/td&gt;
      &lt;td&gt;103&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;NULL&lt;/td&gt;
      &lt;td&gt;2&lt;/td&gt;
      &lt;td&gt;20&lt;/td&gt;
      &lt;td&gt;2001&lt;/td&gt;
      &lt;td&gt;103&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h3 id=&quot;승급-관련-데이터-입력&quot;&gt;승급 관련 데이터 입력&lt;/h3&gt;
&lt;p&gt;승급도 강화와 마찬가지로 2개 테이블에 입력해야한다.&lt;/p&gt;

&lt;p&gt;먼저 DefineUpgradeItem을 입력한다.&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;UpgradeItemID&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;2001&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;그리고 DefineUpgradeRequireItem에 아래 내용을 입력한다.&lt;/p&gt;

&lt;table&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;id&lt;/td&gt;
      &lt;td&gt;Tier&lt;/td&gt;
      &lt;td&gt;RequireQNTY&lt;/td&gt;
      &lt;td&gt;UpgradeItemID&lt;/td&gt;
      &lt;td&gt;ItemID&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;NULL&lt;/td&gt;
      &lt;td&gt;1&lt;/td&gt;
      &lt;td&gt;100&lt;/td&gt;
      &lt;td&gt;2001&lt;/td&gt;
      &lt;td&gt;103&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;NULL&lt;/td&gt;
      &lt;td&gt;2&lt;/td&gt;
      &lt;td&gt;200&lt;/td&gt;
      &lt;td&gt;2001&lt;/td&gt;
      &lt;td&gt;103&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h3 id=&quot;정의된-아이템-수정&quot;&gt;정의된 아이템 수정&lt;/h3&gt;

&lt;p&gt;DBeaver에서 DefineItem 테이블을 선택하고 ItemID 2001 상품의 &lt;code&gt;ReinforceItemID&lt;/code&gt;와 &lt;code&gt;UpgradeItemID&lt;/code&gt;를 각각 2001로 변경한다.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;DefineItem 테이블 선택.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Data 탭에서 2001 아이템을 아래처럼 수정&lt;/p&gt;

    &lt;p&gt;&lt;img src=&quot;/images/rvwendy05_01.png&quot; alt=&quot;ReinforceItemID/UpgradeItemID변경&quot; width=&quot;500px&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;아래쪽에 &lt;code&gt;Save&lt;/code&gt;를 클릭하여 변경사항을 반영한다.&lt;/p&gt;

    &lt;p&gt;&lt;img src=&quot;/images/rvwendy03_09.png&quot; alt=&quot;save&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&quot;보유한-아이템-추가&quot;&gt;보유한 아이템 추가&lt;/h3&gt;

&lt;p&gt;1번 유저에게 2001번 아이템을 지급하자.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;OwnItem&lt;/code&gt;테이블에 아래 내용을 추가한다.&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;OwnItemUID&lt;/th&gt;
      &lt;th&gt;ItemID&lt;/th&gt;
      &lt;th&gt;CurrentQNTY&lt;/th&gt;
      &lt;th&gt;Level&lt;/th&gt;
      &lt;th&gt;Tier&lt;/th&gt;
      &lt;th&gt;UpdateTimeStamp&lt;/th&gt;
      &lt;th&gt;GameUserID&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;NULL&lt;/td&gt;
      &lt;td&gt;2001&lt;/td&gt;
      &lt;td&gt;1&lt;/td&gt;
      &lt;td&gt;1&lt;/td&gt;
      &lt;td&gt;1&lt;/td&gt;
      &lt;td&gt;2017-01-01&lt;/td&gt;
      &lt;td&gt;1&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h3 id=&quot;postman으로-테스트&quot;&gt;postman으로 테스트&lt;/h3&gt;

&lt;p&gt;postman을 실행하고 토큰을 획득한 다음 아래처럼 요청을 해보자.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;데이터를 로딩하는 4개 API는 테스트하지 않는다. 여기서는 강화와 승급만 다루겠다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h4 id=&quot;강화-요청-테스트&quot;&gt;강화 요청 테스트&lt;/h4&gt;

&lt;ul&gt;
  &lt;li&gt;패스 : POST&lt;/li&gt;
  &lt;li&gt;URL : localhost:3000/item/reinforce/1&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;위 URL에서 가장 뒷 부분은 &lt;code&gt;OwnItemUID&lt;/code&gt;이다. 자신의 테이블을 확인해보고 OwnItemUID가 필자와 다르다면 자신의 값을 넣어야한다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Headers : Authorization을 추가하고 토큰 내용을 value 부분에 넣는다.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;body : 아래 내용을 넣는다.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-json&quot;&gt;{
    &quot;materialItemUID&quot;:[],
    &quot;materialCurrencyUID&quot;:[3]
}
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;code&gt;materialCurrencyUID&lt;/code&gt;에는 OwnCurrency 등록된 소모할 OwnCurrencyUID를 넣는다. CurrencyID 103가 등록된 OwnCurrencyUID를 넣어줘야 정상 동작한다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;성공하면 다음 내용을 수신한다.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;{
  &quot;result&quot;: 0
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;DBeaver에서 &lt;code&gt;OwnItem&lt;/code&gt; 테이블의 Data탭에서 &lt;code&gt;새로고침&lt;/code&gt;버튼을 클릭하면 Level이 2로 반영된 것을 확인할 수 있다.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/rvwendy05_02.png&quot; alt=&quot;Dbeaver새로고침&quot; width=&quot;500px&quot; /&gt;&lt;/p&gt;

&lt;h4 id=&quot;승급-요청-테스트&quot;&gt;승급 요청 테스트&lt;/h4&gt;

&lt;ul&gt;
  &lt;li&gt;패스 : POST&lt;/li&gt;
  &lt;li&gt;URL : localhost:3000/item/upgrade/1&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;위 URL에서 가장 뒷 부분은 &lt;code&gt;OwnItemUID&lt;/code&gt;이다. 자신의 테이블을 확인해보고 OwnItemUID가 필자와 다르다면 자신의 값을 넣어야한다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Headers : Authorization을 추가하고 토큰 내용을 value 부분에 넣는다.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;body : 아래 내용을 넣는다.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-json&quot;&gt;{
    &quot;materialItemUID&quot;:[],
    &quot;materialCurrencyUID&quot;:[3]
}
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;code&gt;materialCurrencyUID&lt;/code&gt;에는 OwnCurrency 등록된 소모할 OwnCurrencyUID를 넣는다. CurrencyID 103가 등록된 OwnCurrencyUID를 넣어줘야 정상 동작한다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;성공하면 다음 내용을 수신한다.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;{
  &quot;result&quot;: 0
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;DBeaver에서 &lt;code&gt;OwnItem&lt;/code&gt; 테이블의 Data탭에서 &lt;code&gt;새로고침&lt;/code&gt;버튼을 클릭하면 Tier이 2로 반영된 것을 확인할 수 있다.&lt;/p&gt;

&lt;h2 id=&quot;맺음말&quot;&gt;맺음말&lt;/h2&gt;

&lt;p&gt;아이템까지 어찌어찌 왔으니 자원에 영향을 주는 기능을 만들 때 필요한 기반이 되었다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;인앱 영수증 검증, 쿠폰, 메시지, 상점, 가챠 등&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;다음 강좌에서 지급 기능을 만들고 차차 진행해보도록 하자.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://totuworld.github.io/2017/02/21/azureandunity-06/&quot;&gt;6강 바로가기&lt;/a&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;참고자료&quot;&gt;참고자료&lt;/h2&gt;
&lt;p&gt;완성된 소스코드는 아래 링크에서 다운로드받으면 된다.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/totuworld/Wendy/archive/0.0.4.zip&quot;&gt;Wendy 5강 완료 버전&lt;/a&gt;&lt;/p&gt;
</description>
            <pubDate>Thu, 09 Feb 2017 04:00:00 +0900</pubDate>
            <link>http://totuworld.github.io/2017/02/09/azureandunity-05/</link>
            <guid isPermaLink="true">http://totuworld.github.io/2017/02/09/azureandunity-05/</guid>
            
            
            <category>nodejs</category>
            
            <category>azure</category>
            
            <category>webapps</category>
            
            <category>unity</category>
            
        </item>
      
    
      
        <item>
            <title>Wendy 프로젝트 진행사항 2</title>
            <description>&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#들어가는-말&quot; id=&quot;markdown-toc-들어가는-말&quot;&gt;들어가는 말&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#프로젝트-진행-사항&quot; id=&quot;markdown-toc-프로젝트-진행-사항&quot;&gt;프로젝트 진행 사항&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#기능-목록&quot; id=&quot;markdown-toc-기능-목록&quot;&gt;기능 목록&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#튜토리얼-제작-사항&quot; id=&quot;markdown-toc-튜토리얼-제작-사항&quot;&gt;튜토리얼 제작 사항&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#완성된-튜토리얼-목록&quot; id=&quot;markdown-toc-완성된-튜토리얼-목록&quot;&gt;완성된 튜토리얼 목록&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#튜토리얼-제작-진행사항&quot; id=&quot;markdown-toc-튜토리얼-제작-진행사항&quot;&gt;튜토리얼 제작 진행사항&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#웬디-근황&quot; id=&quot;markdown-toc-웬디-근황&quot;&gt;웬디 근황&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#맺음말&quot; id=&quot;markdown-toc-맺음말&quot;&gt;맺음말&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;들어가는-말&quot;&gt;들어가는 말&lt;/h2&gt;

&lt;p&gt;Wendy를 시작하고 좋은 경험을 2가지 했다.&lt;/p&gt;

&lt;p&gt;첫번째는 내 진심을 알아주시고 &lt;code&gt;이상한모임&lt;/code&gt; 블로그에 웬디 사진이 게시된 것이다.&lt;/p&gt;

&lt;p&gt;두번째는 &lt;code&gt;majorika&lt;/code&gt;님이 Wendy를 테스트하는 Unity 프로젝트를 github에 올려주신 것이다.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/majorika/Wendy-Unity&quot;&gt;majorika/Wendy-Unity&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;세상은 넓고 능력자는 많다!&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;프로젝트-진행-사항&quot;&gt;프로젝트 진행 사항&lt;/h2&gt;
&lt;p&gt;아이템 관리까지 작업이 되었다. 관련하여 작성한 글은 2월에 게시한 예정이다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;a href=&quot;https://github.com/totuworld/Wendy&quot;&gt;Wendy 프로젝트 레파지토리&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;기능-목록&quot;&gt;기능 목록&lt;/h3&gt;
&lt;ul&gt;
  &lt;li&gt;기기 관리&lt;/li&gt;
  &lt;li&gt;사용자 관리&lt;/li&gt;
  &lt;li&gt;통화 관리&lt;/li&gt;
  &lt;li&gt;아이템 관리&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;튜토리얼-제작-사항&quot;&gt;튜토리얼 제작 사항&lt;/h2&gt;
&lt;p&gt;2개 강좌가 더 제작되었다.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;3강 - 기기와 사용자 관리&lt;/li&gt;
  &lt;li&gt;4강 - 통화 관리&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;완성된-튜토리얼-목록&quot;&gt;완성된 튜토리얼 목록&lt;/h3&gt;
&lt;ul&gt;
  &lt;li&gt;1강 - &lt;a href=&quot;http://totuworld.github.io/2016/12/21/azureandunity-01/&quot;&gt;Hello, world!&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;2강 - &lt;a href=&quot;http://totuworld.github.io/2016/12/29/azureandunity-02/&quot;&gt;SQL데이터베이스스와 환경설정&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;3강 - &lt;a href=&quot;http://totuworld.github.io/2017/01/12/azureandunity-03/&quot;&gt;기기와 사용자 관리&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;4강 - &lt;a href=&quot;http://totuworld.github.io/2017/01/26/azureandunity-04/&quot;&gt;통화관리&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;튜토리얼-제작-진행사항&quot;&gt;튜토리얼 제작 진행사항&lt;/h3&gt;
&lt;ul&gt;
  &lt;li&gt;5강 : 글 작성 완료, 동영상 녹화 예정&lt;/li&gt;
  &lt;li&gt;6강 : 소스 코드와 글 작성 중&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;웬디-근황&quot;&gt;웬디 근황&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;tvN &lt;code&gt;편의점을 털어라&lt;/code&gt; MC로 활약중이다(프로그램이 핵노… 읍읍).&lt;/li&gt;
  &lt;li&gt;레드벨벳 4번째 미니앨범 루키(Rookie)가 곧 공개된다.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;/images/rookie_wendy.jpg&quot; alt=&quot;rookie_wendy&quot; /&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;와 이제 대놓고 덕질할 수 있구나!&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;맺음말&quot;&gt;맺음말&lt;/h2&gt;

&lt;p&gt;동영상 튜토리얼을 만들면서 확실히 알게된 사실이 있다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;난 &lt;code&gt;핵노잼&lt;/code&gt;이다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;이렇게 지루한 동영상을 누가 볼까 싶다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;동영상을 클릭은 해봐주신 200여분께 감사와 사과의 말씀 올립니다. ㅠㅠ&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;그외에 Wendy 프로젝트를 진행하니 좋은 점이 있다.&lt;/p&gt;

&lt;p&gt;바로 블로그 조회수가 늘었다는 점이다.&lt;/p&gt;

&lt;p&gt;그전까지는 블로그 방문자의 30%가 &lt;a href=&quot;http://totuworld.github.io/2016/02/10/google-oauth/&quot;&gt;구글 인앱 결제 검증 웹 서비스 만들기&lt;/a&gt; 글을 보는 사람이었다.&lt;/p&gt;

&lt;p&gt;Wendy 관련 글이 유입 대부분을 소화하고 있을 뿐 아니라 글 올리는날 방문자가 1000명은 된다.&lt;/p&gt;

&lt;p&gt;누군가에게는 매우 작은 수치일 수 있겠지만 나에겐 큰 숫자이다.&lt;/p&gt;

&lt;p&gt;행복하다. 흐흐&lt;/p&gt;
</description>
            <pubDate>Mon, 30 Jan 2017 04:00:00 +0900</pubDate>
            <link>http://totuworld.github.io/2017/01/30/wendynotification/</link>
            <guid isPermaLink="true">http://totuworld.github.io/2017/01/30/wendynotification/</guid>
            
            
            <category>wendy</category>
            
        </item>
      
    
      
        <item>
            <title>이세계에 진입한 서버 개발 - 4</title>
            <description>&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#들어가는-말&quot; id=&quot;markdown-toc-들어가는-말&quot;&gt;들어가는 말&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#모델-추가&quot; id=&quot;markdown-toc-모델-추가&quot;&gt;모델 추가&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#통화-정의-통화-보유-모델-추가&quot; id=&quot;markdown-toc-통화-정의-통화-보유-모델-추가&quot;&gt;통화 정의, 통화 보유 모델 추가&lt;/a&gt;        &lt;ul&gt;
          &lt;li&gt;&lt;a href=&quot;#definecurrencyjs&quot; id=&quot;markdown-toc-definecurrencyjs&quot;&gt;DefineCurrency.js&lt;/a&gt;&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#owncurrencyjs&quot; id=&quot;markdown-toc-owncurrencyjs&quot;&gt;OwnCurrency.js&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#라우터-추가&quot; id=&quot;markdown-toc-라우터-추가&quot;&gt;라우터 추가&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#로직-추가&quot; id=&quot;markdown-toc-로직-추가&quot;&gt;로직 추가&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#정의된-통화-목록-요청&quot; id=&quot;markdown-toc-정의된-통화-목록-요청&quot;&gt;정의된 통화 목록 요청&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#보유한-통화-목록-요청&quot; id=&quot;markdown-toc-보유한-통화-목록-요청&quot;&gt;보유한 통화 목록 요청&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#라우터-등록&quot; id=&quot;markdown-toc-라우터-등록&quot;&gt;라우터 등록&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#일정-시간마다-충전되는-통화는&quot; id=&quot;markdown-toc-일정-시간마다-충전되는-통화는&quot;&gt;일정 시간마다 충전되는 통화는?&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#기능-정의&quot; id=&quot;markdown-toc-기능-정의&quot;&gt;기능 정의&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#definerechargecurrency-모델-추가&quot; id=&quot;markdown-toc-definerechargecurrency-모델-추가&quot;&gt;DefineRechargeCurrency 모델 추가&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#modelsdefinecurrencyjs-수정&quot; id=&quot;markdown-toc-modelsdefinecurrencyjs-수정&quot;&gt;models/DefineCurrency.js 수정&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#재충전-로직-작성&quot; id=&quot;markdown-toc-재충전-로직-작성&quot;&gt;재충전 로직 작성&lt;/a&gt;        &lt;ul&gt;
          &lt;li&gt;&lt;a href=&quot;#later-모듈-추가&quot; id=&quot;markdown-toc-later-모듈-추가&quot;&gt;later 모듈 추가&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=&quot;#환경-설정&quot; id=&quot;markdown-toc-환경-설정&quot;&gt;환경 설정&lt;/a&gt;&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#routescurrencyjs-수정&quot; id=&quot;markdown-toc-routescurrencyjs-수정&quot;&gt;routes/currency.js 수정&lt;/a&gt;        &lt;ul&gt;
          &lt;li&gt;&lt;a href=&quot;#currencydefine-api-수정&quot; id=&quot;markdown-toc-currencydefine-api-수정&quot;&gt;currency/define api 수정&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=&quot;#currencyown-api-수정&quot; id=&quot;markdown-toc-currencyown-api-수정&quot;&gt;currency/own api 수정&lt;/a&gt;&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#테스트&quot; id=&quot;markdown-toc-테스트&quot;&gt;테스트&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#dbeaver-설치&quot; id=&quot;markdown-toc-dbeaver-설치&quot;&gt;DBeaver 설치&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#connection-추가&quot; id=&quot;markdown-toc-connection-추가&quot;&gt;Connection 추가&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#재충전-통화-정보-추가&quot; id=&quot;markdown-toc-재충전-통화-정보-추가&quot;&gt;재충전 통화 정보 추가&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#정의된-통화-추가&quot; id=&quot;markdown-toc-정의된-통화-추가&quot;&gt;정의된 통화 추가&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#보유한-통화-추가&quot; id=&quot;markdown-toc-보유한-통화-추가&quot;&gt;보유한 통화 추가&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#postman으로-테스트&quot; id=&quot;markdown-toc-postman으로-테스트&quot;&gt;postman으로 테스트&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#맺음말&quot; id=&quot;markdown-toc-맺음말&quot;&gt;맺음말&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#참고자료&quot; id=&quot;markdown-toc-참고자료&quot;&gt;참고자료&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;iframe width=&quot;560&quot; height=&quot;315&quot; src=&quot;https://www.youtube.com/embed/Zrem0cNKWiM&quot; frameborder=&quot;0&quot; allowfullscreen=&quot;&quot;&gt;&lt;/iframe&gt;

&lt;h2 id=&quot;들어가는-말&quot;&gt;들어가는 말&lt;/h2&gt;
&lt;p&gt;통화는 위키피디아에 의하면 아래와 같이 정의된다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;유통 수단이나 지불 수단으로서 기능하는 교환 수단&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;code&gt;돈&lt;/code&gt;을 떠올리면 된다.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://www.marshu.com/articles/images-website/articles/presidents-on-us-paper-money/one-hundred-100-dollar-bill.jpg&quot; alt=&quot;money&quot; /&gt;&lt;/p&gt;

&lt;p&gt;그럼 게임 안에 3가지 통화가 존재한다고 해보자.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;하트 : 게임 입장에 사용된다. 일정 시간마다 재충전된다.&lt;/li&gt;
  &lt;li&gt;코인 : 게임 플레이나 업적 등으로 자주 획득할 수 있는 통화.&lt;/li&gt;
  &lt;li&gt;보석 : 주로 인앱 결제로 획득하며 게임 플레이나 업적으로 가아아아끔 획득하는 통화.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;이 중 사용자가 가장 소중히 여기는 것은 무엇일까? 당연히 보석이다.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://file.thisisgame.com/upload/nboard/news/2016/10/31/20161031183400_4668o.jpg&quot; alt=&quot;friendspopcorn&quot; /&gt;&lt;/p&gt;

&lt;p&gt;게임 내에서 희귀한 통화이고 인앱 결제 상품으로 구입이 가능한 형태로 주로 제공되기 때문이다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;이거 잘못되면 너와 나, 지옥에서 만나겠지?&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;이런 통화를 어떻게 관리하는지 알아보도록하자.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;지급 관리에서 지급과 관계된 내용을 다루므로 이번 내용에서는 빠진다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;모델-추가&quot;&gt;모델 추가&lt;/h2&gt;
&lt;p&gt;크게 2가지 모델이 필요하다. 하나는 게임 안에서 통용되는 통화를 정의하는 모델이다. 큰 변화는 없다.&lt;/p&gt;

&lt;p&gt;남은 하나는 통화 보유 모델이다. 어떤 것을 얼마나 가지고 있는지 기록해야하기 때문이다.&lt;/p&gt;

&lt;h3 id=&quot;통화-정의-통화-보유-모델-추가&quot;&gt;통화 정의, 통화 보유 모델 추가&lt;/h3&gt;
&lt;p&gt;아래 2개 파일을 &lt;code&gt;models&lt;/code&gt;폴더에 &lt;code&gt;DefineCurrency.js&lt;/code&gt;, &lt;code&gt;OwnCurrency.js&lt;/code&gt;파일을 추가한다.&lt;/p&gt;

&lt;h4 id=&quot;definecurrencyjs&quot;&gt;DefineCurrency.js&lt;/h4&gt;
&lt;p&gt;아래 내용을 입력한다.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;&#39;use strict&#39;;

module.exports = function(sequelize, DataTypes) {
    let DefineCurrency= sequelize.define(&#39;DefineCurrency&#39;, {
        CurrencyID : { type : DataTypes.INTEGER, primaryKey: true}, //고유한 번호를 할당해야한다.
        Name:{type:DataTypes.STRING(10)},
        MaxQNTY:{type:DataTypes.INTEGER, defaultValue:9000}
    }, {
        timestamps: false,
        tableName: &#39;DefineCurrency&#39;
    });
    return DefineCurrency;
};
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;DefineCurrency 모델은 &lt;code&gt;CurrencyID&lt;/code&gt;로 구분된다.&lt;/p&gt;

&lt;p&gt;즉, &lt;code&gt;CurrencyID&lt;/code&gt;절대로 중복된 숫자를 입력하면 안된다. MaxQNTY는 OwnCurrency의 CurrentQNTY가 절대 넘을 수 없는 최대치를 뜻한다.&lt;/p&gt;

&lt;h3 id=&quot;owncurrencyjs&quot;&gt;OwnCurrency.js&lt;/h3&gt;

&lt;p&gt;아래 링크의 내용을 입력한다.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://raw.githubusercontent.com/totuworld/Wendy/tuto4.2/models/OwnCurrency.js&quot;&gt;OwnCurrency.js&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;OwnCurrency 모델은 GameUser의 &lt;code&gt;GameUserID&lt;/code&gt;와 DefineCurrency의 &lt;code&gt;CurrencyID&lt;/code&gt;를 외래키로 가진다.&lt;/p&gt;

&lt;p&gt;또한 보유 수량(CurrentQNTY)을 기록할 수 있으며 특정 조건에 의해 최대 보유 수량을 늘릴 수 있는 AddMaxQNTY 컬럼도 있다. 실제 컬럼으로 존재하지 않지만 getterMethods로 &lt;code&gt;TotalQNTY&lt;/code&gt;를 등록해서 실제 최대보유수량을 계산한다.&lt;/p&gt;

&lt;h2 id=&quot;라우터-추가&quot;&gt;라우터 추가&lt;/h2&gt;

&lt;p&gt;통화에 사용된 라우터를 추가하겠다.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;code&gt;routes&lt;/code&gt; 폴더에 &lt;code&gt;currency.js&lt;/code&gt;파일을 생성한다.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;아래 코드를 입력한다.&lt;/p&gt;

    &lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;&#39;use strict&#39;

const debug = require(&#39;debug&#39;)(&#39;Wendy:router:currency&#39;);
const auth = require(&#39;../utils/auth&#39;);
const commonFunc = require(&#39;../utils/commonFunc&#39;);
const models = require(&quot;../models&quot;);
const wendyError = require(&#39;../utils/error&#39;);

const express = require(&#39;express&#39;);
const router = express.Router();

module.exports = router;
&lt;/code&gt;&lt;/pre&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;앞으로 라우터를 추가하는 것은 자주 할 것이므로 금방 익숙해질 것이다.&lt;/p&gt;

&lt;h2 id=&quot;로직-추가&quot;&gt;로직 추가&lt;/h2&gt;
&lt;p&gt;2가지 로직을 추가할 것이다.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;정의된 통화 목록 요청 : 게임 내에서 어떤 통화를 가질 수 있는지 리스트 형태로 리턴한다.&lt;/li&gt;
  &lt;li&gt;보유한 통화 목록 요청 : 사용자가 실제로 보유한 통화를 리스트 형태로 리턴한다.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;2가지로 로직은 거의 차이가 없을 것이다.&lt;/p&gt;

&lt;h3 id=&quot;정의된-통화-목록-요청&quot;&gt;정의된 통화 목록 요청&lt;/h3&gt;
&lt;p&gt;아래 코드를 &lt;code&gt;routes/currency.js&lt;/code&gt;의 &lt;code&gt;module.exports&lt;/code&gt; 위쪽에 추가한다.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;/**
 * @api {GET} /currency/define 통화 목록 요청
 * @apiName 정의된 통화 목록 요청
 * @apiHeader {String} Authorization JWT토큰을 전송
 */
router.get(&#39;/define&#39;, auth.isAuthenticated, (req, res, next)=&amp;gt;{
    models.DefineCurrency.findAll()
        .then((defineCurrencyList)=&amp;gt;{
            res.send({result:0, list:defineCurrencyList});
        })
});


&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
  &lt;li&gt;7번 줄 : &lt;code&gt;findAll&lt;/code&gt; 메서드로 &lt;code&gt;DefineCurrency&lt;/code&gt; 테이블에 등록된 모든 내용을 검색한다. 여기서처럼 조건을 넣지 않으면 모든 것이 리턴된다.&lt;/li&gt;
  &lt;li&gt;9번 줄 : 찾아진 모든 내용을 &lt;code&gt;list&lt;/code&gt;노드에 담아서 리턴한다. 이때 &lt;code&gt;list&lt;/code&gt;노드는 별뜻이 없다(fxxk이라고 해도 된다). 클라이언트가 헷갈리지 않고 구분할 수 있으면 된다.&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;보유한-통화-목록-요청&quot;&gt;보유한 통화 목록 요청&lt;/h3&gt;
&lt;p&gt;앞서 제작한 &lt;code&gt;정의된 통화 목록 요청&lt;/code&gt;과 다른 것은 조회해야할 테이블 다르다는 것과 findAll메서드에 조건을 추가한 정도다.&lt;/p&gt;

&lt;p&gt;아래 코드를 &lt;code&gt;routes/currency.js&lt;/code&gt;의 &lt;code&gt;module.exports&lt;/code&gt; 위쪽에 추가한다.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;/**
 * @api {GET} /currency/own 보유 통화 목록 요청
 * @apiName 보유 통화 목록 요청
 * @apiHeader {String} Authorization JWT토큰을 전송
 */
router.get(&#39;/own&#39;, auth.isAuthenticated, (req, res, next)=&amp;gt;{
    models.OwnCurrency.findAll({where:{GameUserID:req.user.GameUserID}})
        .then((ownCurrencyList)=&amp;gt;{
            res.send({result:0, list:ownCurrencyList});
        })
});


&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
  &lt;li&gt;7번 줄 : findAll메서드에 사용될 오브젝트를 만들고 where 노드에 조건을 추가했다. 조건은 GameUserID로 특정 사용자를 지칭했다.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;모든 것이 이렇게 간단하면 좋으련만.&lt;/p&gt;

&lt;h3 id=&quot;라우터-등록&quot;&gt;라우터 등록&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;app.js&lt;/code&gt; 파일을 수정하여 currency 라우터를 추가해보자.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;code&gt;app.js&lt;/code&gt;에서 아래 내용을 찾아서 그 아래쪽에 코드를 추가한다.&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;
        &lt;p&gt;찾아야하는 내용&lt;/p&gt;

        &lt;pre&gt;&lt;code&gt;  const routes = require(&#39;./routes/index&#39;);
&lt;/code&gt;&lt;/pre&gt;
      &lt;/li&gt;
      &lt;li&gt;
        &lt;p&gt;추가할 코드&lt;/p&gt;

        &lt;pre&gt;&lt;code&gt;  const currency = require(&#39;./routes/currency&#39;);
&lt;/code&gt;&lt;/pre&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;code&gt;app.js&lt;/code&gt;에서 아래 내용을 찾아서 그 아래쪽에 코드를 추가한다.&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;
        &lt;p&gt;찾아야하는 내용&lt;/p&gt;

        &lt;pre&gt;&lt;code&gt;  app.use(&#39;/&#39;, routes);
&lt;/code&gt;&lt;/pre&gt;
      &lt;/li&gt;
      &lt;li&gt;
        &lt;p&gt;추가할 코드&lt;/p&gt;

        &lt;pre&gt;&lt;code&gt;  app.use(&#39;/currency&#39;, currency);
&lt;/code&gt;&lt;/pre&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;일정-시간마다-충전되는-통화는&quot;&gt;일정 시간마다 충전되는 통화는?&lt;/h2&gt;

&lt;p&gt;&lt;code&gt;애니x&lt;/code&gt;이나 &lt;code&gt;드래곤플x이트&lt;/code&gt;가 공전의 히트를 칠 때 하트 구하려고 대포친구(?)를 구했던 기억이 있다.&lt;/p&gt;

&lt;p&gt;그 이후 많은 게임들이 재충전 시간을 상품으로 팔았다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;돈놓고 시간 사기.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;아마도 소규모 게임 개발팀이 만드는 게임에도 이런 통화 하나쯤은 있을 수 있다.&lt;/p&gt;

&lt;p&gt;이런 통화 숫자가 많은 편이 아니라 신나게 config 파일 하나 만들고 설정을 넣은 뒤에 계산하곤 했다.&lt;/p&gt;

&lt;p&gt;그런데 요즘 게임 어떤가?&lt;/p&gt;

&lt;p&gt;특정 레이드 진입 하기위한 &lt;code&gt;열쇠&lt;/code&gt;도 있고 요일 던전용 하루 입장 제한같은 것도 있다.&lt;/p&gt;

&lt;p&gt;어떤 &lt;code&gt;열쇠&lt;/code&gt;는 기준시각(예를들어 새벽 4시)이 지나면 재충전 시간 계산없이 보유할 수 있는 최대 수량으로 채워지는 형태도 있을 수 있다.&lt;/p&gt;

&lt;h3 id=&quot;기능-정의&quot;&gt;기능 정의&lt;/h3&gt;

&lt;p&gt;얘기된 몇가지 특징을 뽑아보면 대략 아래와 같다.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;재충전 주기마다 일정량이 재충전된다.&lt;/li&gt;
  &lt;li&gt;시간에 의한 재충전으로 최대치를 넘진 못한다.&lt;/li&gt;
  &lt;li&gt;최대치만큼 보유하면 더이상 재충전되지 않는다.&lt;/li&gt;
  &lt;li&gt;어떤 상품은 기준시각을 지나면 최대치를 보유한다.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;위 내용을 바탕으로 &lt;code&gt;DefineRechargeCurrency&lt;/code&gt; 모델에 포함될 내용을 정리하면 아래 표와 같다.&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;컬럼명&lt;/th&gt;
      &lt;th&gt;하는 일&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;RechargeCurrencyID&lt;/td&gt;
      &lt;td&gt;재충전통화 고유 ID&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;IntervalTime&lt;/td&gt;
      &lt;td&gt;재충전 주기(초단위 숫자)&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;IntervalChargeAmount&lt;/td&gt;
      &lt;td&gt;재충전 주기마다 충전되는량&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;SetMaxSwitch&lt;/td&gt;
      &lt;td&gt;최대치 충전 주기를 가지는지 나타낸다.&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;SetMaxPattern&lt;/td&gt;
      &lt;td&gt;최대치 충전 주기(Cron 표현식)&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h3 id=&quot;definerechargecurrency-모델-추가&quot;&gt;DefineRechargeCurrency 모델 추가&lt;/h3&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;code&gt;models&lt;/code&gt; 폴더에 &lt;code&gt;DefineRechargeCurrency.js&lt;/code&gt;파일을 생성한다.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;아래 소스코드를 열어서 입력한다.&lt;/p&gt;

    &lt;blockquote&gt;
      &lt;p&gt;굉장히 긴 정규표현식이 중간에 삽입되어있어 링크형태로 대치한다.&lt;/p&gt;
    &lt;/blockquote&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://raw.githubusercontent.com/totuworld/Wendy/tuto4.2/models/DefineRechargeCurrency.js&quot;&gt;DefineRechargeCurrency.js&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;이전에 추가했던 모델과 다른점은 컬럼에 &lt;code&gt;validate&lt;/code&gt;가 추가된 것이다.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;SetMaxPattern&lt;/code&gt;이 Cron 표현식을 사용하므로 잘못된 입력을 막기 위해 검증코드를 넣은 것이다.&lt;/p&gt;

&lt;h3 id=&quot;modelsdefinecurrencyjs-수정&quot;&gt;models/DefineCurrency.js 수정&lt;/h3&gt;
&lt;p&gt;통화 중에서 재충전이 필요한 경우 &lt;code&gt;DefineRechargeCurrency&lt;/code&gt; 모델을 참조해야하므로 &lt;code&gt;RechargeCurrencyID&lt;/code&gt;를 외래키로 등록한다.&lt;/p&gt;

&lt;p&gt;models/&lt;code&gt;DefineCurrency.js&lt;/code&gt; 파일에서 아래 내용을 찾는다.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;찾아야하는 내용&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;        tableName: &#39;DefineCurrency&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
  &lt;p&gt;위 내용 뒤에 반드시 쉼표(,)를 더해야 에러나지 않는다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;아래 코드를 추가한다.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;추가할 코드&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;        classMethods: {
            associate: function (models) {
                //재충전되는 통화인 경우 해당 값을 가진다.
                DefineCurrency.belongsTo(models.DefineRechargeCurrency, {
                    onDelete: &quot;CASCADE&quot;,
                    foreignKey: {
                        name:&#39;RechargeCurrencyID&#39;,
                        allowNull: true
                    },
                    as: &#39;RechargeInfo&#39;
                });
            }
        }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;외래키를 등록할 때 &lt;code&gt;as&lt;/code&gt; 노드는 별명(alias)으로 &lt;code&gt;DefineRechargeCurrency&lt;/code&gt; 이름이 너무 길어서 짧게 줄이려고 추가한 것이다.&lt;/p&gt;

&lt;h3 id=&quot;재충전-로직-작성&quot;&gt;재충전 로직 작성&lt;/h3&gt;
&lt;p&gt;vs code에서 &lt;code&gt;logics&lt;/code&gt; 폴더를 새로 생성하고 &lt;code&gt;currency.js&lt;/code&gt; 파일을 추가한다.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;vs code에서 &lt;code&gt;logics&lt;/code&gt; 폴더를 추가한다.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;logics 폴더에 &lt;code&gt;currency.js&lt;/code&gt;파일을 생성한다.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;아래 소스코드를 열어서 입력한다.&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;https://raw.githubusercontent.com/totuworld/Wendy/tuto4.2/logics/currency.js&quot;&gt;currency.js&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;ul&gt;
  &lt;li&gt;21~23번 줄 : 메서드를 실행할 필요가 있는지 체크한다.&lt;/li&gt;
  &lt;li&gt;31~41번 줄 : 최대치 충전 주기에 해당하는지 체크하여 해당한다면 최대치로 설정하도록 한다.&lt;/li&gt;
  &lt;li&gt;43~65번 줄 : 재충전 주기를 기준으로 시간경과를 고려하여 충전량을 계산한다.&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&quot;later-모듈-추가&quot;&gt;later 모듈 추가&lt;/h4&gt;
&lt;p&gt;logics/currency.js에서 later 모듈로 cron 표현식을 해석한다.&lt;/p&gt;

&lt;p&gt;모듈을 추가해보자.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;터미널을 통해 지난 시간에 다운받은 소스코드가 있는 폴더로 이동한다.&lt;/p&gt;

    &lt;blockquote&gt;
      &lt;p&gt;windows는 파일 탐색기로 해당 폴더를 선택한 뒤 &lt;code&gt;shift + 마우스 우클릭&lt;/code&gt;하여 &lt;code&gt;여기서 명령창 열기&lt;/code&gt;를 실행하면 편리하다.&lt;/p&gt;
    &lt;/blockquote&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;아래 명령을 입력하여 모듈을 설치한다.&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt; $ yarn add later
&lt;/code&gt;&lt;/pre&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h4 id=&quot;환경-설정&quot;&gt;환경 설정&lt;/h4&gt;
&lt;p&gt;Azure 웹앱은 기본 타임존이 UTC(GMT+0)로 설정되어있다. 하지만 우리의 로컬환경은 다르기때문에 이를 맞춰야 시간과 관련된 계산이 편리하다.&lt;/p&gt;

&lt;p&gt;vs code의 환경 설정을 수정하여 이를 동일하게 맞추도록 한다.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;vs code에서 &lt;code&gt;.vscode&lt;/code&gt;폴더 안에 &lt;code&gt;launch.json&lt;/code&gt;파일을 선택한다.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;code&gt;env&lt;/code&gt;노드 안에 다음 내용을 추가한다.&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt; &quot;TZ&quot;:&quot;UTC&quot;
&lt;/code&gt;&lt;/pre&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&quot;routescurrencyjs-수정&quot;&gt;routes/currency.js 수정&lt;/h3&gt;
&lt;p&gt;2개의 api를 모두 수정할 것이다.&lt;/p&gt;

&lt;h4 id=&quot;currencydefine-api-수정&quot;&gt;currency/define api 수정&lt;/h4&gt;
&lt;p&gt;정의된 통화목록을 로딩할 때 재충전 관련 데이터도 함께 엮어서 내려질 수 있도록 변경한다.&lt;/p&gt;

&lt;p&gt;아래 내용을 찾아서 변경한다.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;찾아야하는 내용&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt;  models.DefineCurrency.findAll()
&lt;/code&gt;&lt;/pre&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;변경할 코드&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt;  models.DefineCurrency.findAll({
      include: [{
          model: models.DefineRechargeCurrency,
          as: &#39;RechargeInfo&#39;
      }]
  })
&lt;/code&gt;&lt;/pre&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;findAll()할 때 include로 DefineRechargeCurrency 모델의 데이터를 포함하여 내려지게 된다.&lt;/p&gt;

&lt;h4 id=&quot;currencyown-api-수정&quot;&gt;currency/own api 수정&lt;/h4&gt;
&lt;p&gt;앞서 만든 logics/currency.js를 routes/currency.js에서 활용하도록 해보자.&lt;/p&gt;

&lt;p&gt;아래 코드를 찾아서 코드를 추가한다.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;찾아야하는 내용&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt;  const wendyError = require(&#39;../utils/error&#39;);
&lt;/code&gt;&lt;/pre&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;추가할 코드&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt;  const currencyLogic = require(&#39;../logics/currency&#39;);
&lt;/code&gt;&lt;/pre&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;그리고 route.get(‘/own’ … ) 부분 전체를 아래 코드로 변경한다.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;/**
 * @api {GET} /currency/own 보유 통화 목록 요청
 * @apiName 보유 통화 목록 요청
 * @apiHeader {String} Authorization JWT토큰을 전송
 */
router.get(&#39;/own&#39;, auth.isAuthenticated, (req, res, next) =&amp;gt; {

    let saveGameUser;
    let saveOwnCurrencyList;

    //OwnCurrency 목록조회
    models.OwnCurrency.findAll({
        where: { GameUserID: req.user.GameUserID },
        //재충전 계산이 필요할 수 있으니 DefineCurrency도 포함한다.
        include: [{
            model: models.DefineCurrency,
            include: {
                model: models.DefineRechargeCurrency,
                as: &#39;RechargeInfo&#39;
            }
        }
        ]
    })
        .then((ownCurrencyList) =&amp;gt; {
            saveOwnCurrencyList = ownCurrencyList;
            //재충전 주기를 체크해야하는지 확인한다.
            for (let row of saveOwnCurrencyList) {
                if (row.DefineCurrency.RechargeCurrencyID !== null)
                    return Promise.resolve();
            }
            return Promise.reject(&#39;pass&#39;);
        })
        //재충전 주기 확인 시 사용될 GameUser를 찾는다.
        .then(() =&amp;gt; {
            return models.GameUser.findOne({
                where: { GameUserID: req.user.GameUserID }
            })
        })
        .then((gameUser) =&amp;gt; {
            saveGameUser = gameUser;
            return Promise.resolve();
        })
        //재충전 주기를 살필 통화가 있는지 확인한다.
        .then(() =&amp;gt; {
            let nowDate = new Date();
            let promises = [];
            let tempResult;
            for (let row of saveOwnCurrencyList) {
                if (row.DefineCurrency.RechargeCurrencyID !== null) {
                    tempResult = currencyLogic.CheckForRecharge(
                        row,
                        saveGameUser,
                        row.DefineCurrency.RechargeInfo,
                        nowDate);

                    if (tempResult.code === true) {
                        promises.push(
                            models.OwnCurrency.update(
                                tempResult.update,
                                { where: { OwnCurrencyUID: row.OwnCurrencyUID } })
                        );
                    }
                }
            }
            if (promises.length &amp;gt; 0) return Promise.all(promises);
            return Promise.resolve();
        })
        .catch((err) =&amp;gt; {
            if (err === &#39;pass&#39;) return Promise.resolve(saveOwnCurrencyList);
            return Promise.reject(err);
        })
        //업데이트된 항목이 있을 수 있으니 OwnCurrency를 다시 로딩한다.
        .then(() =&amp;gt; {
            //OwnCurrencyUID를 Array로 뽑아서 쿼리에 사용한다.
            let OwnCurrencyUIDs = [];
            for (let row of saveOwnCurrencyList) {
                OwnCurrencyUIDs.push(row.OwnCurrencyUID);
            }
            return models.OwnCurrency.findAll({
                where: { OwnCurrencyUID: { $in: OwnCurrencyUIDs } }
            })
        })
        .then((ownCurrencyList)=&amp;gt;{
            res.send({result:0, list:ownCurrencyList});
        })
        .catch((err)=&amp;gt;{
            next(err);
        })
});


&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
  &lt;li&gt;12~23번 줄 : OwnCurrency를 검색할 때 정의된 통화에 관한(재충전 포함) 데이터를 함께 로딩한다.&lt;/li&gt;
  &lt;li&gt;24~32번 줄 : 재충전 주기를 확인해야하는지 체크한다. 만약 어떤 통화도 재충전이 필요없다면 68번 줄로 이동한다.&lt;/li&gt;
  &lt;li&gt;44~67번 줄 : 재충전 주기나 최대치 충전 주기를 확인해서 업데이트 사항이 발생하는지 계산한다. 만약 충전량이 존재하면 이를 반영한다.&lt;/li&gt;
  &lt;li&gt;73~82번 줄 : OwnCurrency를 다시 검색하여 업데이트 사항을 확인한다.&lt;/li&gt;
  &lt;li&gt;83~85번 줄 : 결과 전송.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;위 코드에서 특이한 곳은 57~61번 줄이다. OwnCurrency 모델에 업데이트를 요청하고 이를 모두 promises 배열에 할당한다. 그리고나서 65번 줄에서 Promise.all 메서드로 이를 처리한다.&lt;/p&gt;

&lt;p&gt;Promise.all 메서드는 지금처럼 반복되는 일을 병렬로 처리해도 상관없을 때 사용하면 된다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;단 성능에 큰 문제를 야기할 수 있다면 순차적으로 처리하는 것을 권한다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;테스트&quot;&gt;테스트&lt;/h2&gt;
&lt;p&gt;필요한 데이터를 넣고 테스트를 진행할 것이다.&lt;/p&gt;

&lt;p&gt;하지만 아직 Wendy가 데이터를 넣는 어떤 로직도 제공하지 않기때문에 DB에 직접 데이터를 넣어야한다.&lt;/p&gt;

&lt;h3 id=&quot;dbeaver-설치&quot;&gt;DBeaver 설치&lt;/h3&gt;
&lt;p&gt;DB에 접속해서 필요한 일을 처리해줄 GUI 툴로 &lt;code&gt;DBeaver&lt;/code&gt;를 사용하겠다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;무료이고 MSSQL을 지원하면서 Mac, Windows를 모두 사용가능하다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;다음 링크로 이동해서 &lt;a href=&quot;http://dbeaver.jkiss.org/&quot;&gt;DBeaver&lt;/a&gt;를 설치한다.&lt;/p&gt;

&lt;h3 id=&quot;connection-추가&quot;&gt;Connection 추가&lt;/h3&gt;
&lt;p&gt;DB에 접속하기 위해 Connection을 등록해보자.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;SQL 데이터베이스의 서버 방화벽 설정으로 등록된 주소지에서 접속 가능하다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;DBeaver를 실행한 뒤 &lt;code&gt;New Connection&lt;/code&gt;을 클릭한다.&lt;/p&gt;

    &lt;p&gt;&lt;img src=&quot;/images/rvwendy03_03.png&quot; alt=&quot;NewConnection&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;code&gt;MS SQL Server - jTDS driver&lt;/code&gt;를 선택하고 Next를 클릭한다.&lt;/p&gt;

    &lt;p&gt;&lt;img src=&quot;/images/rvwendy03_04.png&quot; alt=&quot;jTDS_driver&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;code&gt;Host&lt;/code&gt;에 Azure SQL 데이터베이스 호스트를 입력한다. &lt;code&gt;User name&lt;/code&gt;과 &lt;code&gt;Password&lt;/code&gt;도 입력한다. Next 선택하고 모두 입력되면 Finish 클릭한다.&lt;/p&gt;

    &lt;p&gt;&lt;img src=&quot;/images/rvwendy03_05.png&quot; alt=&quot;host&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&quot;재충전-통화-정보-추가&quot;&gt;재충전 통화 정보 추가&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;Connection 전에 로컬 서버를 실행한다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;등록된 Connection에 접속을 한 뒤 자신의 db를 연다(여기서는 wendydb).&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;code&gt;dbo - tables - DefineRechargeCurrency&lt;/code&gt;를 더블 클릭 한다.&lt;/p&gt;

    &lt;p&gt;&lt;img src=&quot;/images/rvwendy03_06.png&quot; alt=&quot;selecttable&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;code&gt;Data&lt;/code&gt; 탭을 누른다.&lt;/p&gt;

    &lt;p&gt;&lt;img src=&quot;/images/rvwendy03_07.png&quot; alt=&quot;Data_tab&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;code&gt;+&lt;/code&gt; 버튼(Add new row)을 클릭 한 뒤 아래 표처럼 입력한다.&lt;/p&gt;

    &lt;p&gt;&lt;img src=&quot;/images/rvwendy03_08_0.png&quot; alt=&quot;plusbutton&quot; /&gt;&lt;/p&gt;

    &lt;table&gt;
      &lt;thead&gt;
        &lt;tr&gt;
          &lt;th&gt;RechargeCurrencyID&lt;/th&gt;
          &lt;th&gt;IntervalTime&lt;/th&gt;
          &lt;th&gt;IntervalChargeAmount&lt;/th&gt;
          &lt;th&gt;SetMaxSwitch&lt;/th&gt;
          &lt;th&gt;SetMaxPattern&lt;/th&gt;
        &lt;/tr&gt;
      &lt;/thead&gt;
      &lt;tbody&gt;
        &lt;tr&gt;
          &lt;td&gt;101&lt;/td&gt;
          &lt;td&gt;3600&lt;/td&gt;
          &lt;td&gt;2&lt;/td&gt;
          &lt;td&gt;1&lt;/td&gt;
          &lt;td&gt;15 10 * * ? *&lt;/td&gt;
        &lt;/tr&gt;
      &lt;/tbody&gt;
    &lt;/table&gt;

    &lt;p&gt;101은 3600초(1시간)에 2만큼 재충전된다. 그리고 매일 10:15분에 최대치로 충전된다.&lt;/p&gt;

    &lt;p&gt;&lt;img src=&quot;/images/rvwendy03_08.png&quot; alt=&quot;newrow&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;아래쪽에 &lt;code&gt;Save&lt;/code&gt;버튼을 클릭해서 추가한다.&lt;/p&gt;

    &lt;p&gt;&lt;img src=&quot;/images/rvwendy03_09.png&quot; alt=&quot;savebutton&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&quot;정의된-통화-추가&quot;&gt;정의된 통화 추가&lt;/h3&gt;

&lt;p&gt;위의 과정처럼 &lt;code&gt;DefineCurrency&lt;/code&gt; 테이블에 데이터를 입력한다.&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;CurrencyID&lt;/th&gt;
      &lt;th&gt;Name&lt;/th&gt;
      &lt;th&gt;MaxQNTY&lt;/th&gt;
      &lt;th&gt;RechargeCurrencyID&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;101&lt;/td&gt;
      &lt;td&gt;key&lt;/td&gt;
      &lt;td&gt;500&lt;/td&gt;
      &lt;td&gt;101&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;102&lt;/td&gt;
      &lt;td&gt;gem&lt;/td&gt;
      &lt;td&gt;900000&lt;/td&gt;
      &lt;td&gt;NULL&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;103&lt;/td&gt;
      &lt;td&gt;gold&lt;/td&gt;
      &lt;td&gt;900000&lt;/td&gt;
      &lt;td&gt;NULL&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;위 테이블처러 2가지 상품을 등록한다. 그 중 101 상품은 재충전 가능한 상품이 된다.&lt;/p&gt;

&lt;h3 id=&quot;보유한-통화-추가&quot;&gt;보유한 통화 추가&lt;/h3&gt;
&lt;p&gt;지난 강좌에서 사용자를 등록했다는 가정하에 진행한다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;만약 사용자 등록을 하지 않았다면 등록한 뒤 GameUserID란을 자신의 것과 동일하게 넣으면 된다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;OwnCurrencyUID&lt;/th&gt;
      &lt;th&gt;CurrencyID&lt;/th&gt;
      &lt;th&gt;CurrentQNTY&lt;/th&gt;
      &lt;th&gt;NowMaxQNTY&lt;/th&gt;
      &lt;th&gt;AddMaxQNTY&lt;/th&gt;
      &lt;th&gt;UpdateTimeStamp&lt;/th&gt;
      &lt;th&gt;GameUserID&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;NULL&lt;/td&gt;
      &lt;td&gt;101&lt;/td&gt;
      &lt;td&gt;5&lt;/td&gt;
      &lt;td&gt;5&lt;/td&gt;
      &lt;td&gt;0&lt;/td&gt;
      &lt;td&gt;2016-12-30&lt;/td&gt;
      &lt;td&gt;1&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;NULL&lt;/td&gt;
      &lt;td&gt;102&lt;/td&gt;
      &lt;td&gt;10&lt;/td&gt;
      &lt;td&gt;900&lt;/td&gt;
      &lt;td&gt;0&lt;/td&gt;
      &lt;td&gt;2016-12-30&lt;/td&gt;
      &lt;td&gt;1&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;NULL&lt;/td&gt;
      &lt;td&gt;103&lt;/td&gt;
      &lt;td&gt;1000&lt;/td&gt;
      &lt;td&gt;90000&lt;/td&gt;
      &lt;td&gt;0&lt;/td&gt;
      &lt;td&gt;2016-12-30&lt;/td&gt;
      &lt;td&gt;1&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;&lt;code&gt;OwnCurrencyUID&lt;/code&gt;는 자동으로 증가되므로 NULL을 넣어도 알아서 값을 가지게 된다.&lt;/p&gt;

&lt;h3 id=&quot;postman으로-테스트&quot;&gt;postman으로 테스트&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;패스 : GET&lt;/li&gt;
  &lt;li&gt;URL : localhost:3000/currency/own&lt;/li&gt;
  &lt;li&gt;Headers : Authorization을 추가하고 토큰 내용을 value 부분에 넣는다.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;성공하면 다음과 같은 정보를 돌려준다.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;{
  &quot;result&quot;: 0,
  &quot;list&quot;: [
    {
      &quot;TotalQNTY&quot;: 5,
      &quot;OwnCurrencyUID&quot;: 7,
      &quot;CurrencyID&quot;: 101,
      &quot;CurrentQNTY&quot;: 5,
      &quot;NowMaxQNTY&quot;: 5,
      &quot;AddMaxQNTY&quot;: 0,
      &quot;UpdateTimeStamp&quot;: &quot;2017-01-04T05:46:19.658Z&quot;,
      &quot;GameUserID&quot;: 1
    },
    {
      &quot;TotalQNTY&quot;: 100,
      &quot;OwnCurrencyUID&quot;: 8,
      &quot;CurrencyID&quot;: 102,
      &quot;CurrentQNTY&quot;: 1,
      &quot;NowMaxQNTY&quot;: 100,
      &quot;AddMaxQNTY&quot;: 0,
      &quot;UpdateTimeStamp&quot;: &quot;2016-12-30T00:00:00.000Z&quot;,
      &quot;GameUserID&quot;: 1
    }
  ]
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;보는 바와 같이 101 상품은 재충전이 일어나서 CurrentQNTY가 5가 되었고 UpdateTimeStamp도 변경이 있다.&lt;/p&gt;

&lt;h2 id=&quot;맺음말&quot;&gt;맺음말&lt;/h2&gt;
&lt;p&gt;이번에 다룬 것은 통화였다. 그중에서 재충전에 관한 것이 많은 부분을 차지했다.&lt;/p&gt;

&lt;p&gt;실제로 통화 관리는 이보다 더 복잡하게 이뤄질 수 있다.&lt;/p&gt;

&lt;p&gt;이 과정을 넘어서 다음 강좌에서 만나자!!&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://totuworld.github.io/2017/02/09/azureandunity-05/&quot;&gt;5강 바로가기&lt;/a&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;참고자료&quot;&gt;참고자료&lt;/h2&gt;
&lt;p&gt;완성된 소스코드는 아래 링크에서 다운로드받으면 된다.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/totuworld/Wendy/archive/0.0.3.zip&quot;&gt;Wendy 4강 완료 버전&lt;/a&gt;&lt;/p&gt;
</description>
            <pubDate>Thu, 26 Jan 2017 04:00:00 +0900</pubDate>
            <link>http://totuworld.github.io/2017/01/26/azureandunity-04/</link>
            <guid isPermaLink="true">http://totuworld.github.io/2017/01/26/azureandunity-04/</guid>
            
            
            <category>nodejs</category>
            
            <category>azure</category>
            
            <category>webapps</category>
            
            <category>unity</category>
            
        </item>
      
    
      
        <item>
            <title>이세계에 진입한 서버 개발 - 3</title>
            <description>&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#들어가는-말&quot; id=&quot;markdown-toc-들어가는-말&quot;&gt;들어가는 말&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#utils-파일-추가&quot; id=&quot;markdown-toc-utils-파일-추가&quot;&gt;utils 파일 추가&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#테이블-정의&quot; id=&quot;markdown-toc-테이블-정의&quot;&gt;테이블 정의&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#기기-테이블&quot; id=&quot;markdown-toc-기기-테이블&quot;&gt;기기 테이블&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#사용자-테이블&quot; id=&quot;markdown-toc-사용자-테이블&quot;&gt;사용자 테이블&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#모델-추가&quot; id=&quot;markdown-toc-모델-추가&quot;&gt;모델 추가&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#기기-모델-정의&quot; id=&quot;markdown-toc-기기-모델-정의&quot;&gt;기기 모델 정의&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#사용자-모델-정의&quot; id=&quot;markdown-toc-사용자-모델-정의&quot;&gt;사용자 모델 정의&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#라우터-작성&quot; id=&quot;markdown-toc-라우터-작성&quot;&gt;라우터 작성&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#기기-라우터-추가&quot; id=&quot;markdown-toc-기기-라우터-추가&quot;&gt;기기 라우터 추가&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#사용자-라우터-추가&quot; id=&quot;markdown-toc-사용자-라우터-추가&quot;&gt;사용자 라우터 추가&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#라우터-등록&quot; id=&quot;markdown-toc-라우터-등록&quot;&gt;라우터 등록&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#로직-등록&quot; id=&quot;markdown-toc-로직-등록&quot;&gt;로직 등록&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#기기-등록-로직&quot; id=&quot;markdown-toc-기기-등록-로직&quot;&gt;기기 등록 로직&lt;/a&gt;        &lt;ul&gt;
          &lt;li&gt;&lt;a href=&quot;#orm-활용-코드-읽기&quot; id=&quot;markdown-toc-orm-활용-코드-읽기&quot;&gt;ORM 활용 코드 읽기&lt;/a&gt;&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#토큰-요청-로직&quot; id=&quot;markdown-toc-토큰-요청-로직&quot;&gt;토큰 요청 로직&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#사용자-정보-조회-로직&quot; id=&quot;markdown-toc-사용자-정보-조회-로직&quot;&gt;사용자 정보 조회 로직&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#사용자-등록-로직&quot; id=&quot;markdown-toc-사용자-등록-로직&quot;&gt;사용자 등록 로직&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#테스트&quot; id=&quot;markdown-toc-테스트&quot;&gt;테스트&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#appjs-수정&quot; id=&quot;markdown-toc-appjs-수정&quot;&gt;app.js 수정&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#postman-설치&quot; id=&quot;markdown-toc-postman-설치&quot;&gt;Postman 설치&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#테스트-코드&quot; id=&quot;markdown-toc-테스트-코드&quot;&gt;테스트 코드&lt;/a&gt;        &lt;ul&gt;
          &lt;li&gt;&lt;a href=&quot;#토큰-요청&quot; id=&quot;markdown-toc-토큰-요청&quot;&gt;토큰 요청&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=&quot;#기기-등록&quot; id=&quot;markdown-toc-기기-등록&quot;&gt;기기 등록&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=&quot;#사용자-등록&quot; id=&quot;markdown-toc-사용자-등록&quot;&gt;사용자 등록&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=&quot;#사용자-정보-조회&quot; id=&quot;markdown-toc-사용자-정보-조회&quot;&gt;사용자 정보 조회&lt;/a&gt;&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#맺는말&quot; id=&quot;markdown-toc-맺는말&quot;&gt;맺는말&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#참고자료&quot; id=&quot;markdown-toc-참고자료&quot;&gt;참고자료&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;iframe width=&quot;560&quot; height=&quot;315&quot; src=&quot;https://www.youtube.com/embed/q8reG_gVcUQ&quot; frameborder=&quot;0&quot; allowfullscreen=&quot;&quot;&gt;&lt;/iframe&gt;

&lt;h2 id=&quot;들어가는-말&quot;&gt;들어가는 말&lt;/h2&gt;
&lt;p&gt;게임에서 사용자는 아이디(혹은 닉네임)을 가지고 있으나 그것외에 서로를 구별할 수 있는 정보가 부족하다.&lt;/p&gt;

&lt;p&gt;설상 가상으로 사용자는 스마트폰뿐 아니라 테블릿이나 가상 기기 등 여러 기기로 게임을 즐긴다.&lt;/p&gt;

&lt;p&gt;없는 정보로 기기를 구분하고 기기와 사용자를 연결하려면 어떻게 해야할까?&lt;/p&gt;

&lt;p&gt;이제부터 데이터베이스를 활용해서 어떻게 이를 관리하는지 알아보자.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;이번에 다룰 내용에서는 복수의 기기를 한 사용자에게 연결하는 부분은 제외한다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;utils-파일-추가&quot;&gt;utils 파일 추가&lt;/h2&gt;
&lt;p&gt;프로그래밍에 필요한 파일 3개를 &lt;code&gt;utils&lt;/code&gt;폴더에 추가해야한다.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://gist.githubusercontent.com/totuworld/72ffa52a423d192023514081880b593a/raw/b15d71a14ba6880b3a65f27528d1c658a0bdc9ee/commonFunc.js&quot;&gt;commonFunc.js&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://gist.githubusercontent.com/totuworld/72ffa52a423d192023514081880b593a/raw/b15d71a14ba6880b3a65f27528d1c658a0bdc9ee/auth.js&quot;&gt;auth.js&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://gist.githubusercontent.com/totuworld/72ffa52a423d192023514081880b593a/raw/b15d71a14ba6880b3a65f27528d1c658a0bdc9ee/error.js&quot;&gt;error.js&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;위 3개 파일을 다른이름으로 저장하여 &lt;code&gt;utils&lt;/code&gt;폴더에 추가한다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;vs code에서 파일을 생성한 뒤 내용을 복사 붙여넣기해도 무방하다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;테이블-정의&quot;&gt;테이블 정의&lt;/h2&gt;

&lt;p&gt;친한 친구 중에 &lt;code&gt;John&lt;/code&gt;이 3명 있다고 해보자. 이름이 같지만 각자가 가진 특징이 달라서 구분할 수 있다.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/rvwendy03_m01.png&quot; alt=&quot;john&quot; /&gt;&lt;/p&gt;

&lt;p&gt;하지만 이들이 인터넷 공간에서 &lt;code&gt;John&lt;/code&gt;으로 불린다면 다 구분할 수 있을까? 프로필 사진이 있어도 그 &lt;code&gt;John&lt;/code&gt;이 그 &lt;code&gt;John&lt;/code&gt;이란 보장은 어렵다(도용하면 노답).&lt;/p&gt;

&lt;p&gt;이런 문제는 게임에서도 사용자를 구분하는게 쉬운 문제가 아니다. 사용자 이메일이나 소셜미디어 로그인 등을 지원해야 그나마 의미있는 정보를 얻을 수 있다. 그러나 이를 쉽게 요구하기 어렵다.&lt;/p&gt;

&lt;p&gt;대안으로 &lt;code&gt;범용 고유 식별자&lt;/code&gt;(이하 UUID)를 활용하여 기기를 구분하겠다. 사용자는 &lt;code&gt;별명&lt;/code&gt;(이하 닉네임)만 요구하는 형태로 사용하겠다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;각각의 테이블은 하나의 스프레드 시트로 생각하면 된다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;기기-테이블&quot;&gt;기기 테이블&lt;/h3&gt;
&lt;p&gt;기기 정보를 기록하려면 기록지(혹은 대장)가 필요한 것처럼 관계형 데이터베이스에서도 어떻게 기록할지 정할 필요가 있다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;엑셀로 치면 새로운 시트를 추가하고 등록할 정보를 컬럼명으로 적는 것이다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;테이블이 다음과 같다고 해보자.&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;GameDeviceUID&lt;/th&gt;
      &lt;th&gt;UUID&lt;/th&gt;
      &lt;th&gt;DeviceType&lt;/th&gt;
      &lt;th&gt;GameUserID&lt;/th&gt;
      &lt;th&gt;MainFlag&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;1&lt;/td&gt;
      &lt;td&gt;12341234&lt;/td&gt;
      &lt;td&gt;iOS&lt;/td&gt;
      &lt;td&gt;2&lt;/td&gt;
      &lt;td&gt;true&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;2&lt;/td&gt;
      &lt;td&gt;343434&lt;/td&gt;
      &lt;td&gt;aOS&lt;/td&gt;
      &lt;td&gt;3&lt;/td&gt;
      &lt;td&gt;true&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;이 테이블의 컬럼을 아래와 같이 정의할 수 있다.&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;Name&lt;/th&gt;
      &lt;th style=&quot;text-align: left&quot;&gt;Type&lt;/th&gt;
      &lt;th&gt;Default&lt;/th&gt;
      &lt;th&gt;Attributes&lt;/th&gt;
      &lt;th&gt;Index&lt;/th&gt;
      &lt;th&gt;AutoIncrease&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;GameDeviceUID&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;INTEGER&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
      &lt;td&gt;PRIMARY&lt;/td&gt;
      &lt;td&gt;o&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;UUID&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;STRING&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;DeviceType&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;INTEGER&lt;/td&gt;
      &lt;td&gt;0&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;MainFlag&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;BOOLEAN&lt;/td&gt;
      &lt;td&gt;true&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;GameUserID&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;INTEGER&lt;/td&gt;
      &lt;td&gt;0&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h3 id=&quot;사용자-테이블&quot;&gt;사용자 테이블&lt;/h3&gt;
&lt;p&gt;사용자 테이블은 닉네임, 로케일, 사용시간대 등을 기록한다.&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;Name&lt;/th&gt;
      &lt;th style=&quot;text-align: left&quot;&gt;Type&lt;/th&gt;
      &lt;th&gt;Default&lt;/th&gt;
      &lt;th&gt;Attributes&lt;/th&gt;
      &lt;th&gt;Index&lt;/th&gt;
      &lt;th&gt;AutoIncrease&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;GameUserID&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;INTEGER&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
      &lt;td&gt;PRIMARY&lt;/td&gt;
      &lt;td&gt;o&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;NickName&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;STRING&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Locale&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;STRING&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;OffsetTime&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;INTEGER&lt;/td&gt;
      &lt;td&gt;0&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;OffsetTimeUpdateAt&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;DATE&lt;/td&gt;
      &lt;td&gt;now&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;createAt&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;DATE&lt;/td&gt;
      &lt;td&gt;now&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;loginAt&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;DATE&lt;/td&gt;
      &lt;td&gt;now&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
      &lt;td&gt;-&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h2 id=&quot;모델-추가&quot;&gt;모델 추가&lt;/h2&gt;

&lt;p&gt;테이블 정의에 따라 모델을 정의해보자.&lt;/p&gt;

&lt;p&gt;Sequelize.js를 사용해서 model의 기본구조는 아래와 같다.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;module.exports = function(sequelize, DataTypes) {
    let _yourTableName = sequelize.define(&#39;모델명&#39;, { /* 특성 */ }, { /* 옵션 */ });
    return _yourTableName;
};
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
  &lt;li&gt;특성 : 각 컬럼을 정의하는 내용이 포함된다.&lt;/li&gt;
  &lt;li&gt;옵션 : 필요에 따라 추가하면 된다.&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;기기-모델-정의&quot;&gt;기기 모델 정의&lt;/h3&gt;

&lt;p&gt;앞서 살펴본 테이블에 따라 기기 모델을 정의해보겠다.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;models폴더에 &lt;code&gt;GameDevice.js&lt;/code&gt;파일을 만든다.&lt;/p&gt;

    &lt;blockquote&gt;
      &lt;p&gt;지난 시간에 vs code로 신규 파일을 생성하는 단계를 설명해서 이는 생략한다.&lt;/p&gt;
    &lt;/blockquote&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;아래 소스코드를 입력한다.&lt;/p&gt;

    &lt;script src=&quot;https://gist.github.com//72ffa52a423d192023514081880b593a.js?file=GameDevice.js&quot;&gt; &lt;/script&gt;

    &lt;p&gt;코드가 길어졌지만 기본구조와 크게 다를게 없다.&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;10번 줄 : Sequelize.js는 기본으로 업데이트와 생성된 시간을 기록하는 타임스탬프를 추가한다. 이를 제거하는 옵션.&lt;/li&gt;
      &lt;li&gt;11번 줄 : 테이블명은 정확히 명시한 것이다. Sequelize.js의 테이블명은 강제로 복수형으로 입력되는데 경우에 따라 가독성이 떨어지므로 필요에 따라 수정한다.&lt;/li&gt;
      &lt;li&gt;12번 줄 : 후에 추가할 GameUser테이블과의 관계를 정의하는 &lt;code&gt;associate&lt;/code&gt;를 추가한 것이다. &lt;code&gt;belongsTo&lt;/code&gt;는 1:1 관계에 대한 외래키가 존재하는 것을 의미한다.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&quot;사용자-모델-정의&quot;&gt;사용자 모델 정의&lt;/h3&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;models폴더에 &lt;code&gt;GameUser.js&lt;/code&gt;파일을 만든다.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;아래 소스코드를 입력한다.&lt;/p&gt;

    &lt;script src=&quot;https://gist.github.com//72ffa52a423d192023514081880b593a.js?file=GameUser.js&quot;&gt; &lt;/script&gt;

    &lt;p&gt;외래키 설정이 없어서 더 간단하다.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;라우터-작성&quot;&gt;라우터 작성&lt;/h2&gt;
&lt;p&gt;express의 라우터는 패스와 콜백 메서드로 이뤄진다.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;    router.METHOD( /* 패스(path) */ , /* 콜백 메서드(callback method) */ );
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;앞의 METHOD는 HTTP 메서드(get, post, put 등)를 제공한다. 패스는 URL의 패스를 입력하면 된다. 콜백 메서드가 실제로 모든 일을 처리하게 된다.&lt;/p&gt;

&lt;h3 id=&quot;기기-라우터-추가&quot;&gt;기기 라우터 추가&lt;/h3&gt;
&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;code&gt;routes&lt;/code&gt; 폴더에 &lt;code&gt;device.js&lt;/code&gt;파일을 생성한다.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;아래 코드를 입력한다.&lt;/p&gt;

    &lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;&#39;use strict&#39;

const debug = require(&#39;debug&#39;)(&#39;Wendy:router:device&#39;);
const auth = require(&#39;../utils/auth&#39;);
const commonFunc = require(&#39;../utils/commonFunc&#39;);
const models = require(&quot;../models&quot;);
const wendyError = require(&#39;../utils/error&#39;);

const express = require(&#39;express&#39;);
const router = express.Router();

module.exports = router;
&lt;/code&gt;&lt;/pre&gt;

    &lt;ul&gt;
      &lt;li&gt;3~7 번 줄 : Node.js 에서 require(‘경로’); 를 활용하면 그 .js 파일 기준으로 상대 경로에 위치한 js 파일을 가져와 쓸 수 있다.&lt;/li&gt;
      &lt;li&gt;9~10 번 줄 : express 모듈에서 router를 추가하는 방법이라고 알고 있도록 하자.&lt;/li&gt;
      &lt;li&gt;12번 줄 : &lt;code&gt;module.exports&lt;/code&gt;는 사용자 모듈을 만들 때 사용한다.&lt;/li&gt;
    &lt;/ul&gt;

    &lt;p&gt;이 코드는 router를 로딩하여 편집하고 다시 모듈로 내보내는 형태이다.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&quot;사용자-라우터-추가&quot;&gt;사용자 라우터 추가&lt;/h3&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;code&gt;routes&lt;/code&gt; 폴더에 &lt;code&gt;user.js&lt;/code&gt;파일을 생성한다.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;아래 코드를 입력한다.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;&#39;use strict&#39;

const debug = require(&#39;debug&#39;)(&#39;Wendy:router:user&#39;);
const auth = require(&#39;../utils/auth&#39;);
const commonFunc = require(&#39;../utils/commonFunc&#39;);
const models = require(&quot;../models&quot;);
const wendyError = require(&#39;../utils/error&#39;);

const express = require(&#39;express&#39;);
const router = express.Router();

module.exports = router;
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;라우터-등록&quot;&gt;라우터 등록&lt;/h3&gt;
&lt;p&gt;이렇게 라우터를 추가해도 express.js가 바로 인식할 수 있지 않다. &lt;code&gt;app.js&lt;/code&gt; 파일을 수정하여 2가지 라우터를 추가해보자.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;code&gt;app.js&lt;/code&gt;에서 아래 내용을 찾아서 그 아래쪽에 코드를 추가한다.&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;
        &lt;p&gt;찾아야하는 내용&lt;/p&gt;

        &lt;p&gt;const routes = require(‘./routes/index’);&lt;/p&gt;
      &lt;/li&gt;
      &lt;li&gt;
        &lt;p&gt;추가할 코드&lt;/p&gt;
      &lt;/li&gt;
    &lt;/ul&gt;

    &lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;const user = require(&#39;./routes/user&#39;);
const device = require(&#39;./routes/device&#39;);

&lt;/code&gt;&lt;/pre&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;code&gt;app.js&lt;/code&gt;에서 아래 내용을 찾아서 그 아래쪽에 코드를 추가한다.&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;
        &lt;p&gt;찾아야하는 내용&lt;/p&gt;

        &lt;p&gt;app.use(‘/’, routes);&lt;/p&gt;
      &lt;/li&gt;
      &lt;li&gt;
        &lt;p&gt;추가할 코드&lt;/p&gt;
      &lt;/li&gt;
    &lt;/ul&gt;

    &lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;app.use(&#39;/user&#39;, user);
app.use(&#39;/device&#39;, device);

&lt;/code&gt;&lt;/pre&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;위 처럼 변경이 완료되면 특정 패스로 시작되는 것을 해당 라우터가 모두 처리하게 된다.&lt;/p&gt;

&lt;p&gt;예를 들어 &lt;code&gt;hostname/device&lt;/code&gt; 로 시작되는 모든 패스는 &lt;code&gt;routes/device.js&lt;/code&gt;가 관리하게 되는 것이다.&lt;/p&gt;

&lt;h2 id=&quot;로직-등록&quot;&gt;로직 등록&lt;/h2&gt;
&lt;p&gt;기기의 UUID를 통해서 게임 입장 시 이뤄지는 기본 동작은 다음과 같은 순서로 진행된다.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/mks_v03.png&quot; alt=&quot;사용자등록&quot; /&gt;&lt;/p&gt;

&lt;p&gt;게임 서버가 처리해야할 일은 총 4가지다.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;토큰 요청(기기등록 여부 확인)&lt;/li&gt;
  &lt;li&gt;기기 등록&lt;/li&gt;
  &lt;li&gt;사용자 등록(닉네임 등록)&lt;/li&gt;
  &lt;li&gt;사용자 정보 조회&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;4가지 로직을 프로그래밍해보자.&lt;/p&gt;

&lt;h3 id=&quot;기기-등록-로직&quot;&gt;기기 등록 로직&lt;/h3&gt;
&lt;p&gt;기기에 필요한 로직은 크게 2가지이다. 등록된 UUID를 통해서 토큰을 얻는 것과 기기 등록 요청을 하는 것이다.&lt;/p&gt;

&lt;p&gt;아래 코드를 &lt;code&gt;routes/device.js&lt;/code&gt;의 &lt;code&gt;module.exports&lt;/code&gt; 위쪽에 추가한다.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;/**
 * @api {POST} /device 기기 등록
 * @apiName 모바일 기기 등록
 * @apiParam {String{1..60}} UUID 기기의 UUID
 * @apiParam {Number} DeviceType 기기 종류 1:aOS, 2:iOS, 10:UnityEditor
 */
router.post(&#39;/&#39;, (req, res, next)=&amp;gt;{   
    
    let checkRequestBody 
        = commonFunc.ObjectExistThatKeys(req.body, [&#39;UUID&#39;, &#39;DeviceType&#39;]);
    if(checkRequestBody === false) {
        throw wendyError(&#39;DontHaveRequiredParams&#39;);
    }

    //UUID로 등록된 기기가 있는가?
    models.GameDevice.findOne({where:{UUID:req.body.UUID}})
        .then((findGameDevice)=&amp;gt;{
            if(findGameDevice === null) {
                //기기등록 시작
                return models.GameDevice.create(
                    {UUID:req.body.UUID, 
                    DeviceType:req.body.DeviceType})
            }
            return Promise.resolve(findGameDevice);
        })
        .then((gameDeviceData)=&amp;gt;{
            return Promise.resolve({result:0})
        })
        .then((result)=&amp;gt;{
            res.send(result);
        })
        .catch((err)=&amp;gt;{
            next(err);
        })
})


&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;소스코드를 읽기위해서 &lt;code&gt;Promise 패턴&lt;/code&gt;을 눈에 익힐 필요가 있는데 이건 시간이 해결해줄거라고 생각하겠다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Promise 패턴에 대한 상세한 설명은 &lt;a href=&quot;https://developers.google.com/web/fundamentals/getting-started/primers/promises&quot;&gt;Javascript Promise&lt;/a&gt;를 참고하면 된다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;한글로된 설명을 원한다면 &lt;a href=&quot;http://programmingsummaries.tistory.com/325&quot;&gt;바보들을 위한 Promise 강의&lt;/a&gt;를 참고하면 된다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;9~13번 줄 : 서버 도착한 요청에 body부분에 필요한 정보(여기서는 UUID, DeviceType)이 존재하는지 체크하여 없으면 오류 처리한다.&lt;/li&gt;
  &lt;li&gt;16번 줄 : UUID로 등록된 기기가 있는지 기기테이블(GameDevice)를 검색한다.&lt;/li&gt;
  &lt;li&gt;17~31번 줄 : 기기가 없으면 등록하고 존재하면 등록절차만 건너뛰고 모두 정상 결과를 송신한다.&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;우리가 클라이언트에 보내는 응답은 { result : 결과 코드 } 형태로 보낼 것이다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h4 id=&quot;orm-활용-코드-읽기&quot;&gt;ORM 활용 코드 읽기&lt;/h4&gt;
&lt;p&gt;잠깐 설명하고 넘어가자면 앞서 본 코드의 16번 줄은 ORM을 이용해서 데이터베이스를 조회한 것이다.&lt;/p&gt;

&lt;p&gt;대략 다음과 같은 형태의 코드가 모두 ORM을 이용하는 것이다.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;models.[테이블명].[명령어]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;테이블명은 models에 추가한 모델의 명칭을 뜻하므로 추가하지 않은 것을 넣으면 문제가된다.&lt;/p&gt;

&lt;p&gt;자주 사용되는 명령어는 다음 4개이고 각 명령마다 넣는 값이 조금씩 다르다.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;findOne : 조건에 맞는 한 개의 데이터를 찾는다. where로 조건을 나타낸다.&lt;/li&gt;
  &lt;li&gt;findAll : 조건에 맞는 모든 데이터를 찾는다. where로 조건을 나타낸다.&lt;/li&gt;
  &lt;li&gt;create : 새로운 행(데이터)을 추가한다. 별도의 조건이 없다.&lt;/li&gt;
  &lt;li&gt;update : 조건에 맞는 것을 설정한 값으로 모두 수정한다. where로 조건을 나타낸다.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;위에 나온 실제 코드를 읽어보자.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;models.GameDevice.findOne({where:{UUID:req.body.UUID}})
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;code&gt;GameDevice&lt;/code&gt; 모델에서 &lt;code&gt;UUID&lt;/code&gt; 열이 req.body.UUID와 같은 1개의 행을 찾아라&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;자주 보게되면 금방 익숙해지니 외우려고하지 말고 넘어가자.&lt;/p&gt;

&lt;h3 id=&quot;토큰-요청-로직&quot;&gt;토큰 요청 로직&lt;/h3&gt;
&lt;p&gt;주민등록번호는 편리하다. 번호만으로 그 사람이 누구인지 확인해니 관공서 업무에 많이 활용된다.&lt;/p&gt;

&lt;p&gt;거꾸로 말하면 유출 시 손쉽게 다른 사람이 될 수 있다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;누군가 내 주민등록번호로 네이버 아이디를 2개나 만들어서 쓰고있었다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;그래서 우리는 사용자 정보를 직접 공개하지 않고 일정 기간만 유효한 토큰(token)을 발급하고 이를 통해 기능을 활용할 것이다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;우리가 사용할 JWT(Json Web Token)은 이런 목적으로 만들어진 것은 아니다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;아래 코드를 &lt;a href=&quot;#section-10&quot;&gt;기기 등록 로직&lt;/a&gt;에서 처럼 &lt;code&gt;routes/device.js&lt;/code&gt;의 &lt;code&gt;module.exports&lt;/code&gt; 위쪽에 추가한다.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;/**
 * @api {GET} /device/token/:UUID 토큰 요청
 * @apiName 접속 토큰 요청
 * @apiParam {String{1..60}} UUID 기기의 UUID
 */
router.get(&#39;/token/:UUID&#39;, (req, res, next)=&amp;gt;{
    
    //UUID로 등록된 기기가 있는가?
    models.GameDevice.findOne({where:{UUID:req.params.UUID}})
        .then((findGameDevice)=&amp;gt;{
            if(findGameDevice === null) {
                //err 기기미등록
                throw wendyError(&#39;UnregisteredDevice&#39;);
            }
            //기기에 GameUserID가 null인가?
            if(findGameDevice.GameUserID === null) {
                //err 등록된 기기이며 아이디가 미생성된 경우
                throw wendyError(&#39;CreateID&#39;);
            }
            //주 사용 기기가 아닌가?(다른 기기에서 사용중인가?)
            if(findGameDevice.MainFlag === false) {
                //err 다른 기기에서 Main으로 사용중인 경우.
                throw wendyError(&#39;UsedOnOtherDevice&#39;);
            }
            return Promise.resolve(findGameDevice);
        })
        .then((findGameDevice)=&amp;gt;{
            let tokenObj = {
                GameUserID:findGameDevice.GameUserID, 
                GameDeviceUID:findGameDevice.GameDeviceUID};
            let token = auth.signToken(tokenObj);
            return Promise.resolve({
                result:0,
                token:token
            })
        })
        //결과 전달.
        .then((result)=&amp;gt;{
            res.send(result);
        })
        .catch((err)=&amp;gt;{
            next(err);
        })
});


&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;위 코드는 3가지 예외상황을 확인하고 정상적인 경우에 토큰을 생성하여 전달한다.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;11~14번 줄 : 등록된 기기인지 확인한다.&lt;/li&gt;
  &lt;li&gt;16~19번 줄 : 기기가 등록되었지만 GameUserID를 부여받았는지 확인한다. 닉네임 등을 요구해서 유저로 등록해야하는 것이다.&lt;/li&gt;
  &lt;li&gt;21~24번 줄 : 주 사용기기인지 체크한다. 이는 1명의 사용자가 다수의 기기를 돌릴 경우를 대비한 것으로 지금은 무의미하다.&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;사용자-정보-조회-로직&quot;&gt;사용자 정보 조회 로직&lt;/h3&gt;
&lt;p&gt;사용자 관련 로직도 복잡도가 낮은 정보 조회부터 제작해보자.&lt;/p&gt;

&lt;p&gt;아래 코드를 &lt;code&gt;routes/user.js&lt;/code&gt;의 &lt;code&gt;module.exports&lt;/code&gt; 위쪽에 추가한다.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;/**
 * @api {GET} /user 사용자 정보 조회
 * @apiName 사용자 정보 조회
 * @apiHeader {String} Authorization JWT토큰을 전송
 */
router.get(&#39;/&#39;, auth.isAuthenticated, (req, res, next)=&amp;gt;{
    let nowDate = new Date();

    models.GameUser.update({loginAt:nowDate}, {where:{GameUserID:req.user.GameUserID}})
        .then(()=&amp;gt;{
            return models.GameUser.findOne({where:{GameUserID:req.user.GameUserID}})
        })
        .then((findGameUser)=&amp;gt;{
            let returnObj = {result:0, UserInfo:findGameUser};
            res.send(returnObj);
        })
});


&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
  &lt;li&gt;9번 줄 : 로그인 시간을 최신시각으로 변경한다.&lt;/li&gt;
  &lt;li&gt;11번 줄 : GameUserID를 검색한다.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;이 소스코드가 앞선 코드들과 다른 것은 사실 6번 줄이다.&lt;/p&gt;

&lt;p&gt;자세히 살펴보면 패스와 콜백 메서드 사이에 미들웨어가 끼어있다. 이 미들웨어는 요청 시 Header의&lt;code&gt;Authorization&lt;/code&gt;에 포함되는 JWT가 사용가능한 것인지 확인한다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;앞으로 이런 코드를 자주 보게 될 것이다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;사용자-등록-로직&quot;&gt;사용자 등록 로직&lt;/h3&gt;
&lt;p&gt;예외처리가 이곳저곳에 있어서 복잡해보이지만 로직을 묶어서보면 간단한 편이다.&lt;/p&gt;

&lt;p&gt;아래 코드를 &lt;code&gt;routes/user.js&lt;/code&gt;의 &lt;code&gt;module.exports&lt;/code&gt; 위쪽에 추가한다.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-javascript&quot;&gt;/**
 * @api {POST} /user 사용자 등록
 * @apiName 모바일 기기 등록
 * @apiParam {String{1..60}} NickName 사용자 닉네임
 * @apiParam {String} Locale 로케일
 * @apiParam {String{1..60}} UUID 기기의 UUID
 * @apiParam {Number} OffsetTime timezone을 UTC+x 형태로 등록하기위한 숫자
 */
router.post(&#39;/&#39;, (req, res, next)=&amp;gt;{


    let checkRequestBody = commonFunc.ObjectExistThatKeys(req.body, [&#39;UUID&#39;, &#39;NickName&#39;, &#39;Locale&#39;]);
    if(checkRequestBody === false) {
        throw wendyError(&#39;DontHaveRequiredParams&#39;);
    }
    
    if( (req.body.NickName.length &amp;gt;= 3 &amp;amp;&amp;amp; req.body.NickName.length &amp;lt;= 12)=== false) {
        throw wendyError(&#39;NickNameToLongOrShot&#39;);
    }

    
    //검증
    //UUID로 등록된 기기가 있는가?
    //yes:pass
    //no:error 기기등록 필요
    //기기에 GameUserID가 0인가?
    //yes: 신규 등록 진행
    //no:error 이미 아이디를 생성했음.
    //NickName이 이미 사용중인가?
    //yes:error 다른 닉네임 사용권고
    //no:pass

    let saveGameDeviceUID = 0;
    let saveGameUserID = 0;
    
    function CreateResult() {
        let tokenObj = {GameUserID:saveGameUserID, GameDeviceUID:saveGameDeviceUID};
        let token = auth.signToken(tokenObj);
        return Promise.resolve({
            result:0,
            token:token
        })
    }
    
    //UUID로 등록된 기기가 있는가?
    models.GameDevice.findOne({where:{UUID:req.body.UUID}})
        .then((findGameDevice)=&amp;gt;{
            if(findGameDevice === null) {
                //err 기기미등록
                throw wendyError(&#39;UnregisteredDevice&#39;);
            }
            //기기에 GameUserID가 null인가?
            else if(findGameDevice.GameUserID !== null) {
                saveGameDeviceUID = findGameDevice.GameDeviceUID;
                saveGameUserID = findGameDevice.GameUserID;
                //err 등록된 기기이며 아이디가 이미 있는 상태
                return Promise.reject(&#39;pass&#39;)
            }
            saveGameDeviceUID = findGameDevice.GameDeviceUID;
            return Promise.resolve();
        })
        .catch((err)=&amp;gt;{
            switch(err) {
                case &#39;pass&#39;:
                    return CreateResult()
                        .then((resultObj)=&amp;gt;{
                            return Promise.reject(resultObj);
                        })
                    break;
                default:
                    return Promise.reject(err);
                    break;
            }
        })
        //NickName이 이미 사용중인가?
        .then(()=&amp;gt;{
            return models.GameUser.findOne({where:{NickName:req.body.NickName}})
        })
        .then((findGameUser)=&amp;gt;{
            if(findGameUser !== null) {
                //err 이미 사용중인 NickName
                throw wendyError(&#39;UsedNickName&#39;);
            }
            return Promise.resolve();
        })
        //GameUser 등록
        .then(()=&amp;gt;{
            return models.GameUser.create({
                NickName:req.body.NickName, 
                Locale:req.body.Locale, 
                OffsetTime:req.body.OffsetTime});
        })
        .then((createGameUser)=&amp;gt;{
            saveGameUserID = createGameUser.GameUserID;
            return Promise.resolve();
        })
        //GameDevice 업데이트
        .then(()=&amp;gt;{
            if(saveGameDeviceUID === 0) {
                return Promise.resolve();
            }
            return models.GameDevice.update(
                {GameUserID:saveGameUserID}, 
                {where:{GameDeviceUID:saveGameDeviceUID}});
        })
        //전송 결과 제작
        .then(CreateResult)
        //결과 전달.
        .then((result)=&amp;gt;{
            res.send(result);
        })
        .catch((err)=&amp;gt;{
            if(err &amp;amp;&amp;amp; err instanceof Error) {
                next(err);
            }
            else {
                res.send(err);
            }
        })
});


&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
  &lt;li&gt;12~19번 줄 : 서버 도착한 요청에 body부분에 필요한 정보와 닉네임 길이를 확인한다.&lt;/li&gt;
  &lt;li&gt;46~74번 줄 : UUID를 통해 기기 등록 여부를 확인한다.&lt;/li&gt;
  &lt;li&gt;76~85번 줄 : 닉네임 사용여부를 확인한다.&lt;/li&gt;
  &lt;li&gt;87~111번 줄 : GameUser 정보를 등록하고 GameDevice와 연결한다. 그리고 결과를 전송한다.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;테스트&quot;&gt;테스트&lt;/h2&gt;
&lt;p&gt;작성한 코드가 올바로 작동하는지 확인해보자.&lt;/p&gt;

&lt;p&gt;API를 테스트하려면 &lt;code&gt;cURL&lt;/code&gt;이나 &lt;code&gt;HTTPie&lt;/code&gt;같은 CLI용 클라이언트를 사용해도 되지만 GUI로 가능한 &lt;code&gt;Postman&lt;/code&gt;을 사용하겠다.&lt;/p&gt;

&lt;h3 id=&quot;appjs-수정&quot;&gt;app.js 수정&lt;/h3&gt;
&lt;p&gt;우리가 만드는 게임 서버는 에러가 발생하면 HTML 형식으로 리턴한다.&lt;/p&gt;

&lt;p&gt;왜냐하면 express.js의 기본이 그렇게 설정되어있기때문이다.&lt;/p&gt;

&lt;p&gt;이것을 JSON 형식으로 리턴하도록 수정한다.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;code&gt;app.js&lt;/code&gt;에서 다음 내용을 찾는다.&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt;res.render(&#39;error&#39;, {
&lt;/code&gt;&lt;/pre&gt;

    &lt;p&gt;2 곳 있을 것이다.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;아래처럼 &lt;code&gt;render&lt;/code&gt;를 &lt;code&gt;send&lt;/code&gt;로 변경하고 ‘error’ 부분을 제거한다.&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt;res.send({
&lt;/code&gt;&lt;/pre&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&quot;postman-설치&quot;&gt;Postman 설치&lt;/h3&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;https://www.getpostman.com&quot;&gt;www.getpostman.com&lt;/a&gt;으로 접속해서 클라이언트를 다운받는다.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;설치한다.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&quot;테스트-코드&quot;&gt;테스트 코드&lt;/h3&gt;
&lt;p&gt;Postman을 실행하여 &lt;code&gt;토큰 요청&lt;/code&gt;, &lt;code&gt;기기 등록&lt;/code&gt;, &lt;code&gt;사용자 등록&lt;/code&gt;, &lt;code&gt;사용자 정보 조회&lt;/code&gt; 순으로 실행해보겠다.&lt;/p&gt;

&lt;p&gt;우선 테스트를 위해서 vs code에서 &lt;code&gt;F5&lt;/code&gt;를 누르거나 &lt;code&gt;Debug&lt;/code&gt; 메뉴로 이동해서 &lt;code&gt;Start Debugging&lt;/code&gt;버튼을 클릭하여 게임 서버를 동작하도록 한다.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/rvwendy03_01.png&quot; alt=&quot;debug&quot; /&gt;&lt;/p&gt;

&lt;h4 id=&quot;토큰-요청&quot;&gt;토큰 요청&lt;/h4&gt;
&lt;p&gt;Postman의 &lt;code&gt;Request Editor&lt;/code&gt;를 다음과 같이 입력한다.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://www.getpostman.com/img/v1/docs/thumbs/2.png&quot; alt=&quot;Request Editor&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;패스 : GET&lt;/li&gt;
  &lt;li&gt;URL : localhost:3000/device/token/testdeviceuuid&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;입력이 끝나고 &lt;code&gt;Send&lt;/code&gt;버튼을 누르면 다음과 같은 에러를 리턴할 것이다.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;{
  &quot;result&quot;: 80101,
  &quot;message&quot;: &quot;등록하지 않은 기기&quot;,
  &quot;error&quot;: {
    &quot;name&quot;: &quot;UnregisteredDevice&quot;,
    &quot;code&quot;: 80101
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;정상이다. 기기등록을 해보자.&lt;/p&gt;

&lt;h4 id=&quot;기기-등록&quot;&gt;기기 등록&lt;/h4&gt;

&lt;ul&gt;
  &lt;li&gt;패스 : POST&lt;/li&gt;
  &lt;li&gt;URL : localhost:3000/device&lt;/li&gt;
  &lt;li&gt;body : 아래 내용을 넣는다.&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code&gt;{
    &quot;UUID&quot;:&quot;testdeviceuuid&quot;,
    &quot;DeviceType&quot;:10
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img src=&quot;/images/rvwendy03_02.png&quot; alt=&quot;postmanbody&quot; /&gt;&lt;/p&gt;

&lt;p&gt;결과로 0번 코드를 리턴하면 정상이다.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;{
    &quot;result&quot;: 0
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&quot;사용자-등록&quot;&gt;사용자 등록&lt;/h4&gt;
&lt;p&gt;닉네임을 입력하여 사용자 등록을 진행한다.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;패스 : POST&lt;/li&gt;
  &lt;li&gt;URL : localhost:3000/user&lt;/li&gt;
  &lt;li&gt;body : 아래 내용을 넣는다.&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code&gt;{
    &quot;NickName&quot;:&quot;cat냥이&quot;,
    &quot;Locale&quot;:&quot;ko-kr&quot;,
    &quot;UUID&quot;:&quot;testdeviceuuid&quot;,
    &quot;OffsetTime&quot;:9
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;정상 등록이 되면 아래 같은 결과가 나온다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;단 token은 다를 수 있다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code&gt;{
    &quot;result&quot;: 0,
    &quot;token&quot;: &quot;blah.blah.blah&quot;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&quot;사용자-정보-조회&quot;&gt;사용자 정보 조회&lt;/h4&gt;
&lt;p&gt;위에서 받은 토큰을 활용해서 사용자 정보 조회를 해보자.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;패스 : GET&lt;/li&gt;
  &lt;li&gt;URL : localhost:3000/user&lt;/li&gt;
  &lt;li&gt;Headers : Authorization을 추가하고 토큰 내용을 value 부분에 넣는다.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;성공하면 다음과 같은 정보를 돌려준다.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;{
  &quot;result&quot;: 0,
  &quot;UserInfo&quot;: {
    &quot;GameUserID&quot;: 2,
    &quot;NickName&quot;: &quot;cat냥이&quot;,
    &quot;Locale&quot;: &quot;ko-kr&quot;,
    &quot;OffsetTime&quot;: 9,
    &quot;OffsetTimeUpdateAt&quot;: &quot;2016-12-27T02:57:08.000Z&quot;,
    &quot;createAt&quot;: &quot;2016-12-27T02:57:08.000Z&quot;,
    &quot;loginAt&quot;: &quot;2016-12-27T05:26:25.107Z&quot;
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&quot;맺는말&quot;&gt;맺는말&lt;/h2&gt;
&lt;p&gt;처음 프로그래밍을 진행하는 것이고 익숙치않은 javascript와 Promise 패턴 덕분에 뭐가 뭔지 하나도 모르겠다고 느낄 수 있다.&lt;/p&gt;

&lt;p&gt;처음 Unity로 게임을 시작할 때도 비슷했을 것이라고 본다. 자주 접하다보면 점점 익숙해진다.&lt;/p&gt;

&lt;p&gt;다음 시간에는 통화를 관리해보도록 하겠다.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://totuworld.github.io/2017/01/26/azureandunity-04/&quot;&gt;4강 바로가기&lt;/a&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;참고자료&quot;&gt;참고자료&lt;/h2&gt;
&lt;p&gt;완성된 소스코드는 아래 링크에서 다운로드받으면 된다.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/totuworld/Wendy/archive/0.0.2.zip&quot;&gt;Wendy 3강 완료 버전&lt;/a&gt;&lt;/p&gt;
</description>
            <pubDate>Thu, 12 Jan 2017 09:00:01 +0900</pubDate>
            <link>http://totuworld.github.io/2017/01/12/azureandunity-03/</link>
            <guid isPermaLink="true">http://totuworld.github.io/2017/01/12/azureandunity-03/</guid>
            
            
            <category>nodejs</category>
            
            <category>azure</category>
            
            <category>webapps</category>
            
            <category>unity</category>
            
        </item>
      
    
      
        <item>
            <title>Wendy 프로젝트 진행사항 1</title>
            <description>&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#들어가는-말&quot; id=&quot;markdown-toc-들어가는-말&quot;&gt;들어가는 말&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#프로젝트-진행-사항&quot; id=&quot;markdown-toc-프로젝트-진행-사항&quot;&gt;프로젝트 진행 사항&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#기능-추가-목록&quot; id=&quot;markdown-toc-기능-추가-목록&quot;&gt;기능 추가 목록&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#튜토리얼-제작-사항&quot; id=&quot;markdown-toc-튜토리얼-제작-사항&quot;&gt;튜토리얼 제작 사항&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#완성된-튜토리얼-목록&quot; id=&quot;markdown-toc-완성된-튜토리얼-목록&quot;&gt;완성된 튜토리얼 목록&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#튜토리얼-제작-진행사항&quot; id=&quot;markdown-toc-튜토리얼-제작-진행사항&quot;&gt;튜토리얼 제작 진행사항&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#작명-및-로고&quot; id=&quot;markdown-toc-작명-및-로고&quot;&gt;작명 및 로고&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#맺음말&quot; id=&quot;markdown-toc-맺음말&quot;&gt;맺음말&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;들어가는-말&quot;&gt;들어가는 말&lt;/h2&gt;
&lt;p&gt;이상한모임 연말정산에서 반드시 올해는 프로젝트 진행 사항을 블로그 등으로 공지할 것을 천명한 바 있다.&lt;/p&gt;

&lt;p&gt;12월부터 프로젝트가 작동 중이라서 첫 달의 진행 사항을 남긴다.&lt;/p&gt;

&lt;h2 id=&quot;프로젝트-진행-사항&quot;&gt;프로젝트 진행 사항&lt;/h2&gt;
&lt;p&gt;가장 기본에 해당하는 기기 관리와 사용자 관리가 추가되었다.&lt;/p&gt;

&lt;p&gt;그리고 통화 관리에 기능도 완료되었다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;a href=&quot;https://github.com/totuworld/Wendy&quot;&gt;Wendy 프로젝트 레파지토리&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;기능-추가-목록&quot;&gt;기능 추가 목록&lt;/h3&gt;
&lt;ul&gt;
  &lt;li&gt;기기 관리&lt;/li&gt;
  &lt;li&gt;사용자 관리&lt;/li&gt;
  &lt;li&gt;통화 관리&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;튜토리얼-제작-사항&quot;&gt;튜토리얼 제작 사항&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;이세계에 진입한 서버 개발&lt;/code&gt;이란 이름으로 2개의 강좌가 제작되었다.&lt;/p&gt;

&lt;p&gt;기초에 해당하는 부분이라서 1주마다 총 2개가 공유되었다.&lt;/p&gt;

&lt;p&gt;하지만 소스코드 제작과 글 작성, 동영상 제작을 생각하면 격주 목요일 1개 강좌 공유를 목표로 한다.&lt;/p&gt;

&lt;h3 id=&quot;완성된-튜토리얼-목록&quot;&gt;완성된 튜토리얼 목록&lt;/h3&gt;
&lt;ul&gt;
  &lt;li&gt;1강 - &lt;a href=&quot;http://totuworld.github.io/2016/12/21/azureandunity-01/&quot;&gt;Hello, world!&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;2강 - &lt;a href=&quot;http://totuworld.github.io/2016/12/29/azureandunity-02/&quot;&gt;SQL데이터베이스스와 환경설정&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;튜토리얼-제작-진행사항&quot;&gt;튜토리얼 제작 진행사항&lt;/h3&gt;
&lt;ul&gt;
  &lt;li&gt;3강 : 글 작성 완료, 동영상 녹화 예정&lt;/li&gt;
  &lt;li&gt;4강 : 글 작성 완료&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;작명-및-로고&quot;&gt;작명 및 로고&lt;/h2&gt;
&lt;p&gt;MagmaKick을 진행할 때 설치용 버전으로 MagMaKick CE를 공개할 예정이었다.&lt;/p&gt;

&lt;p&gt;하지만 내 뒷심과 능력 부족으로 MagmaKick이 대차게 실패했다.&lt;/p&gt;

&lt;p&gt;그러다가 다시 시작해보려고 했다.&lt;/p&gt;

&lt;p&gt;그런데 MagmaKick CE로 이름을 쓰기 싫었다.&lt;/p&gt;

&lt;p&gt;덕심을 발휘해 볼겸 매력덩어리 이쁜애인 &lt;a href=&quot;https://www.google.co.kr/webhp?sourceid=chrome-instant&amp;amp;ion=1&amp;amp;espv=2&amp;amp;ie=UTF-8#q=%EB%A0%88%EB%93%9C%EB%B2%A8%EB%B2%B3%20%EC%9B%AC%EB%94%94&quot;&gt;레드벨벳 웬디&lt;/a&gt;의 이름을 따서 프로젝트 명을 &lt;code&gt;Wendy&lt;/code&gt;로 지었다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;놀랍게도 이름을 변경했더니 작업할 맛이 난다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;로고는 웬디 얼굴을 대문짝만하게 걸고 싶었다. 소속사와 초상권을 생각해서 그녀의 별칭 중 하나인 &lt;code&gt;완라프&lt;/code&gt;에서 착안, 눈사람 로고로 정했다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;와 말하고 나니까 되게 좋다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;img src=&quot;/images/Wanlaf.png&quot; alt=&quot;WendyLogo&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;맺음말&quot;&gt;맺음말&lt;/h2&gt;

&lt;p&gt;글만 쓰는게 아니라 동영상 녹화를 하고 후시 녹음으로 마무리하려니까 손이 좀 많이 가는게 아니다.&lt;/p&gt;

&lt;p&gt;그리고 내 맥은 하드디스크가 256GB인데 동영상 작업으로 30GB정도밖에 안남았다.&lt;/p&gt;

&lt;p&gt;무엇보다 편집할 때 스크래치 디스크가 적어서 매우 힘들어한다.&lt;/p&gt;

&lt;p&gt;후시 녹음을 진행하다보니 되도록 새벽 시간에 진행하는데 이렇다보니 목소리가 지 멋대로이고 잠이 덜깨어있다.&lt;/p&gt;

&lt;p&gt;스스로 흑역사를 박제하는 기분이 든다.&lt;/p&gt;

&lt;p&gt;그런데!!! 페이스북에서 &lt;code&gt;좋아요&lt;/code&gt; 하나 볼때마다 힘이나서 다시하게 된다.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;칭찬이 이렇게 무섭다.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;여러분들의 힘으로(?) 2월말까지 계획했던 6개 항목에 대한 기능과 강좌가 모두 발행되길 바란다.&lt;/p&gt;
</description>
            <pubDate>Wed, 04 Jan 2017 09:00:01 +0900</pubDate>
            <link>http://totuworld.github.io/2017/01/04/wendynotification/</link>
            <guid isPermaLink="true">http://totuworld.github.io/2017/01/04/wendynotification/</guid>
            
            
            <category>wendy</category>
            
        </item>
      
    
  </channel>
</rss>
